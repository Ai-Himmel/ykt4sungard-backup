*** SH SERIES ASSEMBLER Ver. 2.0 ***      01/28/98 12:58:15                                                              PAGE     1
PROGRAM NAME =

    1                               1     ;/*--------------------------------------------------------------------------*/
    2                               2     ;/*  プロジェクト : POPLAR/ANZU_L                                            */
    3                               3     ;/*  ファイル名   : det_evt.src                                              */
    4                               4     ;/*  作成者       : 野瀬                                                     */
    5                               5     ;/*  日  付       : 1996/10/14                                               */
    6                               6     ;/*  概  要       : イベント管理                                             */
    7                               7     ;/*  修正履歴     :                                                          */
    8                               8     ;/*--------------------------------------------------------------------------*/
    9                               9     
   10                              10             .INCLUDE        "\src\atlanta\sh7043\define\def_mon.hdr"
   11                               1 I1  ;/*--------------------------------------------------------------------------*/
   12                               2 I1  ;/*  プロジェクト : RISC                                                     */
   13                               3 I1  ;/*  ファイル名   : def_mon.ih                                               */
   14                               4 I1  ;/*  作成者       : 野瀬                                                     */
   15                               5 I1  ;/*  日  付       : 95.11.01                                                 */
   16                               6 I1  ;/*  概  要       : モニタdefine定義                                         */
   17                               7 I1  ;/*  修正履歴     :                                                          */
   18                               8 I1  ;/*--------------------------------------------------------------------------*/
   19                               9 I1  ;-----------------------------------------------------------------------------
   20                              10 I1  ; ＣＣＲ マスクビット
   21                              11 I1  ;-----------------------------------------------------------------------------
   22          000000F0            12 I1  I_BIT_ON                .EQU    H'000000F0      ; 割込禁止 RISC
   23          0000030F            13 I1  I_BIT_OFF               .EQU    H'0000030F      ; 割込許可 RISC
   24                              14 I1  
   25                              15 I1  ;-----------------------------------------------------------------------------
   26                              16 I1  ; ワンショットタイマ値ＭＡＸ
   27                              17 I1  ;-----------------------------------------------------------------------------
   28          0000001A            18 I1  ONESHOT_VALUE_MAX               .EQU    26
   29                              19 I1  
   30                              20 I1  ;-----------------------------------------------------------------------------
   31                              21 I1  ; タスク イニシャルプログラムNo.
   32                              22 I1  ;-----------------------------------------------------------------------------
   33          00000000            23 I1  INIT_TID                .EQU    0
   34          00000000            24 I1  TSK_INITIAL             .EQU    0
   35          FFFFFC00            25 I1  TSK_INI_ADDR    .EQU    H'FFFFFC00              ; 初期化用スタック H'FFFFFC00-H'FFFFF000 3
   36                              26 I1                                                                                  ; def_mon.
   37                              27 I1  
   38                              28 I1  ;-----------------------------------------------------------------------------
   39                              29 I1  ; モニタ システム
   40                              30 I1  ;-----------------------------------------------------------------------------
   41                              31 I1  
   42          00000000            32 I1  FLAG_INIT_DATA                  .EQU    H'00000000      ; RISC
   43                              33 I1  
   44                              34 I1  ;TASK_STACK_START               .EQU    H'00809800
   45                              35 I1  
   46                              36 I1  ;LARGE_STACK_MAX                        .EQU    16                      ; RISC
   47                              37 I1  ;SMALL_STACK_MAX                        .EQU    32                      ; RISC
   48                              38 I1  ;TOTAL_STACK_MAX                        .EQU    (SMALL_STACK_MAX+LARGE_STACK_MAX)
   49                              39 I1  ;LARGE_STACK                            .EQU    512
   50                              40 I1  ;SMALL_STACK                            .EQU    256
   51                              41 I1  ;STACK_PUSH_SIZE                        .EQU    88                      ;       スタック退
   52                              42 I1  ;TOP_LARGE_ADDR                         .EQU    (TASK_STACK_START-(SMALL_STACK*SMALL_STACK
   53                              43 I1  ;TOP_SMALL_ADDR                         .EQU    (TASK_STACK_START-STACK_PUSH_SIZE)
   54          00000050            44 I1  STACK_PC_POSITION               .EQU    80
   55                              45 I1  ;STK_RTNVL_PT                   .EQU    76
   56                              46 I1  
   57                              47 I1  ;-----------------------------------------------------------------------------
*** SH SERIES ASSEMBLER Ver. 2.0 ***      01/28/98 12:58:15                                                              PAGE     2
PROGRAM NAME =

   58                              48 I1  ; TIB
   59                              49 I1  ;
   60                              50 I1  ; struct tib_table_data {
   61                              51 I1  ;       unsigned char *start_addr;
   62                              52 I1  ;       unsigned char *end_addr;
   63                              53 I1  ;       unsigned char stack_size;
   64                              54 I1  ;       unsigned char priority;
   65                              55 I1  ;       unsigned short reserve;
   66                              56 I1  ; };
   67                              57 I1  ;
   68                              58 I1  ;    ｮ｢｢｢｢｢｢｢｢｢｢｢ｲ
   69                              59 I1  ;  0 ､                      ､
   70                              60 I1  ;    ､                      ､
   71                              61 I1  ;  1 ､   タスクプログラム   ､
   72                              62 I1  ;    ､   スタートアドレス   ､
   73                              63 I1  ;  2 ､                      ､
   74                              64 I1  ;    ､                      ､
   75                              65 I1  ;  3 ､                      ､
   76                              66 I1  ;    ｾ｢｢｢｢｢｢｢｢｢｢｢ﾆ
   77                              67 I1  ;  4 ､                      ､
   78                              68 I1  ;    ､                      ､
   79                              69 I1  ;  5 ､   異常処理ルーチン   ､
   80                              70 I1  ;    ､   スタートアドレス   ､
   81                              71 I1  ;  6 ､                      ､
   82                              72 I1  ;    ､                      ､
   83                              73 I1  ;  7 ､                      ､
   84                              74 I1  ;    ｾ｢｢｢｢｢｢｢｢｢｢｢ﾆ
   85                              75 I1  ;  8 ､    スタックサイズ    ､  0:Large Stack  1:Small Stack
   86                              76 I1  ;    ｾ｢｢｢｢｢｢｢｢｢｢｢ﾆ
   87                              77 I1  ;  9 ､       優先順位       ､
   88                              78 I1  ;    ｾ｢｢｢｢｢｢｢｢｢｢｢ﾆ
   89                              79 I1  ; 10 ､       リザーブ       ､
   90                              80 I1  ;    ､                      ､
   91                              81 I1  ; 11 ､                      ､
   92                              82 I1  ;    ｶ｢｢｢｢｢｢｢｢｢｢｢ｺ
   93                              83 I1  ;
   94                              84 I1  ;      優先順位(0～255)
   95                              85 I1  ;      ※ 0を最も高い優先順位とします
   96                              86 I1  ;-----------------------------------------------------------------------------
   97                              87 I1  
   98          0000000C            88 I1  TIB_TBL_SIZE    .EQU    12
   99                              89 I1  
  100                              90 I1  ;-- オフセット --
  101          00000000            91 I1  TIB_START_ADR           .EQU    0
  102          00000004            92 I1  TIB_END_ADR                     .EQU    4
  103          00000008            93 I1  TIB_STACK_SIZE          .EQU    8
  104          00000009            94 I1  TIB_PRIORITY            .EQU    9
  105                              95 I1  
  106                              96 I1  ;-----------------------------------------------------------------------------
  107                              97 I1  ; TCB
  108                              98 I1  ;
  109                              99 I1  ; struct tcb_table_data {
  110                             100 I1  ;       unsigned char tsk_stat;
  111                             101 I1  ;       unsigned char prog_no;
  112                             102 I1  ;       unsigned char priority;
  113                             103 I1  ;       unsigned char tsk_link;
  114                             104 I1  ;       unsigned char run_link;
*** SH SERIES ASSEMBLER Ver. 2.0 ***      01/28/98 12:58:15                                                              PAGE     3
PROGRAM NAME =

  115                             105 I1  ;       unsigned char tsk_stat_tpo;
  116                             106 I1  ;       unsigned short reserve;         RISC追加 by T.Nose
  117                             107 I1  ;       unsigned long wait_param;
  118                             108 I1  ;       unsigned char *stack_addr;
  119                             109 I1  ; };
  120                             110 I1  ;
  121                             111 I1  ;    ｮ｢｢ﾎ｢｢｢｢｢｢｢｢ｲ
  122                             112 I1  ;  0 ､STS ､ WAIT時の原因   ､   STS           WAIT時の原因
  123                             113 I1  ;    ｾ｢｢ﾖ｢｢｢｢｢｢｢｢ﾆ   11 : 未使用    1 : 送信待ち
  124                             114 I1  ;  1 ､     プログラムNo.    ､   00 : WAIT      2 : 受信待ち
  125                             115 I1  ;    ｾ｢｢｢｢｢｢｢｢｢｢｢ﾆ   01 : READY     3 : セマフォ待ち
  126                             116 I1  ;  2 ､       優先順位       ､                  4 : タイマ待ち
  127                             117 I1  ;    ｾ｢｢｢｢｢｢｢｢｢｢｢ﾆ                  5 : イベントフラグ待ち
  128                             118 I1  ;  3 ､     タスクリンク     ､                  6 : ワンショットタイマ待ち
  129                             119 I1  ;    ｾ｢｢｢｢｢｢｢｢｢｢｢ﾆ
  130                             120 I1  ;  4 ､    強制ランタスク    ､
  131                             121 I1  ;    ｾ｢｢｢｢｢｢｢｢｢｢｢ﾆ
  132                             122 I1  ;  5 ､待ちタスクパラメータ a､
  133                             123 I1  ;    ｾ｢｢｢｢｢｢｢｢｢｢｢ﾆ
  134                             124 I1  ;  6 ､       リザーブ       ､  アドレス調整用 RISC追加 by T.Nose
  135                             125 I1  ;    ､                      ､
  136                             126 I1  ;  7 ､                      ､
  137                             127 I1  ;    ｾ｢｢｢｢｢｢｢｢｢｢｢ﾆ
  138                             128 I1  ;  8 ､                     b､  1.送信待ち
  139                             129 I1  ;    ､                      ､     a     : MBX No
  140                             130 I1  ;  9 ､                     c､     b～e  : 送信データアドレス
  141                             131 I1  ;    ､                      ､  2.受信待ち
  142                             132 I1  ; 10 ､                     d､     a     : MBX No
  143                             133 I1  ;    ､                      ､     b～e  : 受信データアドレス
  144                             134 I1  ; 11 ､                     e､  3.セマフォ待ち
  145                             135 I1  ;    ｾ｢｢｢｢｢｢｢｢｢｢｢ﾆ     a,d,e : 未使用
  146                             136 I1  ; 12 ､                      ､     b,c   : セマフォ No
  147                             137 I1  ;    ､                      ､  4.タイマ待ち
  148                             138 I1  ; 13 ､                      ､     a,d,e : 未使用
  149                             139 I1  ;    ､   スタックアドレス   ､     b,c   : タイマ値
  150                             140 I1  ; 14 ､                      ､  5.イベントフラグ待ち
  151                             141 I1  ;    ､                      ､     a     : EVENT No
  152                             142 I1  ; 15 ､                      ､     b～e  : 未使用
  153                             143 I1  ;    ｶ｢｢｢｢｢｢｢｢｢｢｢ｺ  6.ワンショットタイマ待ち
  154                             144 I1  ;                                   a～e  : 未使用
  155                             145 I1  
  156                             146 I1  
  157                             147 I1  
  158                             148 I1  
  159                             149 I1  ;      スタックアドレス  初期値 = (実際のアドレス - 32byte)
  160                             150 I1  ;
  161                             151 I1  ;-----------------------------------------------------------------------------
  162                             152 I1  
  163                             153 I1  ;-- オフセット --
  164          00000000           154 I1  TCB_STAT                        .EQU    0
  165          00000001           155 I1  TCB_PROGNO                      .EQU    1
  166          00000002           156 I1  TCB_PRIORITY            .EQU    2
  167          00000003           157 I1  TCB_LINK                        .EQU    3
  168          00000004           158 I1  TCB_RUN_LINK            .EQU    4
  169          00000005           159 I1  TCB_WAIT_PARAM          .EQU    5
  170          00000006           160 I1  TCB_RESERVE                     .EQU    6
  171          00000008           161 I1  TCB_WAIT_PARA1          .EQU    8
*** SH SERIES ASSEMBLER Ver. 2.0 ***      01/28/98 12:58:15                                                              PAGE     4
PROGRAM NAME =

  172          0000000A           162 I1  TCB_WAIT_PARA2          .EQU    10
  173          0000000C           163 I1  TCB_STACK_ADR           .EQU    12
  174                             164 I1  
  175                             165 I1  ;READY_TSK_MAX  .EQU    SMALL_STACK_MAX+LARGE_STACK_MAX
  176          00000010           166 I1  TCB_TBL_SIZE    .EQU    16
  177                             167 I1  
  178          000000FF           168 I1  NIL                             .EQU    H'ff
  179          0000FFFF           169 I1  WORDNIL                 .EQU    H'ffff
  180          FFFFFFFF           170 I1  LONGNIL                 .EQU    H'ffffffff
  181                             171 I1  
  182          00000000           172 I1  WAIT                    .EQU    H'00    ;RISC
  183          00000040           173 I1  READY                   .EQU    H'40    ;RISC
  184          000000C0           174 I1  NOT_USED                .EQU    H'C0    ;RISC
  185                             175 I1  
  186          00000001           176 I1  SND_WAIT                .EQU    H'01
  187          00000002           177 I1  RCV_WAIT                .EQU    H'02
  188          00000003           178 I1  WAIT_SEM                .EQU    H'03
  189          00000004           179 I1  WAIT_TIMER              .EQU    H'04
  190          00000005           180 I1  WAIT_EVENT              .EQU    H'05
  191          00000006           181 I1  WAIT_ONESHOT    .EQU    H'06
  192                             182 I1  
  193          000000FF           183 I1  ERROR                   .EQU    H'ff
  194                             184 I1  
  195                             185 I1  ;-----------------------------------------------------------------------------
  196                             186 I1  ; SCB
  197                             187 I1  ;
  198                             188 I1  ; struct scb_table_data {
  199                             189 I1  ;       unsigned char stat;
  200                             190 I1  ;       unsigned char tid;
  201                             191 I1  ; };
  202                             192 I1  ;
  203                             193 I1  ;    ｮ｢｢ﾎ｢｢｢｢｢｢｢｢ｲ
  204                             194 I1  ;  0 ､STS ､待ちタスクのTID ､
  205                             195 I1  ;    ｾ｢｢ﾖ｢｢｢｢｢｢｢｢ﾆ
  206                             196 I1  ;  1 ､   セマフォ獲得TID    ､
  207                             197 I1  ;    ｶ｢｢｢｢｢｢｢｢｢｢｢ｺ
  208                             198 I1  ;
  209                             199 I1  ;     STS
  210                             200 I1  ;          11 : 未使用
  211                             201 I1  ;          00 : セマフォ値=0
  212                             202 I1  ;          01 : セマフォ値=1
  213                             203 I1  ;
  214                             204 I1  ;     待ちタスクのTID
  215                             205 I1  ;          111111 : 待ちタスクなし
  216                             206 I1  ;
  217                             207 I1  ;-----------------------------------------------------------------------------
  218                             208 I1  
  219                             209 I1  ;SEMNO_MAX              .EQU    32
  220          00000002           210 I1  SCB_TBL_SIZE    .EQU    2
  221          0000007F           211 I1  SCB_INIT                .EQU    H'7F
  222                             212 I1  ;SCB_FREE               .EQU    H'3F
  223                             213 I1  
  224                             214 I1  ;MAX_SEMNO              .EQU    15      ; \src\atlanta\sh7043\define\def_semn.hに
  225                             215 I1                                                          ; 同一の定義有り。同値に保って下さ
  226                             216 I1  
  227                             217 I1  ;-- オフセット --
  228          00000000           218 I1  SCB_STAT                .EQU    0
*** SH SERIES ASSEMBLER Ver. 2.0 ***      01/28/98 12:58:15                                                              PAGE     5
PROGRAM NAME =

  229          00000001           219 I1  SCB_TID                 .EQU    1
  230                             220 I1  
  231                             221 I1  ;-----------------------------------------------------------------------------
  232                             222 I1  ; MCB
  233                             223 I1  ;
  234                             224 I1  ;    ｮ｢｢ﾎ｢｢｢｢｢｢ｲ
  235                             225 I1  ;    ､STS ､    TID     ､
  236                             226 I1  ;    ｶ｢｢ﾖ｢｢｢｢｢｢ｺ
  237                             227 I1  ;
  238                             228 I1  ;     STS                      TID
  239                             229 I1  ;     11 : 未使用              111111
  240                             230 I1  ;     10 : 待ちタスクなし      111111
  241                             231 I1  ;     00 : 送信待ちタスクあり  xxxxxx  待ちタスクの中で最も優先順位の高いTID
  242                             232 I1  ;     01 : 受信待ちタスクあり  xxxxxx  待ちタスクの中で最も優先順位の高いTID
  243                             233 I1  ;
  244                             234 I1  ;-----------------------------------------------------------------------------
  245                             235 I1  
  246                             236 I1  ;MBXNO_MAX              .EQU    256
  247                             237 I1  
  248                             238 I1  ;Task MAX Change T.Nose 1996/10/31
  249          0000007F           239 I1  NO_WAIMBX               .EQU    H'7F    ;<- H'BF
  250                             240 I1  ;SND_MBX                        .EQU    H'00
  251                             241 I1  ;RCV_MBX                        .EQU    H'40
  252                             242 I1  
  253                             243 I1  ;MAX_MBXNO              .EQU    70      ; \src\atlanta\sh7043\define\def_mbxn.h に
  254                             244 I1                                                          ; 同一の定義有り。同値に保って下さ
  255                             245 I1  
  256                             246 I1  ;-----------------------------------------------------------------------------
  257                             247 I1  ; ECB
  258                             248 I1  ;
  259                             249 I1  ;    ｮ｢｢｢｢｢｢｢｢｢ｲ
  260                             250 I1  ;    ､       TID        ､
  261                             251 I1  ;    ｶ｢｢｢｢｢｢｢｢｢ｺ
  262                             252 I1  ;
  263                             253 I1  ;     TID
  264                             254 I1  ;     11111111 : 待ちタスクなし
  265                             255 I1  ;     xxxxxxxx : 待ちタスクのTID
  266                             256 I1  ;
  267                             257 I1  ;-----------------------------------------------------------------------------
  268                             258 I1  
  269                             259 I1  ;;EVENT_MAX             .EQU    74
  270                             260 I1  ;EVENT_MAX              .EQU    94     ; Changed with def_evtn.h for R288F event by H.Kubo
  271                             261 I1  
  272                             262 I1  ;-----------------------------------------------------------------------------
  273                             263 I1  ; Ｃソースモニター用
  274                             264 I1  ;-----------------------------------------------------------------------------
  275          00000001           265 I1  MON_SUCCESS             .EQU    1       ;モニター本体処理の戻値（結果）
  276          00000000           266 I1  MON_FAILURE             .EQU    0
  277                             267 I1  
  278                              11             .INCLUDE        "\src\atlanta\sh7043\define\mon_mac.hdr"
  279                               1 I1  ;/*--------------------------------------------------------------------------*/
  280                               2 I1  ;/*  プロジェクト : POPLAR/ANZU_L                                            */
  281                               3 I1  ;/*  ファイル名   : mon_mac.hdr                                              */
  282                               4 I1  ;/*  作成者       : 野瀬                                                     */
  283                               5 I1  ;/*  日  付       : 1996/10/14                                               */
  284                               6 I1  ;/*  概  要       : モニタマクロ定義                                         */
  285                               7 I1  ;/*  修正履歴     :                                                          */
*** SH SERIES ASSEMBLER Ver. 2.0 ***      01/28/98 12:58:15                                                              PAGE     6
PROGRAM NAME =

  286                               8 I1  ;/*--------------------------------------------------------------------------*/
  287                               9 I1  
  288                              10 I1          .IMPORT         _MON_StackCheckTable
  289                              11 I1  
  290                              12 I1  ;-----------------------------------------------------------------------------
  291                              13 I1  ;  アセンブラ　マクロ定義
  292                              14 I1  ;-----------------------------------------------------------------------------
  293                              15 I1  ;
  294                              16 I1  ;/*****************************************************************************
  295                              17 I1  ;       module          :[ｺﾝﾃｷｽﾄを保存する（割込み禁止操作付き）]
  296                              18 I1  ;       function        :[
  297                              19 I1  ;               1.      割込禁止にする
  298                              20 I1  ;               2.      汎用ﾚｼﾞｽﾀ(R0ｰR14)､ｺﾝﾄﾛｰﾙﾚｼﾞｽﾀ(SR､GBR､VBR)､ｼｽﾃﾑﾚｼﾞｽﾀ(MACH､MACL､PR)
  299                              21 I1  ;                       ｽﾀｯｸへｾｰﾌﾞする
  300                              22 I1  ;       ]
  301                              23 I1  ;       return          :[なし]
  302                              24 I1  ;       common          :[]
  303                              25 I1  ;       comment         :[]
  304                              26 I1  ;       machine         :[SH7043]
  305                              27 I1  ;       language        :[ASMSH]
  306                              28 I1  ;       keyword         :[MON]
  307                              29 I1  ;       date            :[1995/10/25]
  308                              30 I1  ;       author          :[野瀬敏弘]
  309                              31 I1  ;*****************************************************************************/
  310                              32 I1  
  311                              33 I1          .MACRO  STCTX_REG
  312                              34 I1  
  313                              35 I1          MOV.L           R0,@-R15                                                ;PUSH.L R0
  314                              36 I1          MOV.L           R1,@-R15                                                ;PUSH.L R1
  315                              37 I1          STC                     SR,R0
  316                              38 I1          MOV.L           STCTX_REG_TBL\@,R1
  317                              39 I1          OR                      R1,R0
  318                              40 I1          LDC                     R0,SR                                                   ;
  319                              41 I1          MOV.L           R2,@-R15                                                ;PUSH.L R2
  320                              42 I1          MOV.L           R3,@-R15                                                ;PUSH.L R3
  321                              43 I1          MOV.L           R4,@-R15                                                ;PUSH.L R4
  322                              44 I1          MOV.L           R5,@-R15                                                ;PUSH.L R5
  323                              45 I1          MOV.L           R6,@-R15                                                ;PUSH.L R6
  324                              46 I1          MOV.L           R7,@-R15                                                ;PUSH.L R7
  325                              47 I1          MOV.L           R8,@-R15                                                ;PUSH.L R8
  326                              48 I1          MOV.L           R9,@-R15                                                ;PUSH.L R9
  327                              49 I1          MOV.L           R10,@-R15                                               ;PUSH.L R1
  328                              50 I1          MOV.L           R11,@-R15                                               ;PUSH.L R1
  329                              51 I1          MOV.L           R12,@-R15                                               ;PUSH.L R1
  330                              52 I1          MOV.L           R13,@-R15                                               ;PUSH.L R1
  331                              53 I1          MOV.L           R14,@-R15                                               ;PUSH.L R1
  332                              54 I1          STC.L           GBR,@-R15                                               ;PUSH.L GB
  333                              55 I1          STC.L           VBR,@-R15                                               ;PUSH.L VB
  334                              56 I1          STS.L           MACH,@-R15                                              ;PUSH.L MA
  335                              57 I1          STS.L           MACL,@-R15                                              ;PUSH.L MA
  336                              58 I1          STS.L           PR,@-R15                                                ;PUSH.L PR
  337                              59 I1  
  338                              60 I1          BRA                     stctx_reg_end\@
  339                              61 I1          NOP
  340                              62 I1  
  341                              63 I1          .ALIGN 4
  342                              64 I1  STCTX_REG_TBL\@:
*** SH SERIES ASSEMBLER Ver. 2.0 ***      01/28/98 12:58:15                                                              PAGE     7
PROGRAM NAME =

  343                              65 I1          .DATA.L         I_BIT_ON
  344                              66 I1  
  345                              67 I1  stctx_reg_end\@:
  346                              68 I1  
  347                              69 I1          .ENDM
  348                              70 I1  
  349                              71 I1  ;/*****************************************************************************
  350                              72 I1  ;       module          :[ｺﾝﾃｷｽﾄを保存する（割込み禁止操作なし）]
  351                              73 I1  ;       function        :[
  352                              74 I1  ;               1.      汎用ﾚｼﾞｽﾀ(R0ｰR14)､ｺﾝﾄﾛｰﾙﾚｼﾞｽﾀ(SR､GBR､VBR)､ｼｽﾃﾑﾚｼﾞｽﾀ(MACH､MACL､PR)
  353                              75 I1  ;                       ｽﾀｯｸへｾｰﾌﾞする
  354                              76 I1  ;       ]
  355                              77 I1  ;       return          :[なし]
  356                              78 I1  ;       common          :[]
  357                              79 I1  ;       comment         :[]
  358                              80 I1  ;       machine         :[SH7043]
  359                              81 I1  ;       language        :[ASMSH]
  360                              82 I1  ;       keyword         :[MON]
  361                              83 I1  ;       date            :[1996/11/12]
  362                              84 I1  ;       author          :[野瀬敏弘]
  363                              85 I1  ;*****************************************************************************/
  364                              86 I1  
  365                              87 I1          .MACRO  STCTX_REG_INT
  366                              88 I1  
  367                              89 I1          MOV.L           R0,@-R15                                                ;PUSH.L R0
  368                              90 I1          MOV.L           R1,@-R15                                                ;PUSH.L R1
  369                              91 I1          MOV.L           R2,@-R15                                                ;PUSH.L R2
  370                              92 I1          MOV.L           R3,@-R15                                                ;PUSH.L R3
  371                              93 I1          MOV.L           R4,@-R15                                                ;PUSH.L R4
  372                              94 I1          MOV.L           R5,@-R15                                                ;PUSH.L R5
  373                              95 I1          MOV.L           R6,@-R15                                                ;PUSH.L R6
  374                              96 I1          MOV.L           R7,@-R15                                                ;PUSH.L R7
  375                              97 I1          MOV.L           R8,@-R15                                                ;PUSH.L R8
  376                              98 I1          MOV.L           R9,@-R15                                                ;PUSH.L R9
  377                              99 I1          MOV.L           R10,@-R15                                               ;PUSH.L R1
  378                             100 I1          MOV.L           R11,@-R15                                               ;PUSH.L R1
  379                             101 I1          MOV.L           R12,@-R15                                               ;PUSH.L R1
  380                             102 I1          MOV.L           R13,@-R15                                               ;PUSH.L R1
  381                             103 I1          MOV.L           R14,@-R15                                               ;PUSH.L R1
  382                             104 I1          STC.L           GBR,@-R15                                               ;PUSH.L GB
  383                             105 I1          STC.L           VBR,@-R15                                               ;PUSH.L VB
  384                             106 I1          STS.L           MACH,@-R15                                              ;PUSH.L MA
  385                             107 I1          STS.L           MACL,@-R15                                              ;PUSH.L MA
  386                             108 I1          STS.L           PR,@-R15                                                ;PUSH.L PR
  387                             109 I1  
  388                             110 I1          .ENDM
  389                             111 I1  
  390                             112 I1  ;/*****************************************************************************
  391                             113 I1  ;       module          :[スタックチェック]
  392                             114 I1  ;       function        :[
  393                             115 I1  ;       ]
  394                             116 I1  ;       return          :[なし]
  395                             117 I1  ;       common          :[]
  396                             118 I1  ;       comment         :[
  397                             119 I1  ;
  398                             120 I1  ;               内部使用レジスタ
  399                             121 I1  ;                       R0 R12 R13 R14
*** SH SERIES ASSEMBLER Ver. 2.0 ***      01/28/98 12:58:15                                                              PAGE     8
PROGRAM NAME =

  400                             122 I1  ;               エラー処理時のみ
  401                             123 I1  ;                       R1 R2
  402                             124 I1  ;
  403                             125 I1  ;                       UDWORD MON_StackCheckTable 4ﾊﾞｲﾄｻｲｽﾞ
  404                             126 I1  ;
  405                             127 I1  ;       ]
  406                             128 I1  ;       machine         :[SH7043]
  407                             129 I1  ;       language        :[ASMSH]
  408                             130 I1  ;       keyword         :[MON]
  409                             131 I1  ;       date            :[1995/10/26]
  410                             132 I1  ;       author          :[野瀬敏弘]
  411                             133 I1  ;*****************************************************************************/
  412                             134 I1  
  413                             135 I1          .MACRO  STACK_CHECK     ERRJUMP
  414                             136 I1  
  415                             137 I1          MOV.L           real_run_tid_STKCHK\@,R12
  416                             138 I1          MOV.B           @R12,R13
  417                             139 I1          EXTU.B          R13,R13                                                 ; R13 = re
  418                             140 I1          SHLL2           R13
  419                             141 I1          MOV.L           MON_StackCheckTable_STKCHK\@,R0
  420                             142 I1          MOV.L           @(R0,R13),R14                                   ; R14 = MON_StackC
  421                             143 I1          CMP/HS          R14,R15
  422                             144 I1          BT                      stack_chk_error\@                               ; SP >= R1
  423                             145 I1          ADD                     #4,R13
  424                             146 I1          MOV.L           @(R0,R13),R14                                   ; R14 = MON_StackC
  425                             147 I1          CMP/HS          R14,R15
  426                             148 I1          BT                      stack_chk_end\@                                 ; SP >= R1
  427                             149 I1  
  428                             150 I1  stack_chk_error\@:
  429                             151 I1          MOV.L           stk_chk_err_STKCHK\@,R1
  430                             152 I1          MOV.L           stk_chk_err_STKCHK\@+4,R2
  431                             153 I1          JMP                     @R2
  432                             154 I1          NOP
  433                             155 I1  
  434                             156 I1          .ALIGN 4
  435                             157 I1  real_run_tid_STKCHK\@:
  436                             158 I1          .DATA.L         _real_run_tid
  437                             159 I1  MON_StackCheckTable_STKCHK\@:
  438                             160 I1          .DATA.L         _MON_StackCheckTable
  439                             161 I1  stk_chk_err_STKCHK\@:
  440                             162 I1          .DATA.L         H'FFFFFFFF
  441                             163 I1          .DATA.L         \ERRJUMP
  442                             164 I1  
  443                             165 I1  stack_chk_end\@
  444                             166 I1  
  445                             167 I1          .ENDM
  446                             168 I1  
  447                             169 I1  
  448                             170 I1  ;/*****************************************************************************
  449                             171 I1  ;       module          :[レジスタの復帰]
  450                             172 I1  ;       function        :[
  451                             173 I1  ;       ]
  452                             174 I1  ;       return          :[なし]
  453                             175 I1  ;       common          :[]
  454                             176 I1  ;       comment         :[
  455                             177 I1  ;       ]
  456                             178 I1  ;       machine         :[SH7043]
*** SH SERIES ASSEMBLER Ver. 2.0 ***      01/28/98 12:58:15                                                              PAGE     9
PROGRAM NAME =

  457                             179 I1  ;       language        :[ASMSH]
  458                             180 I1  ;       keyword         :[MON]
  459                             181 I1  ;       date            :[1995/11/15]
  460                             182 I1  ;       author          :[野瀬敏弘]
  461                             183 I1  ;*****************************************************************************/
  462                             184 I1  
  463                             185 I1          .MACRO  RSTR_REG
  464                             186 I1  
  465                             187 I1          LDS.L   @R15+,PR                        ;POP.L  PR
  466                             188 I1          LDS.L   @R15+,MACL                      ;POP.L  MACL
  467                             189 I1          LDS.L   @R15+,MACH                      ;POP.L  MACH
  468                             190 I1          LDC.L   @R15+,VBR                       ;POP.L  VBR
  469                             191 I1          LDC.L   @R15+,GBR                       ;POP.L  GBR
  470                             192 I1          MOV.L   @R15+,R14                       ;POP.L  R14
  471                             193 I1          MOV.L   @R15+,R13                       ;POP.L  R13
  472                             194 I1          MOV.L   @R15+,R12                       ;POP.L  R12
  473                             195 I1          MOV.L   @R15+,R11                       ;POP.L  R11
  474                             196 I1          MOV.L   @R15+,R10                       ;POP.L  R10
  475                             197 I1          MOV.L   @R15+,R9                        ;POP.L  R9
  476                             198 I1          MOV.L   @R15+,R8                        ;POP.L  R8
  477                             199 I1          MOV.L   @R15+,R7                        ;POP.L  R7
  478                             200 I1          MOV.L   @R15+,R6                        ;POP.L  R6
  479                             201 I1          MOV.L   @R15+,R5                        ;POP.L  R5
  480                             202 I1          MOV.L   @R15+,R4                        ;POP.L  R4
  481                             203 I1          MOV.L   @R15+,R3                        ;POP.L  R3
  482                             204 I1          MOV.L   @R15+,R2                        ;POP.L  R2
  483                             205 I1          MOV.L   @R15+,R1                        ;POP.L  R1
  484                             206 I1          MOV.L   @R15+,R0                        ;POP.L  R0
  485                             207 I1  
  486                             208 I1          .ENDM
  487                             209 I1  
  488                             210 I1  ;/*****************************************************************************
  489                             211 I1  ;       module          :[スタックポインタをＴＣＢにセーブする]
  490                             212 I1  ;       function        :[
  491                             213 I1  ;       ]
  492                             214 I1  ;       return          :[なし]
  493                             215 I1  ;       common          :[]
  494                             216 I1  ;       comment         :[
  495                             217 I1  ;       ]
  496                             218 I1  ;       machine         :[SH7043]
  497                             219 I1  ;       language        :[ASMSH]
  498                             220 I1  ;       keyword         :[MON]
  499                             221 I1  ;       date            :[1996/02/08]
  500                             222 I1  ;       author          :[野瀬敏弘]
  501                             223 I1  ;*****************************************************************************/
  502                             224 I1  
  503                             225 I1          .MACRO  STSP_REG
  504                             226 I1  
  505                             227 I1          MOV.L   real_run_tid_STKCHK\@,R2
  506                             228 I1          MOV.B   @R2,R1
  507                             229 I1          MOV             #TCB_TBL_SIZE,R8
  508                             230 I1          MULU    R1,R8                                                   ; real_run_tid * T
  509                             231 I1          MOV.L   tcb_STKCHK\@,R0
  510                             232 I1          STS             MACL,R2
  511                             233 I1          ADD             R2,R0
  512                             234 I1          MOV.L   R15,@(TCB_STACK_ADR,R0)                                 ; SPセーブ
  513                             235 I1          BRA             save_SP_end\@
*** SH SERIES ASSEMBLER Ver. 2.0 ***      01/28/98 12:58:15                                                              PAGE    10
PROGRAM NAME =

  514                             236 I1          NOP
  515                             237 I1  
  516                             238 I1          .ALIGN 4
  517                             239 I1  real_run_tid_STKCHK\@:
  518                             240 I1          .DATA.L         _real_run_tid
  519                             241 I1  tcb_STKCHK\@:
  520                             242 I1          .DATA.L         _tcb
  521                             243 I1  
  522                             244 I1  save_SP_end\@
  523                             245 I1  
  524                             246 I1          .ENDM
  525                             247 I1  
  526                             248 I1  ;/*****************************************************************************
  527                             249 I1  ;       module          :[スタックチェック]
  528                             250 I1  ;       function        :[
  529                             251 I1  ;       ]
  530                             252 I1  ;       return          :[なし]
  531                             253 I1  ;       common          :[
  532                             254 I1  ;               スタックチェックテーブルにはポインタによる間接アドレス参照で
  533                             255 I1  ;               アクセスします
  534                             256 I1  ;       ]
  535                             257 I1  ;       comment         :[
  536                             258 I1  ;
  537                             259 I1  ;               内部使用レジスタ
  538                             260 I1  ;                       R0 R12 R13 R14
  539                             261 I1  ;               エラー処理時のみ
  540                             262 I1  ;                       R1 R2
  541                             263 I1  ;
  542                             264 I1  ;                       UDWORD MON_StackCheckTable_p 4ﾊﾞｲﾄｻｲｽﾞ
  543                             265 I1  ;
  544                             266 I1  ;       ]
  545                             267 I1  ;       machine         :[SH7043]
  546                             268 I1  ;       language        :[ASMSH]
  547                             269 I1  ;       keyword         :[MON]
  548                             270 I1  ;       date            :[1997/04/16]
  549                             271 I1  ;       author          :[野瀬敏弘]
  550                             272 I1  ;*****************************************************************************/
  551                             273 I1  
  552                             274 I1          .MACRO  STACK_CHECK_P   ERRJUMP
  553                             275 I1  
  554                             276 I1          MOV.L           real_run_tid_STKCHK_P\@,R12
  555                             277 I1          MOV.B           @R12,R13
  556                             278 I1          EXTU.B          R13,R13                                                 ; R13 = re
  557                             279 I1          SHLL2           R13
  558                             280 I1  
  559                             281 I1  ;       MOV.L           MON_StackCheckTable_STKCHK\@,R0
  560                             282 I1  ;       下の２行に変更
  561                             283 I1          MOV.L           MON_StackCheckTable_p_STKCHK_P\@,R0
  562                             284 I1          MOV.L           @R0,R0
  563                             285 I1  
  564                             286 I1          MOV.L           @(R0,R13),R14                                   ; R14 = MON_StackC
  565                             287 I1          CMP/HS          R14,R15
  566                             288 I1          BT                      stack_chk_error_p\@                             ; SP >= R1
  567                             289 I1          ADD                     #4,R13
  568                             290 I1          MOV.L           @(R0,R13),R14                                   ; R14 = MON_StackC
  569                             291 I1          CMP/HS          R14,R15
  570                             292 I1          BT                      stack_chk_end_p\@                                       ;
*** SH SERIES ASSEMBLER Ver. 2.0 ***      01/28/98 12:58:15                                                              PAGE    11
PROGRAM NAME =

  571                             293 I1  
  572                             294 I1  stack_chk_error_p\@:
  573                             295 I1          MOV.L           stk_chk_err_STKCHK_P\@,R1
  574                             296 I1          JMP                     @R1
  575                             297 I1          NOP
  576                             298 I1  
  577                             299 I1          .ALIGN 4
  578                             300 I1  real_run_tid_STKCHK_P\@:
  579                             301 I1          .DATA.L         _real_run_tid
  580                             302 I1  ;MON_StackCheckTable_STKCHK\@:
  581                             303 I1  ;       .DATA.L         _MON_StackCheckTable
  582                             304 I1  stk_chk_err_STKCHK_P\@:
  583                             305 I1          .DATA.L         \ERRJUMP
  584                             306 I1  MON_StackCheckTable_p_STKCHK_P\@:
  585                             307 I1          .DATA.L         _MON_StackCheckTable_p
  586                             308 I1  
  587                             309 I1  stack_chk_end_p\@
  588                             310 I1  
  589                             311 I1          .ENDM
  590                             312 I1  
  591                             313 I1  ;/*****************************************************************************
  592                             314 I1  ;       module          :[スタックポインタをＴＣＢにセーブする]
  593                             315 I1  ;       function        :[
  594                             316 I1  ;       ]
  595                             317 I1  ;       return          :[なし]
  596                             318 I1  ;       common          :[]
  597                             319 I1  ;       comment         :[
  598                             320 I1  ;               ＴＣＢにはポインタによる間接アドレス参照でアクセスします
  599                             321 I1  ;       ]
  600                             322 I1  ;       machine         :[SH7043]
  601                             323 I1  ;       language        :[ASMSH]
  602                             324 I1  ;       keyword         :[MON]
  603                             325 I1  ;       date            :[1997/04/16]
  604                             326 I1  ;       author          :[野瀬敏弘]
  605                             327 I1  ;*****************************************************************************/
  606                             328 I1  
  607                             329 I1          .MACRO  STSP_REG_P
  608                             330 I1  
  609                             331 I1          MOV.L   real_run_tid_STSP_P\@,R2
  610                             332 I1          MOV.B   @R2,R1
  611                             333 I1          MOV             #TCB_TBL_SIZE,R8
  612                             334 I1          MULU    R1,R8                                                   ; real_run_tid * T
  613                             335 I1          MOV.L   tcbp_STSP_P\@,R0
  614                             336 I1          MOV.L   @R0,R0
  615                             337 I1          STS             MACL,R2
  616                             338 I1          ADD             R2,R0
  617                             339 I1          MOV.L   R15,@(TCB_STACK_ADR,R0)                                 ; SPセーブ
  618                             340 I1          BRA             end_STSP_P\@
  619                             341 I1          NOP
  620                             342 I1  
  621                             343 I1          .ALIGN 4
  622                             344 I1  real_run_tid_STSP_P\@:
  623                             345 I1          .DATA.L         _real_run_tid
  624                             346 I1  tcbp_STSP_P\@:
  625                             347 I1          .DATA.L         _tcb_p
  626                             348 I1  
  627                             349 I1  end_STSP_P\@
*** SH SERIES ASSEMBLER Ver. 2.0 ***      01/28/98 12:58:15                                                              PAGE    12
PROGRAM NAME =

  628                             350 I1  
  629                             351 I1          .ENDM
  630                             352 I1  
  631                             353 I1  ;/*****************************************************************************
  632                             354 I1  ;       module          :[割込み禁止 ＆ ポートＯＮ]
  633                             355 I1  ;       function        :[]
  634                             356 I1  ;       return          :[なし]
  635                             357 I1  ;       common          :[]
  636                             358 I1  ;       comment         :[]
  637                             359 I1  ;       machine         :[SH7043]
  638                             360 I1  ;       language        :[ASMSH]
  639                             361 I1  ;       keyword         :[MON]
  640                             362 I1  ;       date            :[1998/01/26]
  641                             363 I1  ;       author          :[野瀬敏弘]
  642                             364 I1  ;*****************************************************************************/
  643                             365 I1  
  644                             366 I1          .MACRO  INTDIS
  645                             367 I1  
  646                             368 I1  ;;;     MOV.L           R0,@-R15                                        ;PUSH.L R0 プッシ
  647                             369 I1          MOV.L           R1,@-R15                                        ;PUSH.L R1
  648                             370 I1          MOV.L           R2,@-R15                                        ;PUSH.L R2
  649                             371 I1  
  650                             372 I1          STC                     SR,R0
  651                             373 I1          MOV.L           INTDIS_TBL\@,R1
  652                             374 I1          OR                      R1,R0
  653                             375 I1          LDC                     R0,SR                                           ;割り込み
  654                             376 I1  
  655                             377 I1          MOV.L           INTDIS_TBL\@+4,R0
  656                             378 I1          MOV.W           INTDIS_TBL\@+D'12,R1
  657                             379 I1          MOV.W           @R0,R2
  658                             380 I1          OR                      R1,R2
  659                             381 I1          MOV.W           R2,@R0                                          ;SYS_COM_PortStatu
  660                             382 I1          MOV.L           INTDIS_TBL\@+8,R1
  661                             383 I1          MOV.W           R2,@R1                                          ;outpw(COM_PORT,SY
  662                             384 I1  
  663                             385 I1          MOV.L           @R15+,R2                                        ;POP.L  R2
  664                             386 I1          MOV.L           @R15+,R1                                        ;POP.L  R1
  665                             387 I1          MOV.L           @R15+,R0                                        ;POP.L  R0
  666                             388 I1          BRA                     INTDIS_END\@
  667                             389 I1          NOP
  668                             390 I1          .ALIGN 4
  669                             391 I1  INTDIS_TBL\@:
  670                             392 I1          .DATA.L         I_BIT_ON
  671                             393 I1          .DATA.L         _SYS_COM_PortStatus
  672                             394 I1          .DATA.L         H'00C203D0
  673                             395 I1          .DATA.W         H'0020
  674                             396 I1  INTDIS_END\@:
  675                             397 I1  
  676                             398 I1          .ENDM
  677                              12             .INCLUDE        "\src\atlanta\sh7043\ext_v\extv_mon.hdr"
  678                               1 I1  ;/*--------------------------------------------------------------------------*/
  679                               2 I1  ;/*  プロジェクト : POPLAR/ANZU_L                                            */
  680                               3 I1  ;/*  ファイル名   : extv_mon.hdr                                             */
  681                               4 I1  ;/*  作成者       : 野瀬敏弘                                                 */
  682                               5 I1  ;/*  日  付       : 1996/10/14                                               */
  683                               6 I1  ;/*  概  要       : モニタテーブル外部参照                                   */
  684                               7 I1  ;/*  修正履歴     :                                                          */
*** SH SERIES ASSEMBLER Ver. 2.0 ***      01/28/98 12:58:15                                                              PAGE    13
PROGRAM NAME =

  685                               8 I1  ;/*--------------------------------------------------------------------------*/
  686                               9 I1  
  687                              10 I1          .IMPORT         _real_run_tid
  688                              11 I1          .IMPORT         _top_ready_tid
  689                              12 I1          .IMPORT         _wai_tsk_tid
  690                              13 I1          .IMPORT         _wai_1shot_tid
  691                              14 I1          .IMPORT         _tib
  692                              15 I1          .IMPORT         _tcb_p
  693                              16 I1          .IMPORT         _scb_p
  694                              17 I1          .IMPORT         _ecb_p
  695                              18 I1          .IMPORT         _mcb_p
  696                              19 I1          .IMPORT         _MON_StackCheckTable_p
  697                              20 I1          .IMPORT         _MON_MAX_LARGE_TCB
  698                              21 I1          .IMPORT         _MON_MAX_SMALL_TCB
  699                              22 I1          .IMPORT         _MON_MAX_TCB
  700                              23 I1          .IMPORT         _MON_SIZE_LARGE_STACK
  701                              24 I1          .IMPORT         _MON_SIZE_SMALL_STACK
  702                              25 I1          .IMPORT         _MON_STACK_START_ADDR
  703                              26 I1          .IMPORT         _MON_TOP_LARGE_ADDR
  704                              27 I1          .IMPORT         _MON_TOP_SMALL_ADDR
  705                              28 I1          .IMPORT         _MON_MAX_SCB
  706                              29 I1          .IMPORT         _MON_MAX_SEMNO
  707                              30 I1          .IMPORT         _MON_MAX_MCB
  708                              31 I1          .IMPORT         _MON_MAX_MBXNO
  709                              32 I1          .IMPORT         _MON_MAX_ECB
  710                              33 I1  
  711                              34 I1  ; 以下の外部参照宣言は後程削除します
  712                              35 I1  ;       .IMPORT         _MON_DebugSwitch
  713                              36 I1  ;       .IMPORT         _tcb
  714                              37 I1  ;       .IMPORT         _scb
  715                              38 I1  ;       .IMPORT         _ecb
  716                              39 I1  ;       .IMPORT         _mcb
  717                              13     
  718                              14             .IMPORT         _rescheduler_vec
  719                              15             .IMPORT         _ready_func_vec
  720                              16             .IMPORT         monitor_error
  721                              17     ;割込み禁止期間測定用
  722                              18             .IMPORT         _SYS_COM_PortStatus
  723                              19     
  724                              20             .EXPORT         _det_evt_irom
  725                              21             .EXPORT         _det_evt_erom
  726                              22     
  727                              23     ;/*****************************************************************************
  728                              24     ;       module          :[イベント待ちしているタスクをレディにします]
  729                              25     ;       function        :[
  730                              26     ;               1. ECBのイベント番号で示されるウェイトタスク(リンク)を
  731                              27     ;                  全てReadyにします。
  732                              28     ;               2. 指定したイベント番号に待ちタスクが無い場合は、タスクのスイッチング
  733                              29     ;                  を行わずにリターンします。
  734                              30     ;       ]
  735                              31     ;       return          :[なし]
  736                              32     ;       common          :[_real_run_tid, _tcb, _ecb]
  737                              33     ;       comment         :[
  738                              34     ;
  739                              35     ;               det_evt(case_no)   Detect Event
  740                              36     ;               unsigned int case_no;
  741                              37     ;
*** SH SERIES ASSEMBLER Ver. 2.0 ***      01/28/98 12:58:15                                                              PAGE    14
PROGRAM NAME =

  742                              38     ;               引き数レジスタ
  743                              39     ;                       R4:case_no
  744                              40     ;               内部使用レジスタ
  745                              41     ;                       R0 R1 R2 R3 R5 R6 R7 R8 R9
  746                              42     ;       ]
  747                              43     ;       machine         :[SH]
  748                              44     ;       language        :[ASMSH]
  749                              45     ;       keyword         :[MON]
  750                              46     ;       date            :[1995/11/01]
  751                              47     ;       author          :[野瀬敏弘]
  752                              48     ;*****************************************************************************/
  753                              49     ;/**************************/
  754                              50     ;/* ＳＨ７０４３内蔵ＲＯＭ */
  755                              51     ;/**************************/
  756 00000000                     52             .SECTION        MON,CODE,ALIGN=4
  757 00000000                     53     _det_evt_irom:
  758 00000000 7FF8                54             ADD             #-8,R15
  759                              55     ;--------------------------------------------------------------
  760                              56             STCTX_REG                                       ;ﾏｸﾛ ﾚｼﾞｽﾀの保存
  761                                 M   
  762 00000002 2F06                   M           MOV.L           R0,@-R15                                                ;PUSH.L R0
  763 00000004 2F16                   M           MOV.L           R1,@-R15                                                ;PUSH.L R1
  764 00000006 0002                   M           STC                     SR,R0
  765 00000008 D10B                   M           MOV.L           STCTX_REG_TBL00000,R1
  766 0000000A 201B                   M           OR                      R1,R0
  767 0000000C 400E                   M           LDC                     R0,SR                                                   ;
  768 0000000E 2F26                   M           MOV.L           R2,@-R15                                                ;PUSH.L R2
  769 00000010 2F36                   M           MOV.L           R3,@-R15                                                ;PUSH.L R3
  770 00000012 2F46                   M           MOV.L           R4,@-R15                                                ;PUSH.L R4
  771 00000014 2F56                   M           MOV.L           R5,@-R15                                                ;PUSH.L R5
  772 00000016 2F66                   M           MOV.L           R6,@-R15                                                ;PUSH.L R6
  773 00000018 2F76                   M           MOV.L           R7,@-R15                                                ;PUSH.L R7
  774 0000001A 2F86                   M           MOV.L           R8,@-R15                                                ;PUSH.L R8
  775 0000001C 2F96                   M           MOV.L           R9,@-R15                                                ;PUSH.L R9
  776 0000001E 2FA6                   M           MOV.L           R10,@-R15                                               ;PUSH.L R1
  777 00000020 2FB6                   M           MOV.L           R11,@-R15                                               ;PUSH.L R1
  778 00000022 2FC6                   M           MOV.L           R12,@-R15                                               ;PUSH.L R1
  779 00000024 2FD6                   M           MOV.L           R13,@-R15                                               ;PUSH.L R1
  780 00000026 2FE6                   M           MOV.L           R14,@-R15                                               ;PUSH.L R1
  781 00000028 4F13                   M           STC.L           GBR,@-R15                                               ;PUSH.L GB
  782 0000002A 4F23                   M           STC.L           VBR,@-R15                                               ;PUSH.L VB
  783 0000002C 4F02                   M           STS.L           MACH,@-R15                                              ;PUSH.L MA
  784 0000002E 4F12                   M           STS.L           MACL,@-R15                                              ;PUSH.L MA
  785 00000030 4F22                   M           STS.L           PR,@-R15                                                ;PUSH.L PR
  786                                 M   
  787 00000032 A003                   M           BRA                     stctx_reg_end00000
  788 00000034 0009                   M           NOP
  789                                 M   
  790 00000038                        M           .ALIGN 4
  791 00000038                        M   STCTX_REG_TBL00000:
  792 00000038 000000F0               M           .DATA.L         I_BIT_ON
  793                                 M   
  794 0000003C                        M   stctx_reg_end00000:
  795                                 M   
  796                              57     ;--------------------------------------------------------------
  797 0000003C 60F3                58             MOV.L   R15,R0
  798 0000003E 7050                59             ADD             #STACK_PC_POSITION,R0
*** SH SERIES ASSEMBLER Ver. 2.0 ***      01/28/98 12:58:15                                                              PAGE    15
PROGRAM NAME =

  799 00000040 012A                60             STS             PR,R1
  800 00000042 2012                61             MOV.L   R1,@R0                          ;PR(=PC)をスタックへセーブ
  801                              62     
  802 00000044 7004                63             ADD             #4,R0                           ;INC.L  R0
  803 00000046 0102                64             STC             SR,R1
  804 00000048 D232                65             MOV.L   I_BIT_OFF_det_evt_i,R2          ;R2 = 0x0000030F
  805 0000004A 2129                66             AND             R2,R1                           ;割込許可
  806 0000004C 2012                67             MOV.L   R1,@R0                          ;SRをスタックへセーブ
  807                              68     
  808                              69     ;--------------------------------------------------------------
  809                              70             STSP_REG_P                                      ;ﾏｸﾛ スタックポインタの保存
  810                                 M   
  811 0000004E D205                   M           MOV.L   real_run_tid_STSP_P00001,R2
  812 00000050 6120                   M           MOV.B   @R2,R1
  813 00000052 E810                   M           MOV             #TCB_TBL_SIZE,R8
  814 00000054 281E                   M           MULU    R1,R8                                                   ; real_run_tid * T
  815 00000056 D004                   M           MOV.L   tcbp_STSP_P00001,R0
  816 00000058 6002                   M           MOV.L   @R0,R0
  817 0000005A 021A                   M           STS             MACL,R2
  818 0000005C 302C                   M           ADD             R2,R0
  819 0000005E 10F3                   M           MOV.L   R15,@(TCB_STACK_ADR,R0)                                 ; SPセーブ
  820 00000060 A004                   M           BRA             end_STSP_P00001
  821 00000062 0009                   M           NOP
  822                                 M   
  823 00000064                        M           .ALIGN 4
  824 00000064                        M   real_run_tid_STSP_P00001:
  825 00000064 00000000               M           .DATA.L         _real_run_tid
  826 00000068                        M   tcbp_STSP_P00001:
  827 00000068 00000000               M           .DATA.L         _tcb_p
  828                                 M   
  829 0000006C                        M   end_STSP_P00001
  830                                 M   
  831                              71     ;--------------------------------------------------------------
  832                              72     ;--------------------------------------------------------------
  833                              73             STACK_CHECK_P   err_det_evt_i           ;ﾏｸﾛ ﾀｽｸﾁｪｯｸ
  834                                 M   
  835 0000006C DC07                   M           MOV.L           real_run_tid_STKCHK_P00002,R12
  836 0000006E 6DC0                   M           MOV.B           @R12,R13
  837 00000070 6DDC                   M           EXTU.B          R13,R13                                                 ; R13 = re
  838 00000072 4D08                   M           SHLL2           R13
  839                                 M   
  840                                 M   ;       MOV.L           MON_StackCheckTable_STKCHK00002,R0
  841                                 M   ;       下の２行に変更
  842 00000074 D007                   M           MOV.L           MON_StackCheckTable_p_STKCHK_P00002,R0
  843 00000076 6002                   M           MOV.L           @R0,R0
  844                                 M   
  845 00000078 0EDE                   M           MOV.L           @(R0,R13),R14                                   ; R14 = MON_StackC
  846 0000007A 3FE2                   M           CMP/HS          R14,R15
  847 0000007C 8903                   M           BT                      stack_chk_error_p00002                          ; SP >= R1
  848 0000007E 7D04                   M           ADD                     #4,R13
  849 00000080 0EDE                   M           MOV.L           @(R0,R13),R14                                   ; R14 = MON_StackC
  850 00000082 3FE2                   M           CMP/HS          R14,R15
  851 00000084 8908                   M           BT                      stack_chk_end_p00002                                    ;
  852                                 M   
  853 00000086                        M   stack_chk_error_p00002:
  854 00000086 D102                   M           MOV.L           stk_chk_err_STKCHK_P00002,R1
  855 00000088 412B                   M           JMP                     @R1
*** SH SERIES ASSEMBLER Ver. 2.0 ***      01/28/98 12:58:15                                                              PAGE    16
PROGRAM NAME =

  856 0000008A 0009                   M           NOP
  857                                 M   
  858 0000008C                        M           .ALIGN 4
  859 0000008C                        M   real_run_tid_STKCHK_P00002:
  860 0000008C 00000000               M           .DATA.L         _real_run_tid
  861                                 M   ;MON_StackCheckTable_STKCHK00002:
  862                                 M   ;       .DATA.L         _MON_StackCheckTable
  863 00000090                        M   stk_chk_err_STKCHK_P00002:
  864 00000090 00000000               M           .DATA.L         err_det_evt_i
  865 00000094                        M   MON_StackCheckTable_p_STKCHK_P00002:
  866 00000094 00000000               M           .DATA.L         _MON_StackCheckTable_p
  867                                 M   
  868 00000098                        M   stack_chk_end_p00002
  869                                 M   
  870                              74     ;--------------------------------------------------------------
  871                              75     
  872 00000098                     76     det_evt00_i:
  873 00000098 D824                77             MOV.L   MON_MAX_ECB_detevt_i,R8
  874 0000009A 6881                78             MOV.W   @R8,R8
  875 0000009C 688D                79             EXTU.W  R8,R8
  876 0000009E 3846                80             CMP/HI  R4,R8
  877 000000A0 8B35                81             BF              err_det_evt_i           ; case_no >= EVENT_MAX -> err_det_evt
  878                              82     
  879 000000A2 D021                83             MOV.L   ecbp_detevt_i,R0
  880 000000A4 6002                84             MOV.L   @R0,R0
  881 000000A6 E8FF                85             MOV             #NIL,R8
  882 000000A8 014C                86             MOV.B   @(R0,R4),R1
  883 000000AA 3810                87             CMP/EQ  R1,R8
  884 000000AC 8B15                88             BF              det_evt01_i
  885                              89     ;---------------------------------------------------------
  886                              90             RSTR_REG                        ; ﾏｸﾛ ﾚｼﾞｽﾀﾎﾟｯﾌﾟ
  887                                 M   
  888 000000AE 4F26                   M           LDS.L   @R15+,PR                        ;POP.L  PR
  889 000000B0 4F16                   M           LDS.L   @R15+,MACL                      ;POP.L  MACL
  890 000000B2 4F06                   M           LDS.L   @R15+,MACH                      ;POP.L  MACH
  891 000000B4 4F27                   M           LDC.L   @R15+,VBR                       ;POP.L  VBR
  892 000000B6 4F17                   M           LDC.L   @R15+,GBR                       ;POP.L  GBR
  893 000000B8 6EF6                   M           MOV.L   @R15+,R14                       ;POP.L  R14
  894 000000BA 6DF6                   M           MOV.L   @R15+,R13                       ;POP.L  R13
  895 000000BC 6CF6                   M           MOV.L   @R15+,R12                       ;POP.L  R12
  896 000000BE 6BF6                   M           MOV.L   @R15+,R11                       ;POP.L  R11
  897 000000C0 6AF6                   M           MOV.L   @R15+,R10                       ;POP.L  R10
  898 000000C2 69F6                   M           MOV.L   @R15+,R9                        ;POP.L  R9
  899 000000C4 68F6                   M           MOV.L   @R15+,R8                        ;POP.L  R8
  900 000000C6 67F6                   M           MOV.L   @R15+,R7                        ;POP.L  R7
  901 000000C8 66F6                   M           MOV.L   @R15+,R6                        ;POP.L  R6
  902 000000CA 65F6                   M           MOV.L   @R15+,R5                        ;POP.L  R5
  903 000000CC 64F6                   M           MOV.L   @R15+,R4                        ;POP.L  R4
  904 000000CE 63F6                   M           MOV.L   @R15+,R3                        ;POP.L  R3
  905 000000D0 62F6                   M           MOV.L   @R15+,R2                        ;POP.L  R2
  906 000000D2 61F6                   M           MOV.L   @R15+,R1                        ;POP.L  R1
  907 000000D4 60F6                   M           MOV.L   @R15+,R0                        ;POP.L  R0
  908                                 M   
  909                              91     ;---------------------------------------------------------
  910 000000D6 002B                92             RTE
  911 000000D8 0009                93             NOP
  912                              94     
*** SH SERIES ASSEMBLER Ver. 2.0 ***      01/28/98 12:58:15                                                              PAGE    17
PROGRAM NAME =

  913 000000DA                     95     det_evt01_i:
  914 000000DA E5FF                96             MOV             #NIL,R5
  915 000000DC 0454                97             MOV.B   R5,@(R0,R4)                     ; ECBクリア
  916                              98     
  917 000000DE D511                99             MOV.L   tcbp_detevt_i,R5
  918 000000E0 6552               100             MOV.L   @R5,R5
  919 000000E2                    101     det_evt02_i:                                    ; ECB接続TCBをすべてReadyに接続する
  920 000000E2 E810               102             MOV             #TCB_TBL_SIZE,R8
  921 000000E4 281E               103             MULU    R1,R8
  922 000000E6 E040               104             MOV             #READY,R0
  923 000000E8 061A               105             STS             MACL,R6
  924 000000EA 365C               106             ADD             R5,R6
  925 000000EC 8060               107             MOV.B   R0,@(TCB_STAT,R6)       ; tsk_stat = READY
  926 000000EE 3008               108             SUB             R0,R0
  927 000000F0 8065               109             MOV.B   R0,@(TCB_WAIT_PARAM,R6) ; tsk_stat_tpo = 0
  928 000000F2 D909               110             MOV.L   ready_func_det_evt_i,R9
  929 000000F4 6992               111             MOV.L   @R9,R9
  930 000000F6 8463               112             MOV.B   @(TCB_LINK,R6),R0
  931 000000F8 490B               113             JSR             @R9
  932 000000FA 6703               114             MOV             R0,R7                           ; 次のリンクのセーブ JSRより先に実
  933 000000FC E8FF               115             MOV             #NIL,R8
  934 000000FE 3870               116             CMP/EQ  R7,R8
  935 00000100 8901               117             BT              det_evt_ok_i
  936 00000102 AFEE               118             BRA             det_evt02_i
  937 00000104 6173               119             MOV             R7,R1                           ; BRA命令に先立って実行される
  938                             120     
  939 00000106                    121     det_evt_ok_i:
  940 00000106 D005               122             MOV.L   rescheduler_det_evt_i,R0
  941 00000108 6002               123             MOV.L   @R0,R0
  942 0000010A 402B               124             JMP             @R0
  943 0000010C 0009               125             NOP
  944                             126     
  945 0000010E                    127     err_det_evt_i:
  946 0000010E D104               128             MOV.L   monitor_error_det_evt_i,R1
  947 00000110 412B               129             JMP             @R1
  948 00000112 0009               130             NOP
  949                             131     
  950 00000114                    132             .ALIGN 4
  951 00000114                    133     I_BIT_OFF_det_evt_i:
  952 00000114 0000030F           134             .DATA.L I_BIT_OFF
  953 00000118                    135     ready_func_det_evt_i:
  954 00000118 00000000           136             .DATA.L _ready_func_vec
  955 0000011C                    137     rescheduler_det_evt_i:
  956 0000011C 00000000           138             .DATA.L _rescheduler_vec
  957 00000120                    139     monitor_error_det_evt_i:
  958 00000120 00000000           140             .DATA.L monitor_error
  959 00000124                    141     tcbp_detevt_i:
  960 00000124 00000000           142             .DATA.L _tcb_p
  961 00000128                    143     ecbp_detevt_i:
  962 00000128 00000000           144             .DATA.L _ecb_p
  963 0000012C                    145     MON_MAX_ECB_detevt_i:
  964 0000012C 00000000           146             .DATA.L _MON_MAX_ECB
  965                             147     
  966                             148     ;/****************/
  967                             149     ;/* 外付けＲＯＭ */
  968                             150     ;/****************/
  969 00000000                    151             .SECTION        P,CODE,ALIGN=4
*** SH SERIES ASSEMBLER Ver. 2.0 ***      01/28/98 12:58:15                                                              PAGE    18
PROGRAM NAME =

  970 00000000                    152     _det_evt_erom:
  971 00000000 7FF8               153             ADD             #-8,R15
  972                             154     ;--------------------------------------------------------------
  973                             155             STCTX_REG                                       ;ﾏｸﾛ ﾚｼﾞｽﾀの保存
  974                                 M   
  975 00000002 2F06                   M           MOV.L           R0,@-R15                                                ;PUSH.L R0
  976 00000004 2F16                   M           MOV.L           R1,@-R15                                                ;PUSH.L R1
  977 00000006 0002                   M           STC                     SR,R0
  978 00000008 D10B                   M           MOV.L           STCTX_REG_TBL00003,R1
  979 0000000A 201B                   M           OR                      R1,R0
  980 0000000C 400E                   M           LDC                     R0,SR                                                   ;
  981 0000000E 2F26                   M           MOV.L           R2,@-R15                                                ;PUSH.L R2
  982 00000010 2F36                   M           MOV.L           R3,@-R15                                                ;PUSH.L R3
  983 00000012 2F46                   M           MOV.L           R4,@-R15                                                ;PUSH.L R4
  984 00000014 2F56                   M           MOV.L           R5,@-R15                                                ;PUSH.L R5
  985 00000016 2F66                   M           MOV.L           R6,@-R15                                                ;PUSH.L R6
  986 00000018 2F76                   M           MOV.L           R7,@-R15                                                ;PUSH.L R7
  987 0000001A 2F86                   M           MOV.L           R8,@-R15                                                ;PUSH.L R8
  988 0000001C 2F96                   M           MOV.L           R9,@-R15                                                ;PUSH.L R9
  989 0000001E 2FA6                   M           MOV.L           R10,@-R15                                               ;PUSH.L R1
  990 00000020 2FB6                   M           MOV.L           R11,@-R15                                               ;PUSH.L R1
  991 00000022 2FC6                   M           MOV.L           R12,@-R15                                               ;PUSH.L R1
  992 00000024 2FD6                   M           MOV.L           R13,@-R15                                               ;PUSH.L R1
  993 00000026 2FE6                   M           MOV.L           R14,@-R15                                               ;PUSH.L R1
  994 00000028 4F13                   M           STC.L           GBR,@-R15                                               ;PUSH.L GB
  995 0000002A 4F23                   M           STC.L           VBR,@-R15                                               ;PUSH.L VB
  996 0000002C 4F02                   M           STS.L           MACH,@-R15                                              ;PUSH.L MA
  997 0000002E 4F12                   M           STS.L           MACL,@-R15                                              ;PUSH.L MA
  998 00000030 4F22                   M           STS.L           PR,@-R15                                                ;PUSH.L PR
  999                                 M   
 1000 00000032 A003                   M           BRA                     stctx_reg_end00003
 1001 00000034 0009                   M           NOP
 1002                                 M   
 1003 00000038                        M           .ALIGN 4
 1004 00000038                        M   STCTX_REG_TBL00003:
 1005 00000038 000000F0               M           .DATA.L         I_BIT_ON
 1006                                 M   
 1007 0000003C                        M   stctx_reg_end00003:
 1008                                 M   
 1009                             156     ;--------------------------------------------------------------
 1010                             157     
 1011                             158     ;割込み禁止期間測定用
 1012                             159     ;ポートをＯＮする
 1013 0000003C D02E               160             MOV.L   PORT_ADR_DATA,R0
 1014 0000003E 915F               161             MOV.W   PORT_ADR_DATA+8,R1
 1015 00000040 6201               162             MOV.W   @R0,R2
 1016 00000042 221B               163             OR              R1,R2
 1017 00000044 2021               164             MOV.W   R2,@R0          ; SYS_COM_Port_Status |= 0x0020
 1018 00000046 D12D               165             MOV.L   PORT_ADR_DATA+4,R1
 1019 00000048 2121               166             MOV.W   R2,@R1          ; outpw(COM_PORT,SYS_COM_PortStatus)
 1020                             167     ;ここまで
 1021                             168     
 1022 0000004A 60F3               169             MOV.L   R15,R0
 1023 0000004C 7050               170             ADD             #STACK_PC_POSITION,R0
 1024 0000004E 012A               171             STS             PR,R1
 1025 00000050 2012               172             MOV.L   R1,@R0                          ;PR(=PC)をスタックへセーブ
 1026                             173     
*** SH SERIES ASSEMBLER Ver. 2.0 ***      01/28/98 12:58:15                                                              PAGE    19
PROGRAM NAME =

 1027 00000052 7004               174             ADD             #4,R0                           ;INC.L  R0
 1028 00000054 0102               175             STC             SR,R1
 1029 00000056 D23A               176             MOV.L   I_BIT_OFF_det_evt_e,R2          ;R2 = 0x0000030F
 1030 00000058 2129               177             AND             R2,R1                           ;割込許可
 1031 0000005A 2012               178             MOV.L   R1,@R0                          ;SRをスタックへセーブ
 1032                             179     
 1033                             180     ;--------------------------------------------------------------
 1034                             181             STSP_REG_P                                      ;ﾏｸﾛ スタックポインタの保存
 1035                                 M   
 1036 0000005C D205                   M           MOV.L   real_run_tid_STSP_P00004,R2
 1037 0000005E 6120                   M           MOV.B   @R2,R1
 1038 00000060 E810                   M           MOV             #TCB_TBL_SIZE,R8
 1039 00000062 281E                   M           MULU    R1,R8                                                   ; real_run_tid * T
 1040 00000064 D004                   M           MOV.L   tcbp_STSP_P00004,R0
 1041 00000066 6002                   M           MOV.L   @R0,R0
 1042 00000068 021A                   M           STS             MACL,R2
 1043 0000006A 302C                   M           ADD             R2,R0
 1044 0000006C 10F3                   M           MOV.L   R15,@(TCB_STACK_ADR,R0)                                 ; SPセーブ
 1045 0000006E A005                   M           BRA             end_STSP_P00004
 1046 00000070 0009                   M           NOP
 1047                                 M   
 1048 00000074                        M           .ALIGN 4
 1049 00000074                        M   real_run_tid_STSP_P00004:
 1050 00000074 00000000               M           .DATA.L         _real_run_tid
 1051 00000078                        M   tcbp_STSP_P00004:
 1052 00000078 00000000               M           .DATA.L         _tcb_p
 1053                                 M   
 1054 0000007C                        M   end_STSP_P00004
 1055                                 M   
 1056                             182     ;--------------------------------------------------------------
 1057                             183     ;--------------------------------------------------------------
 1058                             184             STACK_CHECK_P   err_det_evt_e           ;ﾏｸﾛ ﾀｽｸﾁｪｯｸ
 1059                                 M   
 1060 0000007C DC07                   M           MOV.L           real_run_tid_STKCHK_P00005,R12
 1061 0000007E 6DC0                   M           MOV.B           @R12,R13
 1062 00000080 6DDC                   M           EXTU.B          R13,R13                                                 ; R13 = re
 1063 00000082 4D08                   M           SHLL2           R13
 1064                                 M   
 1065                                 M   ;       MOV.L           MON_StackCheckTable_STKCHK00005,R0
 1066                                 M   ;       下の２行に変更
 1067 00000084 D007                   M           MOV.L           MON_StackCheckTable_p_STKCHK_P00005,R0
 1068 00000086 6002                   M           MOV.L           @R0,R0
 1069                                 M   
 1070 00000088 0EDE                   M           MOV.L           @(R0,R13),R14                                   ; R14 = MON_StackC
 1071 0000008A 3FE2                   M           CMP/HS          R14,R15
 1072 0000008C 8903                   M           BT                      stack_chk_error_p00005                          ; SP >= R1
 1073 0000008E 7D04                   M           ADD                     #4,R13
 1074 00000090 0EDE                   M           MOV.L           @(R0,R13),R14                                   ; R14 = MON_StackC
 1075 00000092 3FE2                   M           CMP/HS          R14,R15
 1076 00000094 8908                   M           BT                      stack_chk_end_p00005                                    ;
 1077                                 M   
 1078 00000096                        M   stack_chk_error_p00005:
 1079 00000096 D102                   M           MOV.L           stk_chk_err_STKCHK_P00005,R1
 1080 00000098 412B                   M           JMP                     @R1
 1081 0000009A 0009                   M           NOP
 1082                                 M   
 1083 0000009C                        M           .ALIGN 4
*** SH SERIES ASSEMBLER Ver. 2.0 ***      01/28/98 12:58:15                                                              PAGE    20
PROGRAM NAME =

 1084 0000009C                        M   real_run_tid_STKCHK_P00005:
 1085 0000009C 00000000               M           .DATA.L         _real_run_tid
 1086                                 M   ;MON_StackCheckTable_STKCHK00005:
 1087                                 M   ;       .DATA.L         _MON_StackCheckTable
 1088 000000A0                        M   stk_chk_err_STKCHK_P00005:
 1089 000000A0 00000000               M           .DATA.L         err_det_evt_e
 1090 000000A4                        M   MON_StackCheckTable_p_STKCHK_P00005:
 1091 000000A4 00000000               M           .DATA.L         _MON_StackCheckTable_p
 1092                                 M   
 1093 000000A8                        M   stack_chk_end_p00005
 1094                                 M   
 1095                             185     ;--------------------------------------------------------------
 1096                             186     
 1097 000000A8                    187     det_evt00_e:
 1098                             188     ;       MOV             #EVENT_MAX,R8
 1099                             189     ;FOR POINTER ACCESS
 1100 000000A8 D82B               190             MOV.L   MON_MAX_ECB_detevt_e,R8
 1101 000000AA 6881               191             MOV.W   @R8,R8
 1102 000000AC 688D               192             EXTU.W  R8,R8
 1103                             193     
 1104 000000AE 3846               194             CMP/HI  R4,R8
 1105 000000B0 8B42               195             BF              err_det_evt_e           ; case_no >= EVENT_MAX -> err_det_evt
 1106                             196     
 1107                             197     ;       MOV.L   ecb_det_evt_e,R0
 1108                             198     ;FOR POINTER ACCESS
 1109 000000B2 D028               199             MOV.L   ecbp_detevt_e,R0
 1110 000000B4 6002               200             MOV.L   @R0,R0
 1111                             201     
 1112 000000B6 E8FF               202             MOV             #NIL,R8
 1113 000000B8 014C               203             MOV.B   @(R0,R4),R1
 1114 000000BA 3810               204             CMP/EQ  R1,R8
 1115 000000BC 8B22               205             BF              det_evt01_e
 1116                             206     
 1117                             207     ;割込み禁止期間測定用
 1118                             208     ;ポートをＯＦＦする
 1119 000000BE D00E               209             MOV.L   PORT_ADR_DATA,R0
 1120 000000C0 911F               210             MOV.W   PORT_ADR_DATA+H'A,R1
 1121 000000C2 6201               211             MOV.W   @R0,R2
 1122 000000C4 2219               212             AND             R1,R2
 1123 000000C6 2021               213             MOV.W   R2,@R0          ; SYS_COM_Port_Status &= ~0x0020
 1124 000000C8 D10C               214             MOV.L   PORT_ADR_DATA+4,R1
 1125 000000CA 2121               215             MOV.W   R2,@R1          ; outpw(COM_PORT,SYS_COM_PortStatus)
 1126                             216     ;ここまで
 1127                             217     
 1128                             218     ;---------------------------------------------------------
 1129                             219             RSTR_REG                        ; ﾏｸﾛ ﾚｼﾞｽﾀﾎﾟｯﾌﾟ
 1130                                 M   
 1131 000000CC 4F26                   M           LDS.L   @R15+,PR                        ;POP.L  PR
 1132 000000CE 4F16                   M           LDS.L   @R15+,MACL                      ;POP.L  MACL
 1133 000000D0 4F06                   M           LDS.L   @R15+,MACH                      ;POP.L  MACH
 1134 000000D2 4F27                   M           LDC.L   @R15+,VBR                       ;POP.L  VBR
 1135 000000D4 4F17                   M           LDC.L   @R15+,GBR                       ;POP.L  GBR
 1136 000000D6 6EF6                   M           MOV.L   @R15+,R14                       ;POP.L  R14
 1137 000000D8 6DF6                   M           MOV.L   @R15+,R13                       ;POP.L  R13
 1138 000000DA 6CF6                   M           MOV.L   @R15+,R12                       ;POP.L  R12
 1139 000000DC 6BF6                   M           MOV.L   @R15+,R11                       ;POP.L  R11
 1140 000000DE 6AF6                   M           MOV.L   @R15+,R10                       ;POP.L  R10
*** SH SERIES ASSEMBLER Ver. 2.0 ***      01/28/98 12:58:15                                                              PAGE    21
PROGRAM NAME =

 1141 000000E0 69F6                   M           MOV.L   @R15+,R9                        ;POP.L  R9
 1142 000000E2 68F6                   M           MOV.L   @R15+,R8                        ;POP.L  R8
 1143 000000E4 67F6                   M           MOV.L   @R15+,R7                        ;POP.L  R7
 1144 000000E6 66F6                   M           MOV.L   @R15+,R6                        ;POP.L  R6
 1145 000000E8 65F6                   M           MOV.L   @R15+,R5                        ;POP.L  R5
 1146 000000EA 64F6                   M           MOV.L   @R15+,R4                        ;POP.L  R4
 1147 000000EC 63F6                   M           MOV.L   @R15+,R3                        ;POP.L  R3
 1148 000000EE 62F6                   M           MOV.L   @R15+,R2                        ;POP.L  R2
 1149 000000F0 61F6                   M           MOV.L   @R15+,R1                        ;POP.L  R1
 1150 000000F2 60F6                   M           MOV.L   @R15+,R0                        ;POP.L  R0
 1151                                 M   
 1152                             220     ;---------------------------------------------------------
 1153 000000F4 002B               221             RTE
 1154 000000F6 0009               222             NOP
 1155                             223     
 1156                             224     ;割込み禁止期間測定用
 1157 000000F8                    225             .ALIGN 4
 1158 000000F8                    226     PORT_ADR_DATA:
 1159 000000F8 00000000           227             .DATA.L         _SYS_COM_PortStatus
 1160 000000FC 00C203D0           228             .DATA.L         H'00C203D0
 1161 00000100 0020               229             .DATA.W         H'0020
 1162 00000102 FFDF               230             .DATA.W         H'FFDF
 1163                             231     ;ここまで
 1164                             232     
 1165 00000104                    233     det_evt01_e:
 1166 00000104 E5FF               234             MOV             #NIL,R5
 1167 00000106 0454               235             MOV.B   R5,@(R0,R4)                     ; ECBクリア
 1168                             236     
 1169                             237     ;       MOV             tcb_det_evt_e,R5
 1170                             238     ;FOR POINTER ACCESS
 1171 00000108 D511               239             MOV.L   tcbp_detevt_e,R5
 1172 0000010A 6552               240             MOV.L   @R5,R5
 1173 0000010C                    241     det_evt02_e:                                    ; ECB接続TCBをすべてReadyに接続する
 1174 0000010C E810               242             MOV             #TCB_TBL_SIZE,R8
 1175 0000010E 281E               243             MULU    R1,R8
 1176 00000110 E040               244             MOV             #READY,R0
 1177 00000112 061A               245             STS             MACL,R6
 1178 00000114 365C               246             ADD             R5,R6
 1179 00000116 8060               247             MOV.B   R0,@(TCB_STAT,R6)       ; tsk_stat = READY
 1180 00000118 3008               248             SUB             R0,R0
 1181 0000011A 8065               249             MOV.B   R0,@(TCB_WAIT_PARAM,R6) ; tsk_stat_tpo = 0
 1182 0000011C D909               250             MOV.L   ready_func_det_evt_e,R9
 1183 0000011E 6992               251             MOV.L   @R9,R9
 1184 00000120 8463               252             MOV.B   @(TCB_LINK,R6),R0
 1185 00000122 490B               253             JSR             @R9
 1186 00000124 6703               254             MOV             R0,R7                           ; 次のリンクのセーブ JSRより先に実
 1187 00000126 E8FF               255             MOV             #NIL,R8
 1188 00000128 3870               256             CMP/EQ  R7,R8
 1189 0000012A 8901               257             BT              det_evt_ok_e
 1190 0000012C AFEE               258             BRA             det_evt02_e
 1191 0000012E 6173               259             MOV             R7,R1                           ; BRA命令に先立って実行される
 1192                             260     
 1193 00000130                    261     det_evt_ok_e:
 1194 00000130 D005               262             MOV.L   rescheduler_det_evt_e,R0
 1195 00000132 6002               263             MOV.L   @R0,R0
 1196 00000134 402B               264             JMP             @R0
 1197 00000136 0009               265             NOP
*** SH SERIES ASSEMBLER Ver. 2.0 ***      01/28/98 12:58:15                                                              PAGE    22
PROGRAM NAME =

 1198                             266     
 1199 00000138                    267     err_det_evt_e:
 1200 00000138 D104               268             MOV.L   monitor_error_det_evt_e,R1
 1201 0000013A 412B               269             JMP             @R1
 1202 0000013C 0009               270             NOP
 1203                             271     
 1204 00000140                    272             .ALIGN 4
 1205 00000140                    273     I_BIT_OFF_det_evt_e:
 1206 00000140 0000030F           274             .DATA.L I_BIT_OFF
 1207                             275     ;tcb_det_evt_e:
 1208                             276     ;       .DATA.L _tcb
 1209                             277     ;ecb_det_evt_e:
 1210                             278     ;       .DATA.L _ecb
 1211 00000144                    279     ready_func_det_evt_e:
 1212 00000144 00000000           280             .DATA.L _ready_func_vec
 1213 00000148                    281     rescheduler_det_evt_e:
 1214 00000148 00000000           282             .DATA.L _rescheduler_vec
 1215 0000014C                    283     monitor_error_det_evt_e:
 1216 0000014C 00000000           284             .DATA.L monitor_error
 1217 00000150                    285     tcbp_detevt_e:
 1218 00000150 00000000           286             .DATA.L _tcb_p
 1219 00000154                    287     ecbp_detevt_e:
 1220 00000154 00000000           288             .DATA.L _ecb_p
 1221 00000158                    289     MON_MAX_ECB_detevt_e:
 1222 00000158 00000000           290             .DATA.L _MON_MAX_ECB
 1223                             291     
 1224                             292             .END
  *****TOTAL ERRORS       0
  *****TOTAL WARNINGS     0
*** SH SERIES ASSEMBLER Ver. 2.0 ***      01/28/98 12:58:15                                                              PAGE    23

*** CROSS REFERENCE LIST

NAME                             SECTION  ATTR VALUE             SEQUENCE

ERROR                                     EQU  000000FF    193*
FLAG_INIT_DATA                            EQU  00000000     42*
INIT_TID                                  EQU  00000000     33*
I_BIT_OFF                                 EQU  0000030F     23*  952  1206 
I_BIT_OFF_det_evt_e              P             00000140   1029  1205*
I_BIT_OFF_det_evt_i              MON           00000114    804   951*
I_BIT_ON                                  EQU  000000F0     22*  792  1005 
LONGNIL                                   EQU  FFFFFFFF    180*
MON                              MON      SCT  00000000    756*
MON_FAILURE                               EQU  00000000    276*
MON_MAX_ECB_detevt_e             P             00000158   1100  1221*
MON_MAX_ECB_detevt_i             MON           0000012C    873   963*
MON_SUCCESS                               EQU  00000001    275*
MON_StackCheckTable_p_STKCHK_P00*MON           00000094    842   865*
MON_StackCheckTable_p_STKCHK_P00*P             000000A4   1067  1090*
NIL                                       EQU  000000FF    178*  881   914   933  1112  1166  1187 
NOT_USED                                  EQU  000000C0    184*
NO_WAIMBX                                 EQU  0000007F    249*
ONESHOT_VALUE_MAX                         EQU  0000001A     28*
P                                P        SCT  00000000    969*
PORT_ADR_DATA                    P             000000F8   1013  1014  1018  1119  1120  1124  1158*
RCV_WAIT                                  EQU  00000002    187*
READY                                     EQU  00000040    183*  922  1176 
SCB_INIT                                  EQU  0000007F    221*
SCB_STAT                                  EQU  00000000    228*
SCB_TBL_SIZE                              EQU  00000002    220*
SCB_TID                                   EQU  00000001    229*
SND_WAIT                                  EQU  00000001    186*
STACK_PC_POSITION                         EQU  00000050     54*  798  1023 
STCTX_REG_TBL00000               MON           00000038    765   791*
STCTX_REG_TBL00003               P             00000038    978  1004*
TCB_LINK                                  EQU  00000003    167*  930  1184 
TCB_PRIORITY                              EQU  00000002    166*
TCB_PROGNO                                EQU  00000001    165*
TCB_RESERVE                               EQU  00000006    170*
TCB_RUN_LINK                              EQU  00000004    168*
TCB_STACK_ADR                             EQU  0000000C    173*  819  1044 
TCB_STAT                                  EQU  00000000    164*  925  1179 
TCB_TBL_SIZE                              EQU  00000010    176*  813   920  1038  1174 
TCB_WAIT_PARA1                            EQU  00000008    171*
TCB_WAIT_PARA2                            EQU  0000000A    172*
TCB_WAIT_PARAM                            EQU  00000005    169*  927  1181 
TIB_END_ADR                               EQU  00000004    102*
TIB_PRIORITY                              EQU  00000009    104*
TIB_STACK_SIZE                            EQU  00000008    103*
TIB_START_ADR                             EQU  00000000    101*
TIB_TBL_SIZE                              EQU  0000000C     98*
TSK_INITIAL                               EQU  00000000     34*
TSK_INI_ADDR                              EQU  FFFFFC00     35*
WAIT                                      EQU  00000000    182*
WAIT_EVENT                                EQU  00000005    190*
WAIT_ONESHOT                              EQU  00000006    191*
WAIT_SEM                                  EQU  00000003    188*
WAIT_TIMER                                EQU  00000004    189*
*** SH SERIES ASSEMBLER Ver. 2.0 ***      01/28/98 12:58:15                                                              PAGE    24

*** CROSS REFERENCE LIST

NAME                             SECTION  ATTR VALUE             SEQUENCE

WORDNIL                                   EQU  0000FFFF    179*
_MON_MAX_ECB                              IMPT 00000000    709   964  1222 
_MON_MAX_LARGE_TCB                        IMPT 00000000    697 
_MON_MAX_MBXNO                            IMPT 00000000    708 
_MON_MAX_MCB                              IMPT 00000000    707 
_MON_MAX_SCB                              IMPT 00000000    705 
_MON_MAX_SEMNO                            IMPT 00000000    706 
_MON_MAX_SMALL_TCB                        IMPT 00000000    698 
_MON_MAX_TCB                              IMPT 00000000    699 
_MON_SIZE_LARGE_STACK                     IMPT 00000000    700 
_MON_SIZE_SMALL_STACK                     IMPT 00000000    701 
_MON_STACK_START_ADDR                     IMPT 00000000    702 
_MON_StackCheckTable                      IMPT 00000000    288 
_MON_StackCheckTable_p                    IMPT 00000000    696   866  1091 
_MON_TOP_LARGE_ADDR                       IMPT 00000000    703 
_MON_TOP_SMALL_ADDR                       IMPT 00000000    704 
_SYS_COM_PortStatus                       IMPT 00000000    722  1159 
_det_evt_erom                    P        EXPT 00000000    725   970*
_det_evt_irom                    MON      EXPT 00000000    724   757*
_ecb_p                                    IMPT 00000000    694   962  1220 
_mcb_p                                    IMPT 00000000    695 
_ready_func_vec                           IMPT 00000000    719   954  1212 
_real_run_tid                             IMPT 00000000    687   825   860  1050  1085 
_rescheduler_vec                          IMPT 00000000    718   956  1214 
_scb_p                                    IMPT 00000000    693 
_tcb_p                                    IMPT 00000000    692   827   960  1052  1218 
_tib                                      IMPT 00000000    691 
_top_ready_tid                            IMPT 00000000    688 
_wai_1shot_tid                            IMPT 00000000    690 
_wai_tsk_tid                              IMPT 00000000    689 
det_evt00_e                      P             000000A8   1097*
det_evt00_i                      MON           00000098    872*
det_evt01_e                      P             00000104   1115  1165*
det_evt01_i                      MON           000000DA    884   913*
det_evt02_e                      P             0000010C   1173* 1190 
det_evt02_i                      MON           000000E2    919*  936 
det_evt_ok_e                     P             00000130   1189  1193*
det_evt_ok_i                     MON           00000106    935   939*
ecbp_detevt_e                    P             00000154   1109  1219*
ecbp_detevt_i                    MON           00000128    879   961*
end_STSP_P00001                  MON           0000006C    820   829*
end_STSP_P00004                  P             0000007C   1045  1054*
err_det_evt_e                    P             00000138   1089  1105  1199*
err_det_evt_i                    MON           0000010E    864   877   945*
monitor_error                             IMPT 00000000    720   958  1216 
monitor_error_det_evt_e          P             0000014C   1200  1215*
monitor_error_det_evt_i          MON           00000120    946   957*
ready_func_det_evt_e             P             00000144   1182  1211*
ready_func_det_evt_i             MON           00000118    928   953*
real_run_tid_STKCHK_P00002       MON           0000008C    835   859*
real_run_tid_STKCHK_P00005       P             0000009C   1060  1084*
real_run_tid_STSP_P00001         MON           00000064    811   824*
real_run_tid_STSP_P00004         P             00000074   1036  1049*
rescheduler_det_evt_e            P             00000148   1194  1213*
*** SH SERIES ASSEMBLER Ver. 2.0 ***      01/28/98 12:58:15                                                              PAGE    25

*** CROSS REFERENCE LIST

NAME                             SECTION  ATTR VALUE             SEQUENCE

rescheduler_det_evt_i            MON           0000011C    940   955*
stack_chk_end_p00002             MON           00000098    851   868*
stack_chk_end_p00005             P             000000A8   1076  1093*
stack_chk_error_p00002           MON           00000086    847   853*
stack_chk_error_p00005           P             00000096   1072  1078*
stctx_reg_end00000               MON           0000003C    787   794*
stctx_reg_end00003               P             0000003C   1000  1007*
stk_chk_err_STKCHK_P00002        MON           00000090    854   863*
stk_chk_err_STKCHK_P00005        P             000000A0   1079  1088*
tcbp_STSP_P00001                 MON           00000068    815   826*
tcbp_STSP_P00004                 P             00000078   1040  1051*
tcbp_detevt_e                    P             00000150   1171  1217*
tcbp_detevt_i                    MON           00000124    917   959*
*** SH SERIES ASSEMBLER Ver. 2.0 ***      01/28/98 12:58:15                                                              PAGE    26

*** SECTION DATA LIST

SECTION                          ATTRIBUTE    SIZE             START

MON                              REL-CODE    000000130        
P                                REL-CODE    00000015C        
