*** SH SERIES ASSEMBLER Ver. 2.0 ***      01/26/98 22:01:18                                                              PAGE     1
PROGRAM NAME =

    1                               1     ;/*--------------------------------------------------------------------------*/
    2                               2     ;/*  プロジェクト : POPLAR/ANZU_L                                            */
    3                               3     ;/*  ファイル名   : schedule.src                                             */
    4                               4     ;/*  作成者       : 野瀬                                                     */
    5                               5     ;/*  日  付       : 1996/10/14                                               */
    6                               6     ;/*  概  要       : スケジュール、キュー管理                                 */
    7                               7     ;/*  修正履歴     :                                                          */
    8                               8     ;/*--------------------------------------------------------------------------*/
    9                               9     
   10                              10             .INCLUDE        "\src\atlanta\sh7043\define\def_mon.hdr"
   11                               1 I1  ;/*--------------------------------------------------------------------------*/
   12                               2 I1  ;/*  プロジェクト : RISC                                                     */
   13                               3 I1  ;/*  ファイル名   : def_mon.ih                                               */
   14                               4 I1  ;/*  作成者       : 野瀬                                                     */
   15                               5 I1  ;/*  日  付       : 95.11.01                                                 */
   16                               6 I1  ;/*  概  要       : モニタdefine定義                                         */
   17                               7 I1  ;/*  修正履歴     :                                                          */
   18                               8 I1  ;/*--------------------------------------------------------------------------*/
   19                               9 I1  ;-----------------------------------------------------------------------------
   20                              10 I1  ; ＣＣＲ マスクビット
   21                              11 I1  ;-----------------------------------------------------------------------------
   22          000000F0            12 I1  I_BIT_ON                .EQU    H'000000F0      ; 割込禁止 RISC
   23          0000030F            13 I1  I_BIT_OFF               .EQU    H'0000030F      ; 割込許可 RISC
   24                              14 I1  
   25                              15 I1  ;-----------------------------------------------------------------------------
   26                              16 I1  ; ワンショットタイマ値ＭＡＸ
   27                              17 I1  ;-----------------------------------------------------------------------------
   28          0000001A            18 I1  ONESHOT_VALUE_MAX               .EQU    26
   29                              19 I1  
   30                              20 I1  ;-----------------------------------------------------------------------------
   31                              21 I1  ; タスク イニシャルプログラムNo.
   32                              22 I1  ;-----------------------------------------------------------------------------
   33          00000000            23 I1  INIT_TID                .EQU    0
   34          00000000            24 I1  TSK_INITIAL             .EQU    0
   35          FFFFFC00            25 I1  TSK_INI_ADDR    .EQU    H'FFFFFC00              ; 初期化用スタック H'FFFFFC00-H'FFFFF000 3
   36                              26 I1                                                                                  ; def_mon.
   37                              27 I1  
   38                              28 I1  ;-----------------------------------------------------------------------------
   39                              29 I1  ; モニタ システム
   40                              30 I1  ;-----------------------------------------------------------------------------
   41                              31 I1  
   42          00000000            32 I1  FLAG_INIT_DATA                  .EQU    H'00000000      ; RISC
   43                              33 I1  
   44                              34 I1  ;TASK_STACK_START               .EQU    H'00809800
   45                              35 I1  
   46                              36 I1  ;LARGE_STACK_MAX                        .EQU    16                      ; RISC
   47                              37 I1  ;SMALL_STACK_MAX                        .EQU    32                      ; RISC
   48                              38 I1  ;TOTAL_STACK_MAX                        .EQU    (SMALL_STACK_MAX+LARGE_STACK_MAX)
   49                              39 I1  ;LARGE_STACK                            .EQU    512
   50                              40 I1  ;SMALL_STACK                            .EQU    256
   51                              41 I1  ;STACK_PUSH_SIZE                        .EQU    88                      ;       スタック退
   52                              42 I1  ;TOP_LARGE_ADDR                         .EQU    (TASK_STACK_START-(SMALL_STACK*SMALL_STACK
   53                              43 I1  ;TOP_SMALL_ADDR                         .EQU    (TASK_STACK_START-STACK_PUSH_SIZE)
   54          00000050            44 I1  STACK_PC_POSITION               .EQU    80
   55                              45 I1  ;STK_RTNVL_PT                   .EQU    76
   56                              46 I1  
   57                              47 I1  ;-----------------------------------------------------------------------------
*** SH SERIES ASSEMBLER Ver. 2.0 ***      01/26/98 22:01:18                                                              PAGE     2
PROGRAM NAME =

   58                              48 I1  ; TIB
   59                              49 I1  ;
   60                              50 I1  ; struct tib_table_data {
   61                              51 I1  ;       unsigned char *start_addr;
   62                              52 I1  ;       unsigned char *end_addr;
   63                              53 I1  ;       unsigned char stack_size;
   64                              54 I1  ;       unsigned char priority;
   65                              55 I1  ;       unsigned short reserve;
   66                              56 I1  ; };
   67                              57 I1  ;
   68                              58 I1  ;    ｮ｢｢｢｢｢｢｢｢｢｢｢ｲ
   69                              59 I1  ;  0 ､                      ､
   70                              60 I1  ;    ､                      ､
   71                              61 I1  ;  1 ､   タスクプログラム   ､
   72                              62 I1  ;    ､   スタートアドレス   ､
   73                              63 I1  ;  2 ､                      ､
   74                              64 I1  ;    ､                      ､
   75                              65 I1  ;  3 ､                      ､
   76                              66 I1  ;    ｾ｢｢｢｢｢｢｢｢｢｢｢ﾆ
   77                              67 I1  ;  4 ､                      ､
   78                              68 I1  ;    ､                      ､
   79                              69 I1  ;  5 ､   異常処理ルーチン   ､
   80                              70 I1  ;    ､   スタートアドレス   ､
   81                              71 I1  ;  6 ､                      ､
   82                              72 I1  ;    ､                      ､
   83                              73 I1  ;  7 ､                      ､
   84                              74 I1  ;    ｾ｢｢｢｢｢｢｢｢｢｢｢ﾆ
   85                              75 I1  ;  8 ､    スタックサイズ    ､  0:Large Stack  1:Small Stack
   86                              76 I1  ;    ｾ｢｢｢｢｢｢｢｢｢｢｢ﾆ
   87                              77 I1  ;  9 ､       優先順位       ､
   88                              78 I1  ;    ｾ｢｢｢｢｢｢｢｢｢｢｢ﾆ
   89                              79 I1  ; 10 ､       リザーブ       ､
   90                              80 I1  ;    ､                      ､
   91                              81 I1  ; 11 ､                      ､
   92                              82 I1  ;    ｶ｢｢｢｢｢｢｢｢｢｢｢ｺ
   93                              83 I1  ;
   94                              84 I1  ;      優先順位(0～255)
   95                              85 I1  ;      ※ 0を最も高い優先順位とします
   96                              86 I1  ;-----------------------------------------------------------------------------
   97                              87 I1  
   98          0000000C            88 I1  TIB_TBL_SIZE    .EQU    12
   99                              89 I1  
  100                              90 I1  ;-- オフセット --
  101          00000000            91 I1  TIB_START_ADR           .EQU    0
  102          00000004            92 I1  TIB_END_ADR                     .EQU    4
  103          00000008            93 I1  TIB_STACK_SIZE          .EQU    8
  104          00000009            94 I1  TIB_PRIORITY            .EQU    9
  105                              95 I1  
  106                              96 I1  ;-----------------------------------------------------------------------------
  107                              97 I1  ; TCB
  108                              98 I1  ;
  109                              99 I1  ; struct tcb_table_data {
  110                             100 I1  ;       unsigned char tsk_stat;
  111                             101 I1  ;       unsigned char prog_no;
  112                             102 I1  ;       unsigned char priority;
  113                             103 I1  ;       unsigned char tsk_link;
  114                             104 I1  ;       unsigned char run_link;
*** SH SERIES ASSEMBLER Ver. 2.0 ***      01/26/98 22:01:18                                                              PAGE     3
PROGRAM NAME =

  115                             105 I1  ;       unsigned char tsk_stat_tpo;
  116                             106 I1  ;       unsigned short reserve;         RISC追加 by T.Nose
  117                             107 I1  ;       unsigned long wait_param;
  118                             108 I1  ;       unsigned char *stack_addr;
  119                             109 I1  ; };
  120                             110 I1  ;
  121                             111 I1  ;    ｮ｢｢ﾎ｢｢｢｢｢｢｢｢ｲ
  122                             112 I1  ;  0 ､STS ､ WAIT時の原因   ､   STS           WAIT時の原因
  123                             113 I1  ;    ｾ｢｢ﾖ｢｢｢｢｢｢｢｢ﾆ   11 : 未使用    1 : 送信待ち
  124                             114 I1  ;  1 ､     プログラムNo.    ､   00 : WAIT      2 : 受信待ち
  125                             115 I1  ;    ｾ｢｢｢｢｢｢｢｢｢｢｢ﾆ   01 : READY     3 : セマフォ待ち
  126                             116 I1  ;  2 ､       優先順位       ､                  4 : タイマ待ち
  127                             117 I1  ;    ｾ｢｢｢｢｢｢｢｢｢｢｢ﾆ                  5 : イベントフラグ待ち
  128                             118 I1  ;  3 ､     タスクリンク     ､                  6 : ワンショットタイマ待ち
  129                             119 I1  ;    ｾ｢｢｢｢｢｢｢｢｢｢｢ﾆ
  130                             120 I1  ;  4 ､    強制ランタスク    ､
  131                             121 I1  ;    ｾ｢｢｢｢｢｢｢｢｢｢｢ﾆ
  132                             122 I1  ;  5 ､待ちタスクパラメータ a､
  133                             123 I1  ;    ｾ｢｢｢｢｢｢｢｢｢｢｢ﾆ
  134                             124 I1  ;  6 ､       リザーブ       ､  アドレス調整用 RISC追加 by T.Nose
  135                             125 I1  ;    ､                      ､
  136                             126 I1  ;  7 ､                      ､
  137                             127 I1  ;    ｾ｢｢｢｢｢｢｢｢｢｢｢ﾆ
  138                             128 I1  ;  8 ､                     b､  1.送信待ち
  139                             129 I1  ;    ､                      ､     a     : MBX No
  140                             130 I1  ;  9 ､                     c､     b～e  : 送信データアドレス
  141                             131 I1  ;    ､                      ､  2.受信待ち
  142                             132 I1  ; 10 ､                     d､     a     : MBX No
  143                             133 I1  ;    ､                      ､     b～e  : 受信データアドレス
  144                             134 I1  ; 11 ､                     e､  3.セマフォ待ち
  145                             135 I1  ;    ｾ｢｢｢｢｢｢｢｢｢｢｢ﾆ     a,d,e : 未使用
  146                             136 I1  ; 12 ､                      ､     b,c   : セマフォ No
  147                             137 I1  ;    ､                      ､  4.タイマ待ち
  148                             138 I1  ; 13 ､                      ､     a,d,e : 未使用
  149                             139 I1  ;    ､   スタックアドレス   ､     b,c   : タイマ値
  150                             140 I1  ; 14 ､                      ､  5.イベントフラグ待ち
  151                             141 I1  ;    ､                      ､     a     : EVENT No
  152                             142 I1  ; 15 ､                      ､     b～e  : 未使用
  153                             143 I1  ;    ｶ｢｢｢｢｢｢｢｢｢｢｢ｺ  6.ワンショットタイマ待ち
  154                             144 I1  ;                                   a～e  : 未使用
  155                             145 I1  
  156                             146 I1  
  157                             147 I1  
  158                             148 I1  
  159                             149 I1  ;      スタックアドレス  初期値 = (実際のアドレス - 32byte)
  160                             150 I1  ;
  161                             151 I1  ;-----------------------------------------------------------------------------
  162                             152 I1  
  163                             153 I1  ;-- オフセット --
  164          00000000           154 I1  TCB_STAT                        .EQU    0
  165          00000001           155 I1  TCB_PROGNO                      .EQU    1
  166          00000002           156 I1  TCB_PRIORITY            .EQU    2
  167          00000003           157 I1  TCB_LINK                        .EQU    3
  168          00000004           158 I1  TCB_RUN_LINK            .EQU    4
  169          00000005           159 I1  TCB_WAIT_PARAM          .EQU    5
  170          00000006           160 I1  TCB_RESERVE                     .EQU    6
  171          00000008           161 I1  TCB_WAIT_PARA1          .EQU    8
*** SH SERIES ASSEMBLER Ver. 2.0 ***      01/26/98 22:01:18                                                              PAGE     4
PROGRAM NAME =

  172          0000000A           162 I1  TCB_WAIT_PARA2          .EQU    10
  173          0000000C           163 I1  TCB_STACK_ADR           .EQU    12
  174                             164 I1  
  175                             165 I1  ;READY_TSK_MAX  .EQU    SMALL_STACK_MAX+LARGE_STACK_MAX
  176          00000010           166 I1  TCB_TBL_SIZE    .EQU    16
  177                             167 I1  
  178          000000FF           168 I1  NIL                             .EQU    H'ff
  179          0000FFFF           169 I1  WORDNIL                 .EQU    H'ffff
  180          FFFFFFFF           170 I1  LONGNIL                 .EQU    H'ffffffff
  181                             171 I1  
  182          00000000           172 I1  WAIT                    .EQU    H'00    ;RISC
  183          00000040           173 I1  READY                   .EQU    H'40    ;RISC
  184          000000C0           174 I1  NOT_USED                .EQU    H'C0    ;RISC
  185                             175 I1  
  186          00000001           176 I1  SND_WAIT                .EQU    H'01
  187          00000002           177 I1  RCV_WAIT                .EQU    H'02
  188          00000003           178 I1  WAIT_SEM                .EQU    H'03
  189          00000004           179 I1  WAIT_TIMER              .EQU    H'04
  190          00000005           180 I1  WAIT_EVENT              .EQU    H'05
  191          00000006           181 I1  WAIT_ONESHOT    .EQU    H'06
  192                             182 I1  
  193          000000FF           183 I1  ERROR                   .EQU    H'ff
  194                             184 I1  
  195                             185 I1  ;-----------------------------------------------------------------------------
  196                             186 I1  ; SCB
  197                             187 I1  ;
  198                             188 I1  ; struct scb_table_data {
  199                             189 I1  ;       unsigned char stat;
  200                             190 I1  ;       unsigned char tid;
  201                             191 I1  ; };
  202                             192 I1  ;
  203                             193 I1  ;    ｮ｢｢ﾎ｢｢｢｢｢｢｢｢ｲ
  204                             194 I1  ;  0 ､STS ､待ちタスクのTID ､
  205                             195 I1  ;    ｾ｢｢ﾖ｢｢｢｢｢｢｢｢ﾆ
  206                             196 I1  ;  1 ､   セマフォ獲得TID    ､
  207                             197 I1  ;    ｶ｢｢｢｢｢｢｢｢｢｢｢ｺ
  208                             198 I1  ;
  209                             199 I1  ;     STS
  210                             200 I1  ;          11 : 未使用
  211                             201 I1  ;          00 : セマフォ値=0
  212                             202 I1  ;          01 : セマフォ値=1
  213                             203 I1  ;
  214                             204 I1  ;     待ちタスクのTID
  215                             205 I1  ;          111111 : 待ちタスクなし
  216                             206 I1  ;
  217                             207 I1  ;-----------------------------------------------------------------------------
  218                             208 I1  
  219                             209 I1  ;SEMNO_MAX              .EQU    32
  220          00000002           210 I1  SCB_TBL_SIZE    .EQU    2
  221          0000007F           211 I1  SCB_INIT                .EQU    H'7F
  222                             212 I1  ;SCB_FREE               .EQU    H'3F
  223                             213 I1  
  224                             214 I1  ;MAX_SEMNO              .EQU    15      ; \src\atlanta\sh7043\define\def_semn.hに
  225                             215 I1                                                          ; 同一の定義有り。同値に保って下さ
  226                             216 I1  
  227                             217 I1  ;-- オフセット --
  228          00000000           218 I1  SCB_STAT                .EQU    0
*** SH SERIES ASSEMBLER Ver. 2.0 ***      01/26/98 22:01:18                                                              PAGE     5
PROGRAM NAME =

  229          00000001           219 I1  SCB_TID                 .EQU    1
  230                             220 I1  
  231                             221 I1  ;-----------------------------------------------------------------------------
  232                             222 I1  ; MCB
  233                             223 I1  ;
  234                             224 I1  ;    ｮ｢｢ﾎ｢｢｢｢｢｢ｲ
  235                             225 I1  ;    ､STS ､    TID     ､
  236                             226 I1  ;    ｶ｢｢ﾖ｢｢｢｢｢｢ｺ
  237                             227 I1  ;
  238                             228 I1  ;     STS                      TID
  239                             229 I1  ;     11 : 未使用              111111
  240                             230 I1  ;     10 : 待ちタスクなし      111111
  241                             231 I1  ;     00 : 送信待ちタスクあり  xxxxxx  待ちタスクの中で最も優先順位の高いTID
  242                             232 I1  ;     01 : 受信待ちタスクあり  xxxxxx  待ちタスクの中で最も優先順位の高いTID
  243                             233 I1  ;
  244                             234 I1  ;-----------------------------------------------------------------------------
  245                             235 I1  
  246                             236 I1  ;MBXNO_MAX              .EQU    256
  247                             237 I1  
  248                             238 I1  ;Task MAX Change T.Nose 1996/10/31
  249          0000007F           239 I1  NO_WAIMBX               .EQU    H'7F    ;<- H'BF
  250                             240 I1  ;SND_MBX                        .EQU    H'00
  251                             241 I1  ;RCV_MBX                        .EQU    H'40
  252                             242 I1  
  253                             243 I1  ;MAX_MBXNO              .EQU    70      ; \src\atlanta\sh7043\define\def_mbxn.h に
  254                             244 I1                                                          ; 同一の定義有り。同値に保って下さ
  255                             245 I1  
  256                             246 I1  ;-----------------------------------------------------------------------------
  257                             247 I1  ; ECB
  258                             248 I1  ;
  259                             249 I1  ;    ｮ｢｢｢｢｢｢｢｢｢ｲ
  260                             250 I1  ;    ､       TID        ､
  261                             251 I1  ;    ｶ｢｢｢｢｢｢｢｢｢ｺ
  262                             252 I1  ;
  263                             253 I1  ;     TID
  264                             254 I1  ;     11111111 : 待ちタスクなし
  265                             255 I1  ;     xxxxxxxx : 待ちタスクのTID
  266                             256 I1  ;
  267                             257 I1  ;-----------------------------------------------------------------------------
  268                             258 I1  
  269                             259 I1  ;;EVENT_MAX             .EQU    74
  270                             260 I1  ;EVENT_MAX              .EQU    94     ; Changed with def_evtn.h for R288F event by H.Kubo
  271                             261 I1  
  272                             262 I1  ;-----------------------------------------------------------------------------
  273                             263 I1  ; Ｃソースモニター用
  274                             264 I1  ;-----------------------------------------------------------------------------
  275          00000001           265 I1  MON_SUCCESS             .EQU    1       ;モニター本体処理の戻値（結果）
  276          00000000           266 I1  MON_FAILURE             .EQU    0
  277                             267 I1  
  278                              11             .INCLUDE        "\src\atlanta\sh7043\define\mon_mac.hdr"
  279                               1 I1  ;/*--------------------------------------------------------------------------*/
  280                               2 I1  ;/*  プロジェクト : POPLAR/ANZU_L                                            */
  281                               3 I1  ;/*  ファイル名   : mon_mac.hdr                                              */
  282                               4 I1  ;/*  作成者       : 野瀬                                                     */
  283                               5 I1  ;/*  日  付       : 1996/10/14                                               */
  284                               6 I1  ;/*  概  要       : モニタマクロ定義                                         */
  285                               7 I1  ;/*  修正履歴     :                                                          */
*** SH SERIES ASSEMBLER Ver. 2.0 ***      01/26/98 22:01:18                                                              PAGE     6
PROGRAM NAME =

  286                               8 I1  ;/*--------------------------------------------------------------------------*/
  287                               9 I1  
  288                              10 I1          .IMPORT         _MON_StackCheckTable
  289                              11 I1  
  290                              12 I1  ;-----------------------------------------------------------------------------
  291                              13 I1  ;  アセンブラ　マクロ定義
  292                              14 I1  ;-----------------------------------------------------------------------------
  293                              15 I1  ;
  294                              16 I1  ;/*****************************************************************************
  295                              17 I1  ;       module          :[ｺﾝﾃｷｽﾄを保存する（割込み禁止操作付き）]
  296                              18 I1  ;       function        :[
  297                              19 I1  ;               1.      割込禁止にする
  298                              20 I1  ;               2.      汎用ﾚｼﾞｽﾀ(R0ｰR14)､ｺﾝﾄﾛｰﾙﾚｼﾞｽﾀ(SR､GBR､VBR)､ｼｽﾃﾑﾚｼﾞｽﾀ(MACH､MACL､PR)
  299                              21 I1  ;                       ｽﾀｯｸへｾｰﾌﾞする
  300                              22 I1  ;       ]
  301                              23 I1  ;       return          :[なし]
  302                              24 I1  ;       common          :[]
  303                              25 I1  ;       comment         :[]
  304                              26 I1  ;       machine         :[SH7043]
  305                              27 I1  ;       language        :[ASMSH]
  306                              28 I1  ;       keyword         :[MON]
  307                              29 I1  ;       date            :[1995/10/25]
  308                              30 I1  ;       author          :[野瀬敏弘]
  309                              31 I1  ;*****************************************************************************/
  310                              32 I1  
  311                              33 I1          .MACRO  STCTX_REG
  312                              34 I1  
  313                              35 I1          MOV.L           R0,@-R15                                                ;PUSH.L R0
  314                              36 I1          MOV.L           R1,@-R15                                                ;PUSH.L R1
  315                              37 I1          STC                     SR,R0
  316                              38 I1          MOV.L           STCTX_REG_TBL\@,R1
  317                              39 I1          OR                      R1,R0
  318                              40 I1          LDC                     R0,SR                                                   ;
  319                              41 I1          MOV.L           R2,@-R15                                                ;PUSH.L R2
  320                              42 I1          MOV.L           R3,@-R15                                                ;PUSH.L R3
  321                              43 I1          MOV.L           R4,@-R15                                                ;PUSH.L R4
  322                              44 I1          MOV.L           R5,@-R15                                                ;PUSH.L R5
  323                              45 I1          MOV.L           R6,@-R15                                                ;PUSH.L R6
  324                              46 I1          MOV.L           R7,@-R15                                                ;PUSH.L R7
  325                              47 I1          MOV.L           R8,@-R15                                                ;PUSH.L R8
  326                              48 I1          MOV.L           R9,@-R15                                                ;PUSH.L R9
  327                              49 I1          MOV.L           R10,@-R15                                               ;PUSH.L R1
  328                              50 I1          MOV.L           R11,@-R15                                               ;PUSH.L R1
  329                              51 I1          MOV.L           R12,@-R15                                               ;PUSH.L R1
  330                              52 I1          MOV.L           R13,@-R15                                               ;PUSH.L R1
  331                              53 I1          MOV.L           R14,@-R15                                               ;PUSH.L R1
  332                              54 I1          STC.L           GBR,@-R15                                               ;PUSH.L GB
  333                              55 I1          STC.L           VBR,@-R15                                               ;PUSH.L VB
  334                              56 I1          STS.L           MACH,@-R15                                              ;PUSH.L MA
  335                              57 I1          STS.L           MACL,@-R15                                              ;PUSH.L MA
  336                              58 I1          STS.L           PR,@-R15                                                ;PUSH.L PR
  337                              59 I1  
  338                              60 I1          BRA                     stctx_reg_end\@
  339                              61 I1          NOP
  340                              62 I1  
  341                              63 I1          .ALIGN 4
  342                              64 I1  STCTX_REG_TBL\@:
*** SH SERIES ASSEMBLER Ver. 2.0 ***      01/26/98 22:01:18                                                              PAGE     7
PROGRAM NAME =

  343                              65 I1          .DATA.L         I_BIT_ON
  344                              66 I1  
  345                              67 I1  stctx_reg_end\@:
  346                              68 I1  
  347                              69 I1          .ENDM
  348                              70 I1  
  349                              71 I1  ;/*****************************************************************************
  350                              72 I1  ;       module          :[ｺﾝﾃｷｽﾄを保存する（割込み禁止操作なし）]
  351                              73 I1  ;       function        :[
  352                              74 I1  ;               1.      汎用ﾚｼﾞｽﾀ(R0ｰR14)､ｺﾝﾄﾛｰﾙﾚｼﾞｽﾀ(SR､GBR､VBR)､ｼｽﾃﾑﾚｼﾞｽﾀ(MACH､MACL､PR)
  353                              75 I1  ;                       ｽﾀｯｸへｾｰﾌﾞする
  354                              76 I1  ;       ]
  355                              77 I1  ;       return          :[なし]
  356                              78 I1  ;       common          :[]
  357                              79 I1  ;       comment         :[]
  358                              80 I1  ;       machine         :[SH7043]
  359                              81 I1  ;       language        :[ASMSH]
  360                              82 I1  ;       keyword         :[MON]
  361                              83 I1  ;       date            :[1996/11/12]
  362                              84 I1  ;       author          :[野瀬敏弘]
  363                              85 I1  ;*****************************************************************************/
  364                              86 I1  
  365                              87 I1          .MACRO  STCTX_REG_INT
  366                              88 I1  
  367                              89 I1          MOV.L           R0,@-R15                                                ;PUSH.L R0
  368                              90 I1          MOV.L           R1,@-R15                                                ;PUSH.L R1
  369                              91 I1          MOV.L           R2,@-R15                                                ;PUSH.L R2
  370                              92 I1          MOV.L           R3,@-R15                                                ;PUSH.L R3
  371                              93 I1          MOV.L           R4,@-R15                                                ;PUSH.L R4
  372                              94 I1          MOV.L           R5,@-R15                                                ;PUSH.L R5
  373                              95 I1          MOV.L           R6,@-R15                                                ;PUSH.L R6
  374                              96 I1          MOV.L           R7,@-R15                                                ;PUSH.L R7
  375                              97 I1          MOV.L           R8,@-R15                                                ;PUSH.L R8
  376                              98 I1          MOV.L           R9,@-R15                                                ;PUSH.L R9
  377                              99 I1          MOV.L           R10,@-R15                                               ;PUSH.L R1
  378                             100 I1          MOV.L           R11,@-R15                                               ;PUSH.L R1
  379                             101 I1          MOV.L           R12,@-R15                                               ;PUSH.L R1
  380                             102 I1          MOV.L           R13,@-R15                                               ;PUSH.L R1
  381                             103 I1          MOV.L           R14,@-R15                                               ;PUSH.L R1
  382                             104 I1          STC.L           GBR,@-R15                                               ;PUSH.L GB
  383                             105 I1          STC.L           VBR,@-R15                                               ;PUSH.L VB
  384                             106 I1          STS.L           MACH,@-R15                                              ;PUSH.L MA
  385                             107 I1          STS.L           MACL,@-R15                                              ;PUSH.L MA
  386                             108 I1          STS.L           PR,@-R15                                                ;PUSH.L PR
  387                             109 I1  
  388                             110 I1          .ENDM
  389                             111 I1  
  390                             112 I1  ;/*****************************************************************************
  391                             113 I1  ;       module          :[スタックチェック]
  392                             114 I1  ;       function        :[
  393                             115 I1  ;       ]
  394                             116 I1  ;       return          :[なし]
  395                             117 I1  ;       common          :[]
  396                             118 I1  ;       comment         :[
  397                             119 I1  ;
  398                             120 I1  ;               内部使用レジスタ
  399                             121 I1  ;                       R0 R12 R13 R14
*** SH SERIES ASSEMBLER Ver. 2.0 ***      01/26/98 22:01:18                                                              PAGE     8
PROGRAM NAME =

  400                             122 I1  ;               エラー処理時のみ
  401                             123 I1  ;                       R1 R2
  402                             124 I1  ;
  403                             125 I1  ;                       UDWORD MON_StackCheckTable 4ﾊﾞｲﾄｻｲｽﾞ
  404                             126 I1  ;
  405                             127 I1  ;       ]
  406                             128 I1  ;       machine         :[SH7043]
  407                             129 I1  ;       language        :[ASMSH]
  408                             130 I1  ;       keyword         :[MON]
  409                             131 I1  ;       date            :[1995/10/26]
  410                             132 I1  ;       author          :[野瀬敏弘]
  411                             133 I1  ;*****************************************************************************/
  412                             134 I1  
  413                             135 I1          .MACRO  STACK_CHECK     ERRJUMP
  414                             136 I1  
  415                             137 I1          MOV.L           real_run_tid_STKCHK\@,R12
  416                             138 I1          MOV.B           @R12,R13
  417                             139 I1          EXTU.B          R13,R13                                                 ; R13 = re
  418                             140 I1          SHLL2           R13
  419                             141 I1          MOV.L           MON_StackCheckTable_STKCHK\@,R0
  420                             142 I1          MOV.L           @(R0,R13),R14                                   ; R14 = MON_StackC
  421                             143 I1          CMP/HS          R14,R15
  422                             144 I1          BT                      stack_chk_error\@                               ; SP >= R1
  423                             145 I1          ADD                     #4,R13
  424                             146 I1          MOV.L           @(R0,R13),R14                                   ; R14 = MON_StackC
  425                             147 I1          CMP/HS          R14,R15
  426                             148 I1          BT                      stack_chk_end\@                                 ; SP >= R1
  427                             149 I1  
  428                             150 I1  stack_chk_error\@:
  429                             151 I1          MOV.L           stk_chk_err_STKCHK\@,R1
  430                             152 I1          MOV.L           stk_chk_err_STKCHK\@+4,R2
  431                             153 I1          JMP                     @R2
  432                             154 I1          NOP
  433                             155 I1  
  434                             156 I1          .ALIGN 4
  435                             157 I1  real_run_tid_STKCHK\@:
  436                             158 I1          .DATA.L         _real_run_tid
  437                             159 I1  MON_StackCheckTable_STKCHK\@:
  438                             160 I1          .DATA.L         _MON_StackCheckTable
  439                             161 I1  stk_chk_err_STKCHK\@:
  440                             162 I1          .DATA.L         H'FFFFFFFF
  441                             163 I1          .DATA.L         \ERRJUMP
  442                             164 I1  
  443                             165 I1  stack_chk_end\@
  444                             166 I1  
  445                             167 I1          .ENDM
  446                             168 I1  
  447                             169 I1  
  448                             170 I1  ;/*****************************************************************************
  449                             171 I1  ;       module          :[レジスタの復帰]
  450                             172 I1  ;       function        :[
  451                             173 I1  ;       ]
  452                             174 I1  ;       return          :[なし]
  453                             175 I1  ;       common          :[]
  454                             176 I1  ;       comment         :[
  455                             177 I1  ;       ]
  456                             178 I1  ;       machine         :[SH7043]
*** SH SERIES ASSEMBLER Ver. 2.0 ***      01/26/98 22:01:18                                                              PAGE     9
PROGRAM NAME =

  457                             179 I1  ;       language        :[ASMSH]
  458                             180 I1  ;       keyword         :[MON]
  459                             181 I1  ;       date            :[1995/11/15]
  460                             182 I1  ;       author          :[野瀬敏弘]
  461                             183 I1  ;*****************************************************************************/
  462                             184 I1  
  463                             185 I1          .MACRO  RSTR_REG
  464                             186 I1  
  465                             187 I1          LDS.L   @R15+,PR                        ;POP.L  PR
  466                             188 I1          LDS.L   @R15+,MACL                      ;POP.L  MACL
  467                             189 I1          LDS.L   @R15+,MACH                      ;POP.L  MACH
  468                             190 I1          LDC.L   @R15+,VBR                       ;POP.L  VBR
  469                             191 I1          LDC.L   @R15+,GBR                       ;POP.L  GBR
  470                             192 I1          MOV.L   @R15+,R14                       ;POP.L  R14
  471                             193 I1          MOV.L   @R15+,R13                       ;POP.L  R13
  472                             194 I1          MOV.L   @R15+,R12                       ;POP.L  R12
  473                             195 I1          MOV.L   @R15+,R11                       ;POP.L  R11
  474                             196 I1          MOV.L   @R15+,R10                       ;POP.L  R10
  475                             197 I1          MOV.L   @R15+,R9                        ;POP.L  R9
  476                             198 I1          MOV.L   @R15+,R8                        ;POP.L  R8
  477                             199 I1          MOV.L   @R15+,R7                        ;POP.L  R7
  478                             200 I1          MOV.L   @R15+,R6                        ;POP.L  R6
  479                             201 I1          MOV.L   @R15+,R5                        ;POP.L  R5
  480                             202 I1          MOV.L   @R15+,R4                        ;POP.L  R4
  481                             203 I1          MOV.L   @R15+,R3                        ;POP.L  R3
  482                             204 I1          MOV.L   @R15+,R2                        ;POP.L  R2
  483                             205 I1          MOV.L   @R15+,R1                        ;POP.L  R1
  484                             206 I1          MOV.L   @R15+,R0                        ;POP.L  R0
  485                             207 I1  
  486                             208 I1          .ENDM
  487                             209 I1  
  488                             210 I1  ;/*****************************************************************************
  489                             211 I1  ;       module          :[スタックポインタをＴＣＢにセーブする]
  490                             212 I1  ;       function        :[
  491                             213 I1  ;       ]
  492                             214 I1  ;       return          :[なし]
  493                             215 I1  ;       common          :[]
  494                             216 I1  ;       comment         :[
  495                             217 I1  ;       ]
  496                             218 I1  ;       machine         :[SH7043]
  497                             219 I1  ;       language        :[ASMSH]
  498                             220 I1  ;       keyword         :[MON]
  499                             221 I1  ;       date            :[1996/02/08]
  500                             222 I1  ;       author          :[野瀬敏弘]
  501                             223 I1  ;*****************************************************************************/
  502                             224 I1  
  503                             225 I1          .MACRO  STSP_REG
  504                             226 I1  
  505                             227 I1          MOV.L   real_run_tid_STKCHK\@,R2
  506                             228 I1          MOV.B   @R2,R1
  507                             229 I1          MOV             #TCB_TBL_SIZE,R8
  508                             230 I1          MULU    R1,R8                                                   ; real_run_tid * T
  509                             231 I1          MOV.L   tcb_STKCHK\@,R0
  510                             232 I1          STS             MACL,R2
  511                             233 I1          ADD             R2,R0
  512                             234 I1          MOV.L   R15,@(TCB_STACK_ADR,R0)                                 ; SPセーブ
  513                             235 I1          BRA             save_SP_end\@
*** SH SERIES ASSEMBLER Ver. 2.0 ***      01/26/98 22:01:18                                                              PAGE    10
PROGRAM NAME =

  514                             236 I1          NOP
  515                             237 I1  
  516                             238 I1          .ALIGN 4
  517                             239 I1  real_run_tid_STKCHK\@:
  518                             240 I1          .DATA.L         _real_run_tid
  519                             241 I1  tcb_STKCHK\@:
  520                             242 I1          .DATA.L         _tcb
  521                             243 I1  
  522                             244 I1  save_SP_end\@
  523                             245 I1  
  524                             246 I1          .ENDM
  525                             247 I1  
  526                             248 I1  ;/*****************************************************************************
  527                             249 I1  ;       module          :[スタックチェック]
  528                             250 I1  ;       function        :[
  529                             251 I1  ;       ]
  530                             252 I1  ;       return          :[なし]
  531                             253 I1  ;       common          :[
  532                             254 I1  ;               スタックチェックテーブルにはポインタによる間接アドレス参照で
  533                             255 I1  ;               アクセスします
  534                             256 I1  ;       ]
  535                             257 I1  ;       comment         :[
  536                             258 I1  ;
  537                             259 I1  ;               内部使用レジスタ
  538                             260 I1  ;                       R0 R12 R13 R14
  539                             261 I1  ;               エラー処理時のみ
  540                             262 I1  ;                       R1 R2
  541                             263 I1  ;
  542                             264 I1  ;                       UDWORD MON_StackCheckTable_p 4ﾊﾞｲﾄｻｲｽﾞ
  543                             265 I1  ;
  544                             266 I1  ;       ]
  545                             267 I1  ;       machine         :[SH7043]
  546                             268 I1  ;       language        :[ASMSH]
  547                             269 I1  ;       keyword         :[MON]
  548                             270 I1  ;       date            :[1997/04/16]
  549                             271 I1  ;       author          :[野瀬敏弘]
  550                             272 I1  ;*****************************************************************************/
  551                             273 I1  
  552                             274 I1          .MACRO  STACK_CHECK_P   ERRJUMP
  553                             275 I1  
  554                             276 I1          MOV.L           real_run_tid_STKCHK_P\@,R12
  555                             277 I1          MOV.B           @R12,R13
  556                             278 I1          EXTU.B          R13,R13                                                 ; R13 = re
  557                             279 I1          SHLL2           R13
  558                             280 I1  
  559                             281 I1  ;       MOV.L           MON_StackCheckTable_STKCHK\@,R0
  560                             282 I1  ;       下の２行に変更
  561                             283 I1          MOV.L           MON_StackCheckTable_p_STKCHK_P\@,R0
  562                             284 I1          MOV.L           @R0,R0
  563                             285 I1  
  564                             286 I1          MOV.L           @(R0,R13),R14                                   ; R14 = MON_StackC
  565                             287 I1          CMP/HS          R14,R15
  566                             288 I1          BT                      stack_chk_error_p\@                             ; SP >= R1
  567                             289 I1          ADD                     #4,R13
  568                             290 I1          MOV.L           @(R0,R13),R14                                   ; R14 = MON_StackC
  569                             291 I1          CMP/HS          R14,R15
  570                             292 I1          BT                      stack_chk_end_p\@                                       ;
*** SH SERIES ASSEMBLER Ver. 2.0 ***      01/26/98 22:01:18                                                              PAGE    11
PROGRAM NAME =

  571                             293 I1  
  572                             294 I1  stack_chk_error_p\@:
  573                             295 I1          MOV.L           stk_chk_err_STKCHK_P\@,R1
  574                             296 I1          JMP                     @R1
  575                             297 I1          NOP
  576                             298 I1  
  577                             299 I1          .ALIGN 4
  578                             300 I1  real_run_tid_STKCHK_P\@:
  579                             301 I1          .DATA.L         _real_run_tid
  580                             302 I1  ;MON_StackCheckTable_STKCHK\@:
  581                             303 I1  ;       .DATA.L         _MON_StackCheckTable
  582                             304 I1  stk_chk_err_STKCHK_P\@:
  583                             305 I1          .DATA.L         \ERRJUMP
  584                             306 I1  MON_StackCheckTable_p_STKCHK_P\@:
  585                             307 I1          .DATA.L         _MON_StackCheckTable_p
  586                             308 I1  
  587                             309 I1  stack_chk_end_p\@
  588                             310 I1  
  589                             311 I1          .ENDM
  590                             312 I1  
  591                             313 I1  ;/*****************************************************************************
  592                             314 I1  ;       module          :[スタックポインタをＴＣＢにセーブする]
  593                             315 I1  ;       function        :[
  594                             316 I1  ;       ]
  595                             317 I1  ;       return          :[なし]
  596                             318 I1  ;       common          :[]
  597                             319 I1  ;       comment         :[
  598                             320 I1  ;               ＴＣＢにはポインタによる間接アドレス参照でアクセスします
  599                             321 I1  ;       ]
  600                             322 I1  ;       machine         :[SH7043]
  601                             323 I1  ;       language        :[ASMSH]
  602                             324 I1  ;       keyword         :[MON]
  603                             325 I1  ;       date            :[1997/04/16]
  604                             326 I1  ;       author          :[野瀬敏弘]
  605                             327 I1  ;*****************************************************************************/
  606                             328 I1  
  607                             329 I1          .MACRO  STSP_REG_P
  608                             330 I1  
  609                             331 I1          MOV.L   real_run_tid_STSP_P\@,R2
  610                             332 I1          MOV.B   @R2,R1
  611                             333 I1          MOV             #TCB_TBL_SIZE,R8
  612                             334 I1          MULU    R1,R8                                                   ; real_run_tid * T
  613                             335 I1          MOV.L   tcbp_STSP_P\@,R0
  614                             336 I1          MOV.L   @R0,R0
  615                             337 I1          STS             MACL,R2
  616                             338 I1          ADD             R2,R0
  617                             339 I1          MOV.L   R15,@(TCB_STACK_ADR,R0)                                 ; SPセーブ
  618                             340 I1          BRA             end_STSP_P\@
  619                             341 I1          NOP
  620                             342 I1  
  621                             343 I1          .ALIGN 4
  622                             344 I1  real_run_tid_STSP_P\@:
  623                             345 I1          .DATA.L         _real_run_tid
  624                             346 I1  tcbp_STSP_P\@:
  625                             347 I1          .DATA.L         _tcb_p
  626                             348 I1  
  627                             349 I1  end_STSP_P\@
*** SH SERIES ASSEMBLER Ver. 2.0 ***      01/26/98 22:01:18                                                              PAGE    12
PROGRAM NAME =

  628                             350 I1  
  629                             351 I1          .ENDM
  630                             352 I1  
  631                             353 I1  ;/*****************************************************************************
  632                             354 I1  ;       module          :[割込み禁止]
  633                             355 I1  ;       function        :[]
  634                             356 I1  ;       return          :[なし]
  635                             357 I1  ;       common          :[]
  636                             358 I1  ;       comment         :[]
  637                             359 I1  ;       machine         :[SH7043]
  638                             360 I1  ;       language        :[ASMSH]
  639                             361 I1  ;       keyword         :[MON]
  640                             362 I1  ;       date            :[1998/01/26]
  641                             363 I1  ;       author          :[野瀬敏弘]
  642                             364 I1  ;*****************************************************************************/
  643                             365 I1  
  644                             366 I1          .MACRO  INTDIS
  645                             367 I1  
  646                             368 I1          MOV.L           R0,@-R15                                                ;PUSH.L R0
  647                             369 I1          MOV.L           R1,@-R15                                                ;PUSH.L R1
  648                             370 I1          STC                     SR,R0
  649                             371 I1          MOV.L           INTDIS_TBL\@,R1
  650                             372 I1          OR                      R1,R0
  651                             373 I1          LDC                     R0,SR                                                   ;
  652                             374 I1          MOV.L           @R15+,R1                                                ;POP.L  R1
  653                             375 I1          MOV.L           @R15+,R0                                                ;POP.L  R0
  654                             376 I1          BRA                     INTDIS_END\@
  655                             377 I1          NOP
  656                             378 I1          .ALIGN 4
  657                             379 I1  INTDIS_TBL\@:
  658                             380 I1          .DATA.L         I_BIT_ON
  659                             381 I1  INTDIS_END\@:
  660                             382 I1  
  661                             383 I1          .ENDM
  662                              12             .INCLUDE        "\src\atlanta\sh7043\ext_v\extv_mon.hdr"
  663                               1 I1  ;/*--------------------------------------------------------------------------*/
  664                               2 I1  ;/*  プロジェクト : POPLAR/ANZU_L                                            */
  665                               3 I1  ;/*  ファイル名   : extv_mon.hdr                                             */
  666                               4 I1  ;/*  作成者       : 野瀬敏弘                                                 */
  667                               5 I1  ;/*  日  付       : 1996/10/14                                               */
  668                               6 I1  ;/*  概  要       : モニタテーブル外部参照                                   */
  669                               7 I1  ;/*  修正履歴     :                                                          */
  670                               8 I1  ;/*--------------------------------------------------------------------------*/
  671                               9 I1  
  672                              10 I1          .IMPORT         _real_run_tid
  673                              11 I1          .IMPORT         _top_ready_tid
  674                              12 I1          .IMPORT         _wai_tsk_tid
  675                              13 I1          .IMPORT         _wai_1shot_tid
  676                              14 I1          .IMPORT         _tib
  677                              15 I1          .IMPORT         _tcb_p
  678                              16 I1          .IMPORT         _scb_p
  679                              17 I1          .IMPORT         _ecb_p
  680                              18 I1          .IMPORT         _mcb_p
  681                              19 I1          .IMPORT         _MON_StackCheckTable_p
  682                              20 I1          .IMPORT         _MON_MAX_LARGE_TCB
  683                              21 I1          .IMPORT         _MON_MAX_SMALL_TCB
  684                              22 I1          .IMPORT         _MON_MAX_TCB
*** SH SERIES ASSEMBLER Ver. 2.0 ***      01/26/98 22:01:18                                                              PAGE    13
PROGRAM NAME =

  685                              23 I1          .IMPORT         _MON_SIZE_LARGE_STACK
  686                              24 I1          .IMPORT         _MON_SIZE_SMALL_STACK
  687                              25 I1          .IMPORT         _MON_STACK_START_ADDR
  688                              26 I1          .IMPORT         _MON_TOP_LARGE_ADDR
  689                              27 I1          .IMPORT         _MON_TOP_SMALL_ADDR
  690                              28 I1          .IMPORT         _MON_MAX_SCB
  691                              29 I1          .IMPORT         _MON_MAX_SEMNO
  692                              30 I1          .IMPORT         _MON_MAX_MCB
  693                              31 I1          .IMPORT         _MON_MAX_MBXNO
  694                              32 I1          .IMPORT         _MON_MAX_ECB
  695                              33 I1  
  696                              34 I1  ; 以下の外部参照宣言は後程削除します
  697                              35 I1  ;       .IMPORT         _MON_DebugSwitch
  698                              36 I1  ;       .IMPORT         _tcb
  699                              37 I1  ;       .IMPORT         _scb
  700                              38 I1  ;       .IMPORT         _ecb
  701                              39 I1  ;       .IMPORT         _mcb
  702                              13     
  703                              14             .EXPORT         _rescheduler_irom
  704                              15             .EXPORT         _rescheduler_erom
  705                              16     
  706                              17             ; 割込み禁止時間測定 T.Nose 1998/01/17
  707                              18     ;       .IMPORT         _MON_IsIntEnable
  708                              19     ;       .IMPORT         _SYS_COM_PortStatus
  709                              20     
  710                              21     ;/*****************************************************************************
  711                              22     ;       module          :[スケジューラ]
  712                              23     ;       function        :[
  713                              24     ;               1. _real_run_tidと_top_ready_tidを参照してスイッチングするかを
  714                              25     ;                   決定します
  715                              26     ;               2. _real_run_tid ≠ _top_ready_tid のとき,タスクのスイッチングを
  716                              27     ;                  行います
  717                              28     ;       ]
  718                              29     ;       return          :[なし]
  719                              30     ;       common          :[_read_run_tid, _top_ready_tid, _tcb]
  720                              31     ;       condition       :[]
  721                              32     ;       comment         :[
  722                              33     ;               引数レジスタ
  723                              34     ;                       無し
  724                              35     ;               内部使用レジスタ
  725                              36     ;                       R0 R1 R2 R3 R4 R5 R6
  726                              37     ;       ]
  727                              38     ;       machine         :[SH1]
  728                              39     ;       language        :[ASM38(V)]
  729                              40     ;       keyword         :[MON]
  730                              41     ;       date            :[1995/10/18]
  731                              42     ;       author          :[野瀬敏弘]
  732                              43     ;*****************************************************************************/
  733                              44     ;/**************************/
  734                              45     ;/* ＳＨ７０４３内蔵ＲＯＭ */
  735                              46     ;/**************************/
  736 00000000                     47             .SECTION        MON,CODE,ALIGN=4
  737 00000000                     48     _rescheduler_irom:
  738 00000000 D112                49             MOV             real_run_tid_rescheduler_i,R1
  739 00000002 6310                50             MOV.B   @R1,R3                          ;MOV.B  @_real_run_tid,R1L @R1->R3符号拡張
  740 00000004 D212                51             MOV             top_ready_tid_rescheduler_i,R2
  741 00000006 6420                52             MOV.B   @R2,R4                          ;MOV.B  @_top_ready_tid,R2L     @R2->R4符
*** SH SERIES ASSEMBLER Ver. 2.0 ***      01/26/98 22:01:18                                                              PAGE    14
PROGRAM NAME =

  742 00000008 3430                53             CMP/EQ  R3,R4                           ;CMP.B  R1L,R2L
  743 0000000A 8901                54             BT              resch01_i                               ;遅延無し
  744 0000000C 2140                55             MOV.B   R4,@R1                          ;top_ready_tid = real_run_tid
  745 0000000E 6343                56             MOV             R4,R3
  746 00000010                     57     resch01_i:
  747 00000010 D510                58             MOV.L   TCB_TBL_SIZE_rescheduler_i,R5
  748 00000012 253E                59             MULU    R3,R5
  749 00000014 061A                60             STS             MACL,R6
  750 00000016 D010                61             MOV.L   tcbp_rescheduler_i,R0
  751 00000018 6002                62             MOV.L   @R0,R0
  752 0000001A 700C                63             ADD             #TCB_STACK_ADR,R0
  753 0000001C 0F6E                64             MOV.L   @(R0,R6),R15
  754                              65     
  755                              66     ;---------------------------------------------------------
  756                              67             RSTR_REG                        ; ﾏｸﾛ ﾚｼﾞｽﾀﾎﾟｯﾌﾟ
  757                                 M   
  758 0000001E 4F26                   M           LDS.L   @R15+,PR                        ;POP.L  PR
  759 00000020 4F16                   M           LDS.L   @R15+,MACL                      ;POP.L  MACL
  760 00000022 4F06                   M           LDS.L   @R15+,MACH                      ;POP.L  MACH
  761 00000024 4F27                   M           LDC.L   @R15+,VBR                       ;POP.L  VBR
  762 00000026 4F17                   M           LDC.L   @R15+,GBR                       ;POP.L  GBR
  763 00000028 6EF6                   M           MOV.L   @R15+,R14                       ;POP.L  R14
  764 0000002A 6DF6                   M           MOV.L   @R15+,R13                       ;POP.L  R13
  765 0000002C 6CF6                   M           MOV.L   @R15+,R12                       ;POP.L  R12
  766 0000002E 6BF6                   M           MOV.L   @R15+,R11                       ;POP.L  R11
  767 00000030 6AF6                   M           MOV.L   @R15+,R10                       ;POP.L  R10
  768 00000032 69F6                   M           MOV.L   @R15+,R9                        ;POP.L  R9
  769 00000034 68F6                   M           MOV.L   @R15+,R8                        ;POP.L  R8
  770 00000036 67F6                   M           MOV.L   @R15+,R7                        ;POP.L  R7
  771 00000038 66F6                   M           MOV.L   @R15+,R6                        ;POP.L  R6
  772 0000003A 65F6                   M           MOV.L   @R15+,R5                        ;POP.L  R5
  773 0000003C 64F6                   M           MOV.L   @R15+,R4                        ;POP.L  R4
  774 0000003E 63F6                   M           MOV.L   @R15+,R3                        ;POP.L  R3
  775 00000040 62F6                   M           MOV.L   @R15+,R2                        ;POP.L  R2
  776 00000042 61F6                   M           MOV.L   @R15+,R1                        ;POP.L  R1
  777 00000044 60F6                   M           MOV.L   @R15+,R0                        ;POP.L  R0
  778                                 M   
  779                              68     ;---------------------------------------------------------
  780                              69     
  781 00000046 002B                70             RTE                                                     ;SR,PC を POP
  782 00000048 0009                71             NOP
  783                              72     
  784 0000004C                     73             .ALIGN 4
  785 0000004C                     74     real_run_tid_rescheduler_i:
  786 0000004C 00000000            75             .DATA.L _real_run_tid
  787 00000050                     76     top_ready_tid_rescheduler_i:
  788 00000050 00000000            77             .DATA.L _top_ready_tid
  789 00000054                     78     TCB_TBL_SIZE_rescheduler_i:
  790 00000054 00000010            79             .DATA.L TCB_TBL_SIZE
  791 00000058                     80     tcbp_rescheduler_i:
  792 00000058 00000000            81             .DATA.L _tcb_p
  793                              82     
  794                              83     ;/****************/
  795                              84     ;/* 外付けＲＯＭ */
  796                              85     ;/****************/
  797                              86     ; 割込み禁止区間測定の変更中 T.Nose 1998/01/17
  798 00000000                     87             .SECTION        P,CODE,ALIGN=4
*** SH SERIES ASSEMBLER Ver. 2.0 ***      01/26/98 22:01:18                                                              PAGE    15
PROGRAM NAME =

  799 00000000                     88     _rescheduler_erom:
  800 00000000 D115                89             MOV             real_run_tid_rescheduler_e,R1
  801 00000002 6310                90             MOV.B   @R1,R3                          ;MOV.B  @_real_run_tid,R1L @R1->R3符号拡張
  802 00000004 D215                91             MOV             top_ready_tid_rescheduler_e,R2
  803 00000006 6420                92             MOV.B   @R2,R4                          ;MOV.B  @_top_ready_tid,R2L     @R2->R4符
  804 00000008 3430                93             CMP/EQ  R3,R4                           ;CMP.B  R1L,R2L
  805 0000000A 8901                94             BT              resch01_e                               ;遅延無し
  806 0000000C 2140                95             MOV.B   R4,@R1                          ;top_ready_tid = real_run_tid
  807 0000000E 6343                96             MOV             R4,R3
  808 00000010                     97     resch01_e:
  809 00000010 D513                98             MOV.L   TCB_TBL_SIZE_rescheduler_e,R5
  810 00000012 253E                99             MULU    R3,R5
  811 00000014 061A               100             STS             MACL,R6
  812                             101     
  813                             102     ;       MOV.L   tcb_stack_adr_rescheduler_e,R0
  814                             103     ;FOR POINTER ACCESS
  815 00000016 D013               104             MOV.L   tcbp_rescheduler_e,R0
  816 00000018 6002               105             MOV.L   @R0,R0
  817 0000001A 700C               106             ADD             #TCB_STACK_ADR,R0
  818 0000001C 0F6E               107             MOV.L   @(R0,R6),R15            ; スタックポインタレストア
  819                             108     
  820                             109     ; 割込み禁止区間測定のため、割込み許可の前にポート（Ｃ２０３Ｄ０）の
  821                             110     ; ０ｘ００２０をＯＦＦします T.Nose 1998/01/17
  822                             111     ; フラグをＯＮする
  823                             112     ;       MOV.L   PORT_ADR_DATA,R0
  824                             113     ;       MOV             #1,R1
  825                             114     ;       MOV.B   R1,@R0                  ; MON_IsIntEnable = 1
  826                             115     ; ポートをＯＦＦする
  827 0000001E D012               116             MOV.L   PORT_ADR_DATA,R0
  828 00000020 9126               117             MOV.W   PORT_ADR_DATA+8,R1
  829 00000022 6201               118             MOV.W   @R0,R2
  830 00000024 2219               119             AND             R1,R2
  831 00000026 2021               120             MOV.W   R2,@R0          ; SYS_COM_Port_Status &= ~0x0020
  832 00000028 D110               121             MOV.L   PORT_ADR_DATA+4,R1
  833 0000002A 2121               122             MOV.W   R2,@R1          ; outpw(COM_PORT,SYS_COM_PortStatus)
  834                             123     
  835                             124     ;---------------------------------------------------------
  836                             125             RSTR_REG                        ; ﾏｸﾛ ﾚｼﾞｽﾀﾎﾟｯﾌﾟ
  837                                 M   
  838 0000002C 4F26                   M           LDS.L   @R15+,PR                        ;POP.L  PR
  839 0000002E 4F16                   M           LDS.L   @R15+,MACL                      ;POP.L  MACL
  840 00000030 4F06                   M           LDS.L   @R15+,MACH                      ;POP.L  MACH
  841 00000032 4F27                   M           LDC.L   @R15+,VBR                       ;POP.L  VBR
  842 00000034 4F17                   M           LDC.L   @R15+,GBR                       ;POP.L  GBR
  843 00000036 6EF6                   M           MOV.L   @R15+,R14                       ;POP.L  R14
  844 00000038 6DF6                   M           MOV.L   @R15+,R13                       ;POP.L  R13
  845 0000003A 6CF6                   M           MOV.L   @R15+,R12                       ;POP.L  R12
  846 0000003C 6BF6                   M           MOV.L   @R15+,R11                       ;POP.L  R11
  847 0000003E 6AF6                   M           MOV.L   @R15+,R10                       ;POP.L  R10
  848 00000040 69F6                   M           MOV.L   @R15+,R9                        ;POP.L  R9
  849 00000042 68F6                   M           MOV.L   @R15+,R8                        ;POP.L  R8
  850 00000044 67F6                   M           MOV.L   @R15+,R7                        ;POP.L  R7
  851 00000046 66F6                   M           MOV.L   @R15+,R6                        ;POP.L  R6
  852 00000048 65F6                   M           MOV.L   @R15+,R5                        ;POP.L  R5
  853 0000004A 64F6                   M           MOV.L   @R15+,R4                        ;POP.L  R4
  854 0000004C 63F6                   M           MOV.L   @R15+,R3                        ;POP.L  R3
  855 0000004E 62F6                   M           MOV.L   @R15+,R2                        ;POP.L  R2
*** SH SERIES ASSEMBLER Ver. 2.0 ***      01/26/98 22:01:18                                                              PAGE    16
PROGRAM NAME =

  856 00000050 61F6                   M           MOV.L   @R15+,R1                        ;POP.L  R1
  857 00000052 60F6                   M           MOV.L   @R15+,R0                        ;POP.L  R0
  858                                 M   
  859                             126     ;---------------------------------------------------------
  860                             127     
  861 00000054 002B               128             RTE                                                     ;SR,PC を POP
  862 00000056 0009               129             NOP
  863                             130     
  864 00000058                    131             .ALIGN 4
  865 00000058                    132     real_run_tid_rescheduler_e:
  866 00000058 00000000           133             .DATA.L _real_run_tid
  867 0000005C                    134     top_ready_tid_rescheduler_e:
  868 0000005C 00000000           135             .DATA.L _top_ready_tid
  869 00000060                    136     TCB_TBL_SIZE_rescheduler_e:
  870 00000060 00000010           137             .DATA.L TCB_TBL_SIZE
  871                             138     ;tcb_stack_adr_rescheduler_e:
  872                             139     ;       .DATA.L _tcb+TCB_STACK_ADR
  873 00000064                    140     tcbp_rescheduler_e:
  874 00000064 00000000           141             .DATA.L _tcb_p
  875                             142     
  876                             143     ; 割込み禁止区間測定
  877 00000068                    144     PORT_ADR_DATA:
  878                             145     ;       .DATA.L         _MON_IsIntEnable
  879 00000068 00000000           146             .DATA.L         _SYS_COM_PortStatus     ; 出力ポートのステータス
i:\src\atlanta\sh7043\mon\schedule.src(146) : 200 (E) UNDEFINED SYMBOL REFERENCE
  880 0000006C 00C203D0           147             .DATA.L         H'00C203D0          ; 出力ポートアドレス
  881 00000070 FFDF               148             .DATA.W         H'FFDF                          ; ＯＦＦ出力ビットパターン
  882                             149     
  883                             150     
  884                             151             .END
  *****TOTAL ERRORS       1
  *****TOTAL WARNINGS     0
*** SH SERIES ASSEMBLER Ver. 2.0 ***      01/26/98 22:01:18                                                              PAGE    17

*** CROSS REFERENCE LIST

NAME                             SECTION  ATTR VALUE             SEQUENCE

ERROR                                     EQU  000000FF    193*
FLAG_INIT_DATA                            EQU  00000000     42*
INIT_TID                                  EQU  00000000     33*
I_BIT_OFF                                 EQU  0000030F     23*
I_BIT_ON                                  EQU  000000F0     22*
LONGNIL                                   EQU  FFFFFFFF    180*
MON                              MON      SCT  00000000    736*
MON_FAILURE                               EQU  00000000    276*
MON_SUCCESS                               EQU  00000001    275*
NIL                                       EQU  000000FF    178*
NOT_USED                                  EQU  000000C0    184*
NO_WAIMBX                                 EQU  0000007F    249*
ONESHOT_VALUE_MAX                         EQU  0000001A     28*
P                                P        SCT  00000000    798*
PORT_ADR_DATA                    P             00000068    827   828   832   877*
RCV_WAIT                                  EQU  00000002    187*
READY                                     EQU  00000040    183*
SCB_INIT                                  EQU  0000007F    221*
SCB_STAT                                  EQU  00000000    228*
SCB_TBL_SIZE                              EQU  00000002    220*
SCB_TID                                   EQU  00000001    229*
SND_WAIT                                  EQU  00000001    186*
STACK_PC_POSITION                         EQU  00000050     54*
TCB_LINK                                  EQU  00000003    167*
TCB_PRIORITY                              EQU  00000002    166*
TCB_PROGNO                                EQU  00000001    165*
TCB_RESERVE                               EQU  00000006    170*
TCB_RUN_LINK                              EQU  00000004    168*
TCB_STACK_ADR                             EQU  0000000C    173*  752   817 
TCB_STAT                                  EQU  00000000    164*
TCB_TBL_SIZE                              EQU  00000010    176*  790   870 
TCB_TBL_SIZE_rescheduler_e       P             00000060    809   869*
TCB_TBL_SIZE_rescheduler_i       MON           00000054    747   789*
TCB_WAIT_PARA1                            EQU  00000008    171*
TCB_WAIT_PARA2                            EQU  0000000A    172*
TCB_WAIT_PARAM                            EQU  00000005    169*
TIB_END_ADR                               EQU  00000004    102*
TIB_PRIORITY                              EQU  00000009    104*
TIB_STACK_SIZE                            EQU  00000008    103*
TIB_START_ADR                             EQU  00000000    101*
TIB_TBL_SIZE                              EQU  0000000C     98*
TSK_INITIAL                               EQU  00000000     34*
TSK_INI_ADDR                              EQU  FFFFFC00     35*
WAIT                                      EQU  00000000    182*
WAIT_EVENT                                EQU  00000005    190*
WAIT_ONESHOT                              EQU  00000006    191*
WAIT_SEM                                  EQU  00000003    188*
WAIT_TIMER                                EQU  00000004    189*
WORDNIL                                   EQU  0000FFFF    179*
_MON_MAX_ECB                              IMPT 00000000    694 
_MON_MAX_LARGE_TCB                        IMPT 00000000    682 
_MON_MAX_MBXNO                            IMPT 00000000    693 
_MON_MAX_MCB                              IMPT 00000000    692 
_MON_MAX_SCB                              IMPT 00000000    690 
*** SH SERIES ASSEMBLER Ver. 2.0 ***      01/26/98 22:01:18                                                              PAGE    18

*** CROSS REFERENCE LIST

NAME                             SECTION  ATTR VALUE             SEQUENCE

_MON_MAX_SEMNO                            IMPT 00000000    691 
_MON_MAX_SMALL_TCB                        IMPT 00000000    683 
_MON_MAX_TCB                              IMPT 00000000    684 
_MON_SIZE_LARGE_STACK                     IMPT 00000000    685 
_MON_SIZE_SMALL_STACK                     IMPT 00000000    686 
_MON_STACK_START_ADDR                     IMPT 00000000    687 
_MON_StackCheckTable                      IMPT 00000000    288 
_MON_StackCheckTable_p                    IMPT 00000000    681 
_MON_TOP_LARGE_ADDR                       IMPT 00000000    688 
_MON_TOP_SMALL_ADDR                       IMPT 00000000    689 
_SYS_COM_PortStatus                       UDEF 00000000    879 
_ecb_p                                    IMPT 00000000    679 
_mcb_p                                    IMPT 00000000    680 
_real_run_tid                             IMPT 00000000    672   786   866 
_rescheduler_erom                P        EXPT 00000000    704   799*
_rescheduler_irom                MON      EXPT 00000000    703   737*
_scb_p                                    IMPT 00000000    678 
_tcb_p                                    IMPT 00000000    677   792   874 
_tib                                      IMPT 00000000    676 
_top_ready_tid                            IMPT 00000000    673   788   868 
_wai_1shot_tid                            IMPT 00000000    675 
_wai_tsk_tid                              IMPT 00000000    674 
real_run_tid_rescheduler_e       P             00000058    800   865*
real_run_tid_rescheduler_i       MON           0000004C    738   785*
resch01_e                        P             00000010    805   808*
resch01_i                        MON           00000010    743   746*
tcbp_rescheduler_e               P             00000064    815   873*
tcbp_rescheduler_i               MON           00000058    750   791*
top_ready_tid_rescheduler_e      P             0000005C    802   867*
top_ready_tid_rescheduler_i      MON           00000050    740   787*
*** SH SERIES ASSEMBLER Ver. 2.0 ***      01/26/98 22:01:18                                                              PAGE    19

*** SECTION DATA LIST

SECTION                          ATTRIBUTE    SIZE             START

MON                              REL-CODE    00000005C        
P                                REL-CODE    000000072        
