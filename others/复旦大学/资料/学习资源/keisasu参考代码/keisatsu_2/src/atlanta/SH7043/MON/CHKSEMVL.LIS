*** SH SERIES ASSEMBLER Ver. 2.0 ***      02/09/98 16:03:41                                                              PAGE     1
PROGRAM NAME =

    1                               1     ;/*--------------------------------------------------------------------------*/
    2                               2     ;/*  プロジェクト : POPLAR/ANZU_L                                            */
    3                               3     ;/*  ファイル名   : chksemvl.src                                             */
    4                               4     ;/*  作成者       : 野瀬                                                     */
    5                               5     ;/*  日  付       : 1998/02/09                                               */
    6                               6     ;/*  概  要       : セマフォ管理                                             */
    7                               7     ;/*  修正履歴     :                                                          */
    8                               8     ;/*--------------------------------------------------------------------------*/
    9                               9     
   10                              10             .INCLUDE        "\src\atlanta\sh7043\define\def_mon.hdr"
   11                               1 I1  ;/*--------------------------------------------------------------------------*/
   12                               2 I1  ;/*  プロジェクト : RISC                                                     */
   13                               3 I1  ;/*  ファイル名   : def_mon.ih                                               */
   14                               4 I1  ;/*  作成者       : 野瀬                                                     */
   15                               5 I1  ;/*  日  付       : 95.11.01                                                 */
   16                               6 I1  ;/*  概  要       : モニタdefine定義                                         */
   17                               7 I1  ;/*  修正履歴     :                                                          */
   18                               8 I1  ;/*--------------------------------------------------------------------------*/
   19                               9 I1  ;-----------------------------------------------------------------------------
   20                              10 I1  ; ＣＣＲ マスクビット
   21                              11 I1  ;-----------------------------------------------------------------------------
   22          000000F0            12 I1  I_BIT_ON                .EQU    H'000000F0      ; 割込禁止 RISC
   23          0000030F            13 I1  I_BIT_OFF               .EQU    H'0000030F      ; 割込許可 RISC
   24                              14 I1  
   25                              15 I1  ;-----------------------------------------------------------------------------
   26                              16 I1  ; ワンショットタイマ値ＭＡＸ
   27                              17 I1  ;-----------------------------------------------------------------------------
   28          0000001A            18 I1  ONESHOT_VALUE_MAX               .EQU    26
   29                              19 I1  
   30                              20 I1  ;-----------------------------------------------------------------------------
   31                              21 I1  ; タスク イニシャルプログラムNo.
   32                              22 I1  ;-----------------------------------------------------------------------------
   33          00000000            23 I1  INIT_TID                .EQU    0
   34          00000000            24 I1  TSK_INITIAL             .EQU    0
   35          FFFFFC00            25 I1  TSK_INI_ADDR    .EQU    H'FFFFFC00              ; 初期化用スタック H'FFFFFC00-H'FFFFF000 3
   36                              26 I1                                                                                  ; def_mon.
   37                              27 I1  
   38                              28 I1  ;-----------------------------------------------------------------------------
   39                              29 I1  ; モニタ システム
   40                              30 I1  ;-----------------------------------------------------------------------------
   41                              31 I1  
   42          00000000            32 I1  FLAG_INIT_DATA                  .EQU    H'00000000      ; RISC
   43                              33 I1  
   44                              34 I1  ;TASK_STACK_START               .EQU    H'00809800
   45                              35 I1  
   46                              36 I1  ;LARGE_STACK_MAX                        .EQU    16                      ; RISC
   47                              37 I1  ;SMALL_STACK_MAX                        .EQU    32                      ; RISC
   48                              38 I1  ;TOTAL_STACK_MAX                        .EQU    (SMALL_STACK_MAX+LARGE_STACK_MAX)
   49                              39 I1  ;LARGE_STACK                            .EQU    512
   50                              40 I1  ;SMALL_STACK                            .EQU    256
   51                              41 I1  ;STACK_PUSH_SIZE                        .EQU    88                      ;       スタック退
   52                              42 I1  ;TOP_LARGE_ADDR                         .EQU    (TASK_STACK_START-(SMALL_STACK*SMALL_STACK
   53                              43 I1  ;TOP_SMALL_ADDR                         .EQU    (TASK_STACK_START-STACK_PUSH_SIZE)
   54          00000050            44 I1  STACK_PC_POSITION               .EQU    80
   55                              45 I1  ;STK_RTNVL_PT                   .EQU    76
   56                              46 I1  
   57                              47 I1  ;-----------------------------------------------------------------------------
*** SH SERIES ASSEMBLER Ver. 2.0 ***      02/09/98 16:03:41                                                              PAGE     2
PROGRAM NAME =

   58                              48 I1  ; TIB
   59                              49 I1  ;
   60                              50 I1  ; struct tib_table_data {
   61                              51 I1  ;       unsigned char *start_addr;
   62                              52 I1  ;       unsigned char *end_addr;
   63                              53 I1  ;       unsigned char stack_size;
   64                              54 I1  ;       unsigned char priority;
   65                              55 I1  ;       unsigned short reserve;
   66                              56 I1  ; };
   67                              57 I1  ;
   68                              58 I1  ;    ｮ｢｢｢｢｢｢｢｢｢｢｢ｲ
   69                              59 I1  ;  0 ､                      ､
   70                              60 I1  ;    ､                      ､
   71                              61 I1  ;  1 ､   タスクプログラム   ､
   72                              62 I1  ;    ､   スタートアドレス   ､
   73                              63 I1  ;  2 ､                      ､
   74                              64 I1  ;    ､                      ､
   75                              65 I1  ;  3 ､                      ､
   76                              66 I1  ;    ｾ｢｢｢｢｢｢｢｢｢｢｢ﾆ
   77                              67 I1  ;  4 ､                      ､
   78                              68 I1  ;    ､                      ､
   79                              69 I1  ;  5 ､   異常処理ルーチン   ､
   80                              70 I1  ;    ､   スタートアドレス   ､
   81                              71 I1  ;  6 ､                      ､
   82                              72 I1  ;    ､                      ､
   83                              73 I1  ;  7 ､                      ､
   84                              74 I1  ;    ｾ｢｢｢｢｢｢｢｢｢｢｢ﾆ
   85                              75 I1  ;  8 ､    スタックサイズ    ､  0:Large Stack  1:Small Stack
   86                              76 I1  ;    ｾ｢｢｢｢｢｢｢｢｢｢｢ﾆ
   87                              77 I1  ;  9 ､       優先順位       ､
   88                              78 I1  ;    ｾ｢｢｢｢｢｢｢｢｢｢｢ﾆ
   89                              79 I1  ; 10 ､       リザーブ       ､
   90                              80 I1  ;    ､                      ､
   91                              81 I1  ; 11 ､                      ､
   92                              82 I1  ;    ｶ｢｢｢｢｢｢｢｢｢｢｢ｺ
   93                              83 I1  ;
   94                              84 I1  ;      優先順位(0～255)
   95                              85 I1  ;      ※ 0を最も高い優先順位とします
   96                              86 I1  ;-----------------------------------------------------------------------------
   97                              87 I1  
   98          0000000C            88 I1  TIB_TBL_SIZE    .EQU    12
   99                              89 I1  
  100                              90 I1  ;-- オフセット --
  101          00000000            91 I1  TIB_START_ADR           .EQU    0
  102          00000004            92 I1  TIB_END_ADR                     .EQU    4
  103          00000008            93 I1  TIB_STACK_SIZE          .EQU    8
  104          00000009            94 I1  TIB_PRIORITY            .EQU    9
  105                              95 I1  
  106                              96 I1  ;-----------------------------------------------------------------------------
  107                              97 I1  ; TCB
  108                              98 I1  ;
  109                              99 I1  ; struct tcb_table_data {
  110                             100 I1  ;       unsigned char tsk_stat;
  111                             101 I1  ;       unsigned char prog_no;
  112                             102 I1  ;       unsigned char priority;
  113                             103 I1  ;       unsigned char tsk_link;
  114                             104 I1  ;       unsigned char run_link;
*** SH SERIES ASSEMBLER Ver. 2.0 ***      02/09/98 16:03:41                                                              PAGE     3
PROGRAM NAME =

  115                             105 I1  ;       unsigned char tsk_stat_tpo;
  116                             106 I1  ;       unsigned short reserve;         RISC追加 by T.Nose
  117                             107 I1  ;       unsigned long wait_param;
  118                             108 I1  ;       unsigned char *stack_addr;
  119                             109 I1  ; };
  120                             110 I1  ;
  121                             111 I1  ;    ｮ｢｢ﾎ｢｢｢｢｢｢｢｢ｲ
  122                             112 I1  ;  0 ､STS ､ WAIT時の原因   ､   STS           WAIT時の原因
  123                             113 I1  ;    ｾ｢｢ﾖ｢｢｢｢｢｢｢｢ﾆ   11 : 未使用    1 : 送信待ち
  124                             114 I1  ;  1 ､     プログラムNo.    ､   00 : WAIT      2 : 受信待ち
  125                             115 I1  ;    ｾ｢｢｢｢｢｢｢｢｢｢｢ﾆ   01 : READY     3 : セマフォ待ち
  126                             116 I1  ;  2 ､       優先順位       ､                  4 : タイマ待ち
  127                             117 I1  ;    ｾ｢｢｢｢｢｢｢｢｢｢｢ﾆ                  5 : イベントフラグ待ち
  128                             118 I1  ;  3 ､     タスクリンク     ､                  6 : ワンショットタイマ待ち
  129                             119 I1  ;    ｾ｢｢｢｢｢｢｢｢｢｢｢ﾆ
  130                             120 I1  ;  4 ､    強制ランタスク    ､
  131                             121 I1  ;    ｾ｢｢｢｢｢｢｢｢｢｢｢ﾆ
  132                             122 I1  ;  5 ､待ちタスクパラメータ a､
  133                             123 I1  ;    ｾ｢｢｢｢｢｢｢｢｢｢｢ﾆ
  134                             124 I1  ;  6 ､       リザーブ       ､  アドレス調整用 RISC追加 by T.Nose
  135                             125 I1  ;    ､                      ､
  136                             126 I1  ;  7 ､                      ､
  137                             127 I1  ;    ｾ｢｢｢｢｢｢｢｢｢｢｢ﾆ
  138                             128 I1  ;  8 ､                     b､  1.送信待ち
  139                             129 I1  ;    ､                      ､     a     : MBX No
  140                             130 I1  ;  9 ､                     c､     b～e  : 送信データアドレス
  141                             131 I1  ;    ､                      ､  2.受信待ち
  142                             132 I1  ; 10 ､                     d､     a     : MBX No
  143                             133 I1  ;    ､                      ､     b～e  : 受信データアドレス
  144                             134 I1  ; 11 ､                     e､  3.セマフォ待ち
  145                             135 I1  ;    ｾ｢｢｢｢｢｢｢｢｢｢｢ﾆ     a,d,e : 未使用
  146                             136 I1  ; 12 ､                      ､     b,c   : セマフォ No
  147                             137 I1  ;    ､                      ､  4.タイマ待ち
  148                             138 I1  ; 13 ､                      ､     a,d,e : 未使用
  149                             139 I1  ;    ､   スタックアドレス   ､     b,c   : タイマ値
  150                             140 I1  ; 14 ､                      ､  5.イベントフラグ待ち
  151                             141 I1  ;    ､                      ､     a     : EVENT No
  152                             142 I1  ; 15 ､                      ､     b～e  : 未使用
  153                             143 I1  ;    ｶ｢｢｢｢｢｢｢｢｢｢｢ｺ  6.ワンショットタイマ待ち
  154                             144 I1  ;                                   a～e  : 未使用
  155                             145 I1  
  156                             146 I1  
  157                             147 I1  
  158                             148 I1  
  159                             149 I1  ;      スタックアドレス  初期値 = (実際のアドレス - 32byte)
  160                             150 I1  ;
  161                             151 I1  ;-----------------------------------------------------------------------------
  162                             152 I1  
  163                             153 I1  ;-- オフセット --
  164          00000000           154 I1  TCB_STAT                        .EQU    0
  165          00000001           155 I1  TCB_PROGNO                      .EQU    1
  166          00000002           156 I1  TCB_PRIORITY            .EQU    2
  167          00000003           157 I1  TCB_LINK                        .EQU    3
  168          00000004           158 I1  TCB_RUN_LINK            .EQU    4
  169          00000005           159 I1  TCB_WAIT_PARAM          .EQU    5
  170          00000006           160 I1  TCB_RESERVE                     .EQU    6
  171          00000008           161 I1  TCB_WAIT_PARA1          .EQU    8
*** SH SERIES ASSEMBLER Ver. 2.0 ***      02/09/98 16:03:41                                                              PAGE     4
PROGRAM NAME =

  172          0000000A           162 I1  TCB_WAIT_PARA2          .EQU    10
  173          0000000C           163 I1  TCB_STACK_ADR           .EQU    12
  174                             164 I1  
  175                             165 I1  ;READY_TSK_MAX  .EQU    SMALL_STACK_MAX+LARGE_STACK_MAX
  176          00000010           166 I1  TCB_TBL_SIZE    .EQU    16
  177                             167 I1  
  178          000000FF           168 I1  NIL                             .EQU    H'ff
  179          0000FFFF           169 I1  WORDNIL                 .EQU    H'ffff
  180          FFFFFFFF           170 I1  LONGNIL                 .EQU    H'ffffffff
  181                             171 I1  
  182          00000000           172 I1  WAIT                    .EQU    H'00    ;RISC
  183          00000040           173 I1  READY                   .EQU    H'40    ;RISC
  184          000000C0           174 I1  NOT_USED                .EQU    H'C0    ;RISC
  185                             175 I1  
  186          00000001           176 I1  SND_WAIT                .EQU    H'01
  187          00000002           177 I1  RCV_WAIT                .EQU    H'02
  188          00000003           178 I1  WAIT_SEM                .EQU    H'03
  189          00000004           179 I1  WAIT_TIMER              .EQU    H'04
  190          00000005           180 I1  WAIT_EVENT              .EQU    H'05
  191          00000006           181 I1  WAIT_ONESHOT    .EQU    H'06
  192                             182 I1  
  193          000000FF           183 I1  ERROR                   .EQU    H'ff
  194                             184 I1  
  195                             185 I1  ;-----------------------------------------------------------------------------
  196                             186 I1  ; SCB
  197                             187 I1  ;
  198                             188 I1  ; struct scb_table_data {
  199                             189 I1  ;       unsigned char stat;
  200                             190 I1  ;       unsigned char tid;
  201                             191 I1  ; };
  202                             192 I1  ;
  203                             193 I1  ;    ｮ｢｢ﾎ｢｢｢｢｢｢｢｢ｲ
  204                             194 I1  ;  0 ､STS ､待ちタスクのTID ､
  205                             195 I1  ;    ｾ｢｢ﾖ｢｢｢｢｢｢｢｢ﾆ
  206                             196 I1  ;  1 ､   セマフォ獲得TID    ､
  207                             197 I1  ;    ｶ｢｢｢｢｢｢｢｢｢｢｢ｺ
  208                             198 I1  ;
  209                             199 I1  ;     STS
  210                             200 I1  ;          11 : 未使用
  211                             201 I1  ;          00 : セマフォ値=0
  212                             202 I1  ;          01 : セマフォ値=1
  213                             203 I1  ;
  214                             204 I1  ;     待ちタスクのTID
  215                             205 I1  ;          111111 : 待ちタスクなし
  216                             206 I1  ;
  217                             207 I1  ;-----------------------------------------------------------------------------
  218                             208 I1  
  219                             209 I1  ;SEMNO_MAX              .EQU    32
  220          00000002           210 I1  SCB_TBL_SIZE    .EQU    2
  221          0000007F           211 I1  SCB_INIT                .EQU    H'7F
  222                             212 I1  ;SCB_FREE               .EQU    H'3F
  223                             213 I1  
  224                             214 I1  ;MAX_SEMNO              .EQU    15      ; \src\atlanta\sh7043\define\def_semn.hに
  225                             215 I1                                                          ; 同一の定義有り。同値に保って下さ
  226                             216 I1  
  227                             217 I1  ;-- オフセット --
  228          00000000           218 I1  SCB_STAT                .EQU    0
*** SH SERIES ASSEMBLER Ver. 2.0 ***      02/09/98 16:03:41                                                              PAGE     5
PROGRAM NAME =

  229          00000001           219 I1  SCB_TID                 .EQU    1
  230                             220 I1  
  231                             221 I1  ;-----------------------------------------------------------------------------
  232                             222 I1  ; MCB
  233                             223 I1  ;
  234                             224 I1  ;    ｮ｢｢ﾎ｢｢｢｢｢｢ｲ
  235                             225 I1  ;    ､STS ､    TID     ､
  236                             226 I1  ;    ｶ｢｢ﾖ｢｢｢｢｢｢ｺ
  237                             227 I1  ;
  238                             228 I1  ;     STS                      TID
  239                             229 I1  ;     11 : 未使用              111111
  240                             230 I1  ;     10 : 待ちタスクなし      111111
  241                             231 I1  ;     00 : 送信待ちタスクあり  xxxxxx  待ちタスクの中で最も優先順位の高いTID
  242                             232 I1  ;     01 : 受信待ちタスクあり  xxxxxx  待ちタスクの中で最も優先順位の高いTID
  243                             233 I1  ;
  244                             234 I1  ;-----------------------------------------------------------------------------
  245                             235 I1  
  246                             236 I1  ;MBXNO_MAX              .EQU    256
  247                             237 I1  
  248                             238 I1  ;Task MAX Change T.Nose 1996/10/31
  249          0000007F           239 I1  NO_WAIMBX               .EQU    H'7F    ;<- H'BF
  250                             240 I1  ;SND_MBX                        .EQU    H'00
  251                             241 I1  ;RCV_MBX                        .EQU    H'40
  252                             242 I1  
  253                             243 I1  ;MAX_MBXNO              .EQU    70      ; \src\atlanta\sh7043\define\def_mbxn.h に
  254                             244 I1                                                          ; 同一の定義有り。同値に保って下さ
  255                             245 I1  
  256                             246 I1  ;-----------------------------------------------------------------------------
  257                             247 I1  ; ECB
  258                             248 I1  ;
  259                             249 I1  ;    ｮ｢｢｢｢｢｢｢｢｢ｲ
  260                             250 I1  ;    ､       TID        ､
  261                             251 I1  ;    ｶ｢｢｢｢｢｢｢｢｢ｺ
  262                             252 I1  ;
  263                             253 I1  ;     TID
  264                             254 I1  ;     11111111 : 待ちタスクなし
  265                             255 I1  ;     xxxxxxxx : 待ちタスクのTID
  266                             256 I1  ;
  267                             257 I1  ;-----------------------------------------------------------------------------
  268                             258 I1  
  269                             259 I1  ;;EVENT_MAX             .EQU    74
  270                             260 I1  ;EVENT_MAX              .EQU    94     ; Changed with def_evtn.h for R288F event by H.Kubo
  271                             261 I1  
  272                             262 I1  ;-----------------------------------------------------------------------------
  273                             263 I1  ; Ｃソースモニター用
  274                             264 I1  ;-----------------------------------------------------------------------------
  275          00000001           265 I1  MON_SUCCESS             .EQU    1       ;モニター本体処理の戻値（結果）
  276          00000000           266 I1  MON_FAILURE             .EQU    0
  277                             267 I1  
  278                              11             .INCLUDE        "\src\atlanta\sh7043\ext_v\extv_mon.hdr"
  279                               1 I1  ;/*--------------------------------------------------------------------------*/
  280                               2 I1  ;/*  プロジェクト : POPLAR/ANZU_L                                            */
  281                               3 I1  ;/*  ファイル名   : extv_mon.hdr                                             */
  282                               4 I1  ;/*  作成者       : 野瀬敏弘                                                 */
  283                               5 I1  ;/*  日  付       : 1996/10/14                                               */
  284                               6 I1  ;/*  概  要       : モニタテーブル外部参照                                   */
  285                               7 I1  ;/*  修正履歴     :                                                          */
*** SH SERIES ASSEMBLER Ver. 2.0 ***      02/09/98 16:03:41                                                              PAGE     6
PROGRAM NAME =

  286                               8 I1  ;/*--------------------------------------------------------------------------*/
  287                               9 I1  
  288                              10 I1          .IMPORT         _real_run_tid
  289                              11 I1          .IMPORT         _top_ready_tid
  290                              12 I1          .IMPORT         _wai_tsk_tid
  291                              13 I1          .IMPORT         _wai_1shot_tid
  292                              14 I1          .IMPORT         _tib
  293                              15 I1          .IMPORT         _tcb_p
  294                              16 I1          .IMPORT         _scb_p
  295                              17 I1          .IMPORT         _ecb_p
  296                              18 I1          .IMPORT         _mcb_p
  297                              19 I1          .IMPORT         _MON_StackCheckTable_p
  298                              20 I1          .IMPORT         _MON_MAX_LARGE_TCB
  299                              21 I1          .IMPORT         _MON_MAX_SMALL_TCB
  300                              22 I1          .IMPORT         _MON_MAX_TCB
  301                              23 I1          .IMPORT         _MON_SIZE_LARGE_STACK
  302                              24 I1          .IMPORT         _MON_SIZE_SMALL_STACK
  303                              25 I1          .IMPORT         _MON_STACK_START_ADDR
  304                              26 I1          .IMPORT         _MON_TOP_LARGE_ADDR
  305                              27 I1          .IMPORT         _MON_TOP_SMALL_ADDR
  306                              28 I1          .IMPORT         _MON_MAX_SCB
  307                              29 I1          .IMPORT         _MON_MAX_SEMNO
  308                              30 I1          .IMPORT         _MON_MAX_MCB
  309                              31 I1          .IMPORT         _MON_MAX_MBXNO
  310                              32 I1          .IMPORT         _MON_MAX_ECB
  311                              33 I1  
  312                              34 I1  ; 以下の外部参照宣言は後程削除します
  313                              35 I1  ;       .IMPORT         _MON_DebugSwitch
  314                              36 I1  ;       .IMPORT         _tcb
  315                              37 I1  ;       .IMPORT         _scb
  316                              38 I1  ;       .IMPORT         _ecb
  317                              39 I1  ;       .IMPORT         _mcb
  318                              12             .IMPORT         monitor_error
  319                              13             .EXPORT         _chk_semvl_erom
  320                              14     
  321                              15     ;/*****************************************************************************
  322                              16     ;       module          :[資源が使用されているかチェックします]
  323                              17     ;       function        :[
  324                              18     ;               1. セマフォ番号で示される資源がいずれかのタスクによって
  325                              19     ;                  使用されているかどうかチェックします。
  326                              20     ;       ]
  327                              21     ;       return          :[
  328                              22     ;               ０：セマフォ使用中
  329                              23     ;               １：セマフォ空き
  330                              24     ;               ０ｘＦＦ：セマフォクリエイトされていない
  331                              25     ;       ]
  332                              26     ;       common          :[_real_run_tid, _tcb, _scb]
  333                              27     ;       comment         :[
  334                              28     ;
  335                              29     ;               UBYTE chk_semvl(UWORD semno)
  336                              30     ;
  337                              31     ;               引き数レジスタ
  338                              32     ;                       R4:semno
  339                              33     ;               内部使用レジスタ
  340                              34     ;                       R0 R1 R2 R3
  341                              35     ;       ]
  342                              36     ;       machine         :[SH7043]
*** SH SERIES ASSEMBLER Ver. 2.0 ***      02/09/98 16:03:41                                                              PAGE     7
PROGRAM NAME =

  343                              37     ;       language        :[ASMSH]
  344                              38     ;       keyword         :[MON]
  345                              39     ;       date            :[1998/02/09]
  346                              40     ;       author          :[野瀬敏弘]
  347                              41     ;*****************************************************************************/
  348 00000000                     42             .SECTION        P,CODE,ALIGN=4
  349 00000000                     43     _chk_semvl_erom:
  350 00000000 0002                44             STC             SR,R0
  351 00000002 D111                45             MOV.L   CHK_SEMVL_IMM,R1
  352 00000004 6503                46             MOV             R0,R5                           ;SR 退避
  353 00000006 201B                47             OR              R1,R0
  354 00000008 400E                48             LDC             R0,SR                           ;割込禁止
  355                              49     
  356 0000000A D110                50             MOV.L   CHK_SEMVL_IMM+4,R1      ; R1 = scb_p
  357 0000000C D210                51             MOV.L   CHK_SEMVL_IMM+8,R2      ; R2 = MON_MAX_SCB
  358 0000000E 6320                52             MOV.B   @R2,R3
  359 00000010 633C                53             EXTU.B  R3,R3                           ; R3 = SEMNO_MAX
  360 00000012 644D                54             EXTU.W  R4,R4
  361 00000014 3432                55             CMP/HS  R3,R4
  362 00000016 8914                56             BT              CHK_SEMVL_ERR           ; semno >= SEMNO_MAX -> monitor_error
  363 00000018 4420                57             SHAL    R4
  364 0000001A 6012                58             MOV.L   @R1,R0
  365 0000001C 014C                59             MOV.B   @(R0,R4),R1                     ; R1 = scb[semno].stat
  366 0000001E E2FF                60             MOV             #H'FF,R2
  367 00000020 3120                61             CMP/EQ  R2,R1
  368 00000022 8907                62             BT              RET_FF
  369 00000024 304C                63             ADD             R4,R0
  370 00000026 7101                64             ADD             #1,R1
  371 00000028 6010                65             MOV.B   @R1,R0                          ; R0 = scb[semno].tid
  372 0000002A 88FF                66             CMP/EQ  #H'FF,R0
  373 0000002C 8905                67             BT              RET_1                           ; scb[semno].tid == 0xFF -> RET_1
  374                              68     ;セマフォ使用中
  375 0000002E E000                69             MOV             #0,R0                           ;return(0)
  376 00000030 A004                70             BRA             RET_CHK_SEMVL
  377 00000032 0009                71             NOP
  378                              72     ;セマフォがクリエイトされていない
  379 00000034                     73     RET_FF:
  380 00000034 E0FF                74             MOV             #H'FF,R0                        ;return(0xff)
  381 00000036 A001                75             BRA             RET_CHK_SEMVL
  382 00000038 0009                76             NOP
  383                              77     ;セマフォが空いている
  384 0000003A                     78     RET_1:
  385 0000003A E001                79             MOV             #1,R0                           ;return(1)
  386 0000003C                     80     RET_CHK_SEMVL:
  387 0000003C 450E                81             LDC             R5,SR                           ;SR復帰
  388 0000003E 000B                82             RTS
  389 00000040 0009                83             NOP
  390                              84     ;ＭＡＸオーバー
  391 00000042                     85     CHK_SEMVL_ERR:
  392 00000042 D004                86             MOV.L   CHK_SEMVL_IMM+H'C,R0
  393 00000044 402B                87             JMP             @R0
  394 00000046 0009                88             NOP
  395                              89     
  396 00000048                     90             .ALIGN 4
  397 00000048                     91     CHK_SEMVL_IMM:
  398 00000048 000000F0            92             .DATA.L         I_BIT_ON
  399 0000004C 00000000            93             .DATA.L         _scb_p
*** SH SERIES ASSEMBLER Ver. 2.0 ***      02/09/98 16:03:41                                                              PAGE     8
PROGRAM NAME =

  400 00000050 00000000            94             .DATA.L         _MON_MAX_SCB
  401 00000054 00000000            95             .DATA.L         monitor_error
  402                              96     
  403                              97             .END
  *****TOTAL ERRORS       0
  *****TOTAL WARNINGS     0
*** SH SERIES ASSEMBLER Ver. 2.0 ***      02/09/98 16:03:41                                                              PAGE     9

*** CROSS REFERENCE LIST

NAME                             SECTION  ATTR VALUE             SEQUENCE

CHK_SEMVL_ERR                    P             00000042    362   391*
CHK_SEMVL_IMM                    P             00000048    351   356   357   392   397*
ERROR                                     EQU  000000FF    193*
FLAG_INIT_DATA                            EQU  00000000     42*
INIT_TID                                  EQU  00000000     33*
I_BIT_OFF                                 EQU  0000030F     23*
I_BIT_ON                                  EQU  000000F0     22*  398 
LONGNIL                                   EQU  FFFFFFFF    180*
MON_FAILURE                               EQU  00000000    276*
MON_SUCCESS                               EQU  00000001    275*
NIL                                       EQU  000000FF    178*
NOT_USED                                  EQU  000000C0    184*
NO_WAIMBX                                 EQU  0000007F    249*
ONESHOT_VALUE_MAX                         EQU  0000001A     28*
P                                P        SCT  00000000    348*
RCV_WAIT                                  EQU  00000002    187*
READY                                     EQU  00000040    183*
RET_1                            P             0000003A    373   384*
RET_CHK_SEMVL                    P             0000003C    376   381   386*
RET_FF                           P             00000034    368   379*
SCB_INIT                                  EQU  0000007F    221*
SCB_STAT                                  EQU  00000000    228*
SCB_TBL_SIZE                              EQU  00000002    220*
SCB_TID                                   EQU  00000001    229*
SND_WAIT                                  EQU  00000001    186*
STACK_PC_POSITION                         EQU  00000050     54*
TCB_LINK                                  EQU  00000003    167*
TCB_PRIORITY                              EQU  00000002    166*
TCB_PROGNO                                EQU  00000001    165*
TCB_RESERVE                               EQU  00000006    170*
TCB_RUN_LINK                              EQU  00000004    168*
TCB_STACK_ADR                             EQU  0000000C    173*
TCB_STAT                                  EQU  00000000    164*
TCB_TBL_SIZE                              EQU  00000010    176*
TCB_WAIT_PARA1                            EQU  00000008    171*
TCB_WAIT_PARA2                            EQU  0000000A    172*
TCB_WAIT_PARAM                            EQU  00000005    169*
TIB_END_ADR                               EQU  00000004    102*
TIB_PRIORITY                              EQU  00000009    104*
TIB_STACK_SIZE                            EQU  00000008    103*
TIB_START_ADR                             EQU  00000000    101*
TIB_TBL_SIZE                              EQU  0000000C     98*
TSK_INITIAL                               EQU  00000000     34*
TSK_INI_ADDR                              EQU  FFFFFC00     35*
WAIT                                      EQU  00000000    182*
WAIT_EVENT                                EQU  00000005    190*
WAIT_ONESHOT                              EQU  00000006    191*
WAIT_SEM                                  EQU  00000003    188*
WAIT_TIMER                                EQU  00000004    189*
WORDNIL                                   EQU  0000FFFF    179*
_MON_MAX_ECB                              IMPT 00000000    310 
_MON_MAX_LARGE_TCB                        IMPT 00000000    298 
_MON_MAX_MBXNO                            IMPT 00000000    309 
_MON_MAX_MCB                              IMPT 00000000    308 
*** SH SERIES ASSEMBLER Ver. 2.0 ***      02/09/98 16:03:41                                                              PAGE    10

*** CROSS REFERENCE LIST

NAME                             SECTION  ATTR VALUE             SEQUENCE

_MON_MAX_SCB                              IMPT 00000000    306   400 
_MON_MAX_SEMNO                            IMPT 00000000    307 
_MON_MAX_SMALL_TCB                        IMPT 00000000    299 
_MON_MAX_TCB                              IMPT 00000000    300 
_MON_SIZE_LARGE_STACK                     IMPT 00000000    301 
_MON_SIZE_SMALL_STACK                     IMPT 00000000    302 
_MON_STACK_START_ADDR                     IMPT 00000000    303 
_MON_StackCheckTable_p                    IMPT 00000000    297 
_MON_TOP_LARGE_ADDR                       IMPT 00000000    304 
_MON_TOP_SMALL_ADDR                       IMPT 00000000    305 
_chk_semvl_erom                  P        EXPT 00000000    319   349*
_ecb_p                                    IMPT 00000000    295 
_mcb_p                                    IMPT 00000000    296 
_real_run_tid                             IMPT 00000000    288 
_scb_p                                    IMPT 00000000    294   399 
_tcb_p                                    IMPT 00000000    293 
_tib                                      IMPT 00000000    292 
_top_ready_tid                            IMPT 00000000    289 
_wai_1shot_tid                            IMPT 00000000    291 
_wai_tsk_tid                              IMPT 00000000    290 
monitor_error                             IMPT 00000000    318   401 
*** SH SERIES ASSEMBLER Ver. 2.0 ***      02/09/98 16:03:41                                                              PAGE    11

*** SECTION DATA LIST

SECTION                          ATTRIBUTE    SIZE             START

P                                REL-CODE    000000058        
