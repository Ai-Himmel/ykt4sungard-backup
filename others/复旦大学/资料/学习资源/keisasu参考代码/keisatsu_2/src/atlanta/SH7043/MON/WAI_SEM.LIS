*** SH SERIES ASSEMBLER Ver. 2.0 ***      01/28/98 12:59:01                                                              PAGE     1
PROGRAM NAME =

    1                               1     ;/*--------------------------------------------------------------------------*/
    2                               2     ;/*  プロジェクト : POPLAR/ANZU_L                                            */
    3                               3     ;/*  ファイル名   : wai_sem.src                                              */
    4                               4     ;/*  作成者       : 野瀬                                                     */
    5                               5     ;/*  日  付       : 1996/10/14                                               */
    6                               6     ;/*  概  要       : セマフォ管理                                             */
    7                               7     ;/*  修正履歴     :                                                          */
    8                               8     ;/*--------------------------------------------------------------------------*/
    9                               9     
   10                              10             .INCLUDE        "\src\atlanta\sh7043\define\def_mon.hdr"
   11                               1 I1  ;/*--------------------------------------------------------------------------*/
   12                               2 I1  ;/*  プロジェクト : RISC                                                     */
   13                               3 I1  ;/*  ファイル名   : def_mon.ih                                               */
   14                               4 I1  ;/*  作成者       : 野瀬                                                     */
   15                               5 I1  ;/*  日  付       : 95.11.01                                                 */
   16                               6 I1  ;/*  概  要       : モニタdefine定義                                         */
   17                               7 I1  ;/*  修正履歴     :                                                          */
   18                               8 I1  ;/*--------------------------------------------------------------------------*/
   19                               9 I1  ;-----------------------------------------------------------------------------
   20                              10 I1  ; ＣＣＲ マスクビット
   21                              11 I1  ;-----------------------------------------------------------------------------
   22          000000F0            12 I1  I_BIT_ON                .EQU    H'000000F0      ; 割込禁止 RISC
   23          0000030F            13 I1  I_BIT_OFF               .EQU    H'0000030F      ; 割込許可 RISC
   24                              14 I1  
   25                              15 I1  ;-----------------------------------------------------------------------------
   26                              16 I1  ; ワンショットタイマ値ＭＡＸ
   27                              17 I1  ;-----------------------------------------------------------------------------
   28          0000001A            18 I1  ONESHOT_VALUE_MAX               .EQU    26
   29                              19 I1  
   30                              20 I1  ;-----------------------------------------------------------------------------
   31                              21 I1  ; タスク イニシャルプログラムNo.
   32                              22 I1  ;-----------------------------------------------------------------------------
   33          00000000            23 I1  INIT_TID                .EQU    0
   34          00000000            24 I1  TSK_INITIAL             .EQU    0
   35          FFFFFC00            25 I1  TSK_INI_ADDR    .EQU    H'FFFFFC00              ; 初期化用スタック H'FFFFFC00-H'FFFFF000 3
   36                              26 I1                                                                                  ; def_mon.
   37                              27 I1  
   38                              28 I1  ;-----------------------------------------------------------------------------
   39                              29 I1  ; モニタ システム
   40                              30 I1  ;-----------------------------------------------------------------------------
   41                              31 I1  
   42          00000000            32 I1  FLAG_INIT_DATA                  .EQU    H'00000000      ; RISC
   43                              33 I1  
   44                              34 I1  ;TASK_STACK_START               .EQU    H'00809800
   45                              35 I1  
   46                              36 I1  ;LARGE_STACK_MAX                        .EQU    16                      ; RISC
   47                              37 I1  ;SMALL_STACK_MAX                        .EQU    32                      ; RISC
   48                              38 I1  ;TOTAL_STACK_MAX                        .EQU    (SMALL_STACK_MAX+LARGE_STACK_MAX)
   49                              39 I1  ;LARGE_STACK                            .EQU    512
   50                              40 I1  ;SMALL_STACK                            .EQU    256
   51                              41 I1  ;STACK_PUSH_SIZE                        .EQU    88                      ;       スタック退
   52                              42 I1  ;TOP_LARGE_ADDR                         .EQU    (TASK_STACK_START-(SMALL_STACK*SMALL_STACK
   53                              43 I1  ;TOP_SMALL_ADDR                         .EQU    (TASK_STACK_START-STACK_PUSH_SIZE)
   54          00000050            44 I1  STACK_PC_POSITION               .EQU    80
   55                              45 I1  ;STK_RTNVL_PT                   .EQU    76
   56                              46 I1  
   57                              47 I1  ;-----------------------------------------------------------------------------
*** SH SERIES ASSEMBLER Ver. 2.0 ***      01/28/98 12:59:01                                                              PAGE     2
PROGRAM NAME =

   58                              48 I1  ; TIB
   59                              49 I1  ;
   60                              50 I1  ; struct tib_table_data {
   61                              51 I1  ;       unsigned char *start_addr;
   62                              52 I1  ;       unsigned char *end_addr;
   63                              53 I1  ;       unsigned char stack_size;
   64                              54 I1  ;       unsigned char priority;
   65                              55 I1  ;       unsigned short reserve;
   66                              56 I1  ; };
   67                              57 I1  ;
   68                              58 I1  ;    ｮ｢｢｢｢｢｢｢｢｢｢｢ｲ
   69                              59 I1  ;  0 ､                      ､
   70                              60 I1  ;    ､                      ､
   71                              61 I1  ;  1 ､   タスクプログラム   ､
   72                              62 I1  ;    ､   スタートアドレス   ､
   73                              63 I1  ;  2 ､                      ､
   74                              64 I1  ;    ､                      ､
   75                              65 I1  ;  3 ､                      ､
   76                              66 I1  ;    ｾ｢｢｢｢｢｢｢｢｢｢｢ﾆ
   77                              67 I1  ;  4 ､                      ､
   78                              68 I1  ;    ､                      ､
   79                              69 I1  ;  5 ､   異常処理ルーチン   ､
   80                              70 I1  ;    ､   スタートアドレス   ､
   81                              71 I1  ;  6 ､                      ､
   82                              72 I1  ;    ､                      ､
   83                              73 I1  ;  7 ､                      ､
   84                              74 I1  ;    ｾ｢｢｢｢｢｢｢｢｢｢｢ﾆ
   85                              75 I1  ;  8 ､    スタックサイズ    ､  0:Large Stack  1:Small Stack
   86                              76 I1  ;    ｾ｢｢｢｢｢｢｢｢｢｢｢ﾆ
   87                              77 I1  ;  9 ､       優先順位       ､
   88                              78 I1  ;    ｾ｢｢｢｢｢｢｢｢｢｢｢ﾆ
   89                              79 I1  ; 10 ､       リザーブ       ､
   90                              80 I1  ;    ､                      ､
   91                              81 I1  ; 11 ､                      ､
   92                              82 I1  ;    ｶ｢｢｢｢｢｢｢｢｢｢｢ｺ
   93                              83 I1  ;
   94                              84 I1  ;      優先順位(0～255)
   95                              85 I1  ;      ※ 0を最も高い優先順位とします
   96                              86 I1  ;-----------------------------------------------------------------------------
   97                              87 I1  
   98          0000000C            88 I1  TIB_TBL_SIZE    .EQU    12
   99                              89 I1  
  100                              90 I1  ;-- オフセット --
  101          00000000            91 I1  TIB_START_ADR           .EQU    0
  102          00000004            92 I1  TIB_END_ADR                     .EQU    4
  103          00000008            93 I1  TIB_STACK_SIZE          .EQU    8
  104          00000009            94 I1  TIB_PRIORITY            .EQU    9
  105                              95 I1  
  106                              96 I1  ;-----------------------------------------------------------------------------
  107                              97 I1  ; TCB
  108                              98 I1  ;
  109                              99 I1  ; struct tcb_table_data {
  110                             100 I1  ;       unsigned char tsk_stat;
  111                             101 I1  ;       unsigned char prog_no;
  112                             102 I1  ;       unsigned char priority;
  113                             103 I1  ;       unsigned char tsk_link;
  114                             104 I1  ;       unsigned char run_link;
*** SH SERIES ASSEMBLER Ver. 2.0 ***      01/28/98 12:59:01                                                              PAGE     3
PROGRAM NAME =

  115                             105 I1  ;       unsigned char tsk_stat_tpo;
  116                             106 I1  ;       unsigned short reserve;         RISC追加 by T.Nose
  117                             107 I1  ;       unsigned long wait_param;
  118                             108 I1  ;       unsigned char *stack_addr;
  119                             109 I1  ; };
  120                             110 I1  ;
  121                             111 I1  ;    ｮ｢｢ﾎ｢｢｢｢｢｢｢｢ｲ
  122                             112 I1  ;  0 ､STS ､ WAIT時の原因   ､   STS           WAIT時の原因
  123                             113 I1  ;    ｾ｢｢ﾖ｢｢｢｢｢｢｢｢ﾆ   11 : 未使用    1 : 送信待ち
  124                             114 I1  ;  1 ､     プログラムNo.    ､   00 : WAIT      2 : 受信待ち
  125                             115 I1  ;    ｾ｢｢｢｢｢｢｢｢｢｢｢ﾆ   01 : READY     3 : セマフォ待ち
  126                             116 I1  ;  2 ､       優先順位       ､                  4 : タイマ待ち
  127                             117 I1  ;    ｾ｢｢｢｢｢｢｢｢｢｢｢ﾆ                  5 : イベントフラグ待ち
  128                             118 I1  ;  3 ､     タスクリンク     ､                  6 : ワンショットタイマ待ち
  129                             119 I1  ;    ｾ｢｢｢｢｢｢｢｢｢｢｢ﾆ
  130                             120 I1  ;  4 ､    強制ランタスク    ､
  131                             121 I1  ;    ｾ｢｢｢｢｢｢｢｢｢｢｢ﾆ
  132                             122 I1  ;  5 ､待ちタスクパラメータ a､
  133                             123 I1  ;    ｾ｢｢｢｢｢｢｢｢｢｢｢ﾆ
  134                             124 I1  ;  6 ､       リザーブ       ､  アドレス調整用 RISC追加 by T.Nose
  135                             125 I1  ;    ､                      ､
  136                             126 I1  ;  7 ､                      ､
  137                             127 I1  ;    ｾ｢｢｢｢｢｢｢｢｢｢｢ﾆ
  138                             128 I1  ;  8 ､                     b､  1.送信待ち
  139                             129 I1  ;    ､                      ､     a     : MBX No
  140                             130 I1  ;  9 ､                     c､     b～e  : 送信データアドレス
  141                             131 I1  ;    ､                      ､  2.受信待ち
  142                             132 I1  ; 10 ､                     d､     a     : MBX No
  143                             133 I1  ;    ､                      ､     b～e  : 受信データアドレス
  144                             134 I1  ; 11 ､                     e､  3.セマフォ待ち
  145                             135 I1  ;    ｾ｢｢｢｢｢｢｢｢｢｢｢ﾆ     a,d,e : 未使用
  146                             136 I1  ; 12 ､                      ､     b,c   : セマフォ No
  147                             137 I1  ;    ､                      ､  4.タイマ待ち
  148                             138 I1  ; 13 ､                      ､     a,d,e : 未使用
  149                             139 I1  ;    ､   スタックアドレス   ､     b,c   : タイマ値
  150                             140 I1  ; 14 ､                      ､  5.イベントフラグ待ち
  151                             141 I1  ;    ､                      ､     a     : EVENT No
  152                             142 I1  ; 15 ､                      ､     b～e  : 未使用
  153                             143 I1  ;    ｶ｢｢｢｢｢｢｢｢｢｢｢ｺ  6.ワンショットタイマ待ち
  154                             144 I1  ;                                   a～e  : 未使用
  155                             145 I1  
  156                             146 I1  
  157                             147 I1  
  158                             148 I1  
  159                             149 I1  ;      スタックアドレス  初期値 = (実際のアドレス - 32byte)
  160                             150 I1  ;
  161                             151 I1  ;-----------------------------------------------------------------------------
  162                             152 I1  
  163                             153 I1  ;-- オフセット --
  164          00000000           154 I1  TCB_STAT                        .EQU    0
  165          00000001           155 I1  TCB_PROGNO                      .EQU    1
  166          00000002           156 I1  TCB_PRIORITY            .EQU    2
  167          00000003           157 I1  TCB_LINK                        .EQU    3
  168          00000004           158 I1  TCB_RUN_LINK            .EQU    4
  169          00000005           159 I1  TCB_WAIT_PARAM          .EQU    5
  170          00000006           160 I1  TCB_RESERVE                     .EQU    6
  171          00000008           161 I1  TCB_WAIT_PARA1          .EQU    8
*** SH SERIES ASSEMBLER Ver. 2.0 ***      01/28/98 12:59:01                                                              PAGE     4
PROGRAM NAME =

  172          0000000A           162 I1  TCB_WAIT_PARA2          .EQU    10
  173          0000000C           163 I1  TCB_STACK_ADR           .EQU    12
  174                             164 I1  
  175                             165 I1  ;READY_TSK_MAX  .EQU    SMALL_STACK_MAX+LARGE_STACK_MAX
  176          00000010           166 I1  TCB_TBL_SIZE    .EQU    16
  177                             167 I1  
  178          000000FF           168 I1  NIL                             .EQU    H'ff
  179          0000FFFF           169 I1  WORDNIL                 .EQU    H'ffff
  180          FFFFFFFF           170 I1  LONGNIL                 .EQU    H'ffffffff
  181                             171 I1  
  182          00000000           172 I1  WAIT                    .EQU    H'00    ;RISC
  183          00000040           173 I1  READY                   .EQU    H'40    ;RISC
  184          000000C0           174 I1  NOT_USED                .EQU    H'C0    ;RISC
  185                             175 I1  
  186          00000001           176 I1  SND_WAIT                .EQU    H'01
  187          00000002           177 I1  RCV_WAIT                .EQU    H'02
  188          00000003           178 I1  WAIT_SEM                .EQU    H'03
  189          00000004           179 I1  WAIT_TIMER              .EQU    H'04
  190          00000005           180 I1  WAIT_EVENT              .EQU    H'05
  191          00000006           181 I1  WAIT_ONESHOT    .EQU    H'06
  192                             182 I1  
  193          000000FF           183 I1  ERROR                   .EQU    H'ff
  194                             184 I1  
  195                             185 I1  ;-----------------------------------------------------------------------------
  196                             186 I1  ; SCB
  197                             187 I1  ;
  198                             188 I1  ; struct scb_table_data {
  199                             189 I1  ;       unsigned char stat;
  200                             190 I1  ;       unsigned char tid;
  201                             191 I1  ; };
  202                             192 I1  ;
  203                             193 I1  ;    ｮ｢｢ﾎ｢｢｢｢｢｢｢｢ｲ
  204                             194 I1  ;  0 ､STS ､待ちタスクのTID ､
  205                             195 I1  ;    ｾ｢｢ﾖ｢｢｢｢｢｢｢｢ﾆ
  206                             196 I1  ;  1 ､   セマフォ獲得TID    ､
  207                             197 I1  ;    ｶ｢｢｢｢｢｢｢｢｢｢｢ｺ
  208                             198 I1  ;
  209                             199 I1  ;     STS
  210                             200 I1  ;          11 : 未使用
  211                             201 I1  ;          00 : セマフォ値=0
  212                             202 I1  ;          01 : セマフォ値=1
  213                             203 I1  ;
  214                             204 I1  ;     待ちタスクのTID
  215                             205 I1  ;          111111 : 待ちタスクなし
  216                             206 I1  ;
  217                             207 I1  ;-----------------------------------------------------------------------------
  218                             208 I1  
  219                             209 I1  ;SEMNO_MAX              .EQU    32
  220          00000002           210 I1  SCB_TBL_SIZE    .EQU    2
  221          0000007F           211 I1  SCB_INIT                .EQU    H'7F
  222                             212 I1  ;SCB_FREE               .EQU    H'3F
  223                             213 I1  
  224                             214 I1  ;MAX_SEMNO              .EQU    15      ; \src\atlanta\sh7043\define\def_semn.hに
  225                             215 I1                                                          ; 同一の定義有り。同値に保って下さ
  226                             216 I1  
  227                             217 I1  ;-- オフセット --
  228          00000000           218 I1  SCB_STAT                .EQU    0
*** SH SERIES ASSEMBLER Ver. 2.0 ***      01/28/98 12:59:01                                                              PAGE     5
PROGRAM NAME =

  229          00000001           219 I1  SCB_TID                 .EQU    1
  230                             220 I1  
  231                             221 I1  ;-----------------------------------------------------------------------------
  232                             222 I1  ; MCB
  233                             223 I1  ;
  234                             224 I1  ;    ｮ｢｢ﾎ｢｢｢｢｢｢ｲ
  235                             225 I1  ;    ､STS ､    TID     ､
  236                             226 I1  ;    ｶ｢｢ﾖ｢｢｢｢｢｢ｺ
  237                             227 I1  ;
  238                             228 I1  ;     STS                      TID
  239                             229 I1  ;     11 : 未使用              111111
  240                             230 I1  ;     10 : 待ちタスクなし      111111
  241                             231 I1  ;     00 : 送信待ちタスクあり  xxxxxx  待ちタスクの中で最も優先順位の高いTID
  242                             232 I1  ;     01 : 受信待ちタスクあり  xxxxxx  待ちタスクの中で最も優先順位の高いTID
  243                             233 I1  ;
  244                             234 I1  ;-----------------------------------------------------------------------------
  245                             235 I1  
  246                             236 I1  ;MBXNO_MAX              .EQU    256
  247                             237 I1  
  248                             238 I1  ;Task MAX Change T.Nose 1996/10/31
  249          0000007F           239 I1  NO_WAIMBX               .EQU    H'7F    ;<- H'BF
  250                             240 I1  ;SND_MBX                        .EQU    H'00
  251                             241 I1  ;RCV_MBX                        .EQU    H'40
  252                             242 I1  
  253                             243 I1  ;MAX_MBXNO              .EQU    70      ; \src\atlanta\sh7043\define\def_mbxn.h に
  254                             244 I1                                                          ; 同一の定義有り。同値に保って下さ
  255                             245 I1  
  256                             246 I1  ;-----------------------------------------------------------------------------
  257                             247 I1  ; ECB
  258                             248 I1  ;
  259                             249 I1  ;    ｮ｢｢｢｢｢｢｢｢｢ｲ
  260                             250 I1  ;    ､       TID        ､
  261                             251 I1  ;    ｶ｢｢｢｢｢｢｢｢｢ｺ
  262                             252 I1  ;
  263                             253 I1  ;     TID
  264                             254 I1  ;     11111111 : 待ちタスクなし
  265                             255 I1  ;     xxxxxxxx : 待ちタスクのTID
  266                             256 I1  ;
  267                             257 I1  ;-----------------------------------------------------------------------------
  268                             258 I1  
  269                             259 I1  ;;EVENT_MAX             .EQU    74
  270                             260 I1  ;EVENT_MAX              .EQU    94     ; Changed with def_evtn.h for R288F event by H.Kubo
  271                             261 I1  
  272                             262 I1  ;-----------------------------------------------------------------------------
  273                             263 I1  ; Ｃソースモニター用
  274                             264 I1  ;-----------------------------------------------------------------------------
  275          00000001           265 I1  MON_SUCCESS             .EQU    1       ;モニター本体処理の戻値（結果）
  276          00000000           266 I1  MON_FAILURE             .EQU    0
  277                             267 I1  
  278                              11             .INCLUDE        "\src\atlanta\sh7043\define\mon_mac.hdr"
  279                               1 I1  ;/*--------------------------------------------------------------------------*/
  280                               2 I1  ;/*  プロジェクト : POPLAR/ANZU_L                                            */
  281                               3 I1  ;/*  ファイル名   : mon_mac.hdr                                              */
  282                               4 I1  ;/*  作成者       : 野瀬                                                     */
  283                               5 I1  ;/*  日  付       : 1996/10/14                                               */
  284                               6 I1  ;/*  概  要       : モニタマクロ定義                                         */
  285                               7 I1  ;/*  修正履歴     :                                                          */
*** SH SERIES ASSEMBLER Ver. 2.0 ***      01/28/98 12:59:01                                                              PAGE     6
PROGRAM NAME =

  286                               8 I1  ;/*--------------------------------------------------------------------------*/
  287                               9 I1  
  288                              10 I1          .IMPORT         _MON_StackCheckTable
  289                              11 I1  
  290                              12 I1  ;-----------------------------------------------------------------------------
  291                              13 I1  ;  アセンブラ　マクロ定義
  292                              14 I1  ;-----------------------------------------------------------------------------
  293                              15 I1  ;
  294                              16 I1  ;/*****************************************************************************
  295                              17 I1  ;       module          :[ｺﾝﾃｷｽﾄを保存する（割込み禁止操作付き）]
  296                              18 I1  ;       function        :[
  297                              19 I1  ;               1.      割込禁止にする
  298                              20 I1  ;               2.      汎用ﾚｼﾞｽﾀ(R0ｰR14)､ｺﾝﾄﾛｰﾙﾚｼﾞｽﾀ(SR､GBR､VBR)､ｼｽﾃﾑﾚｼﾞｽﾀ(MACH､MACL､PR)
  299                              21 I1  ;                       ｽﾀｯｸへｾｰﾌﾞする
  300                              22 I1  ;       ]
  301                              23 I1  ;       return          :[なし]
  302                              24 I1  ;       common          :[]
  303                              25 I1  ;       comment         :[]
  304                              26 I1  ;       machine         :[SH7043]
  305                              27 I1  ;       language        :[ASMSH]
  306                              28 I1  ;       keyword         :[MON]
  307                              29 I1  ;       date            :[1995/10/25]
  308                              30 I1  ;       author          :[野瀬敏弘]
  309                              31 I1  ;*****************************************************************************/
  310                              32 I1  
  311                              33 I1          .MACRO  STCTX_REG
  312                              34 I1  
  313                              35 I1          MOV.L           R0,@-R15                                                ;PUSH.L R0
  314                              36 I1          MOV.L           R1,@-R15                                                ;PUSH.L R1
  315                              37 I1          STC                     SR,R0
  316                              38 I1          MOV.L           STCTX_REG_TBL\@,R1
  317                              39 I1          OR                      R1,R0
  318                              40 I1          LDC                     R0,SR                                                   ;
  319                              41 I1          MOV.L           R2,@-R15                                                ;PUSH.L R2
  320                              42 I1          MOV.L           R3,@-R15                                                ;PUSH.L R3
  321                              43 I1          MOV.L           R4,@-R15                                                ;PUSH.L R4
  322                              44 I1          MOV.L           R5,@-R15                                                ;PUSH.L R5
  323                              45 I1          MOV.L           R6,@-R15                                                ;PUSH.L R6
  324                              46 I1          MOV.L           R7,@-R15                                                ;PUSH.L R7
  325                              47 I1          MOV.L           R8,@-R15                                                ;PUSH.L R8
  326                              48 I1          MOV.L           R9,@-R15                                                ;PUSH.L R9
  327                              49 I1          MOV.L           R10,@-R15                                               ;PUSH.L R1
  328                              50 I1          MOV.L           R11,@-R15                                               ;PUSH.L R1
  329                              51 I1          MOV.L           R12,@-R15                                               ;PUSH.L R1
  330                              52 I1          MOV.L           R13,@-R15                                               ;PUSH.L R1
  331                              53 I1          MOV.L           R14,@-R15                                               ;PUSH.L R1
  332                              54 I1          STC.L           GBR,@-R15                                               ;PUSH.L GB
  333                              55 I1          STC.L           VBR,@-R15                                               ;PUSH.L VB
  334                              56 I1          STS.L           MACH,@-R15                                              ;PUSH.L MA
  335                              57 I1          STS.L           MACL,@-R15                                              ;PUSH.L MA
  336                              58 I1          STS.L           PR,@-R15                                                ;PUSH.L PR
  337                              59 I1  
  338                              60 I1          BRA                     stctx_reg_end\@
  339                              61 I1          NOP
  340                              62 I1  
  341                              63 I1          .ALIGN 4
  342                              64 I1  STCTX_REG_TBL\@:
*** SH SERIES ASSEMBLER Ver. 2.0 ***      01/28/98 12:59:01                                                              PAGE     7
PROGRAM NAME =

  343                              65 I1          .DATA.L         I_BIT_ON
  344                              66 I1  
  345                              67 I1  stctx_reg_end\@:
  346                              68 I1  
  347                              69 I1          .ENDM
  348                              70 I1  
  349                              71 I1  ;/*****************************************************************************
  350                              72 I1  ;       module          :[ｺﾝﾃｷｽﾄを保存する（割込み禁止操作なし）]
  351                              73 I1  ;       function        :[
  352                              74 I1  ;               1.      汎用ﾚｼﾞｽﾀ(R0ｰR14)､ｺﾝﾄﾛｰﾙﾚｼﾞｽﾀ(SR､GBR､VBR)､ｼｽﾃﾑﾚｼﾞｽﾀ(MACH､MACL､PR)
  353                              75 I1  ;                       ｽﾀｯｸへｾｰﾌﾞする
  354                              76 I1  ;       ]
  355                              77 I1  ;       return          :[なし]
  356                              78 I1  ;       common          :[]
  357                              79 I1  ;       comment         :[]
  358                              80 I1  ;       machine         :[SH7043]
  359                              81 I1  ;       language        :[ASMSH]
  360                              82 I1  ;       keyword         :[MON]
  361                              83 I1  ;       date            :[1996/11/12]
  362                              84 I1  ;       author          :[野瀬敏弘]
  363                              85 I1  ;*****************************************************************************/
  364                              86 I1  
  365                              87 I1          .MACRO  STCTX_REG_INT
  366                              88 I1  
  367                              89 I1          MOV.L           R0,@-R15                                                ;PUSH.L R0
  368                              90 I1          MOV.L           R1,@-R15                                                ;PUSH.L R1
  369                              91 I1          MOV.L           R2,@-R15                                                ;PUSH.L R2
  370                              92 I1          MOV.L           R3,@-R15                                                ;PUSH.L R3
  371                              93 I1          MOV.L           R4,@-R15                                                ;PUSH.L R4
  372                              94 I1          MOV.L           R5,@-R15                                                ;PUSH.L R5
  373                              95 I1          MOV.L           R6,@-R15                                                ;PUSH.L R6
  374                              96 I1          MOV.L           R7,@-R15                                                ;PUSH.L R7
  375                              97 I1          MOV.L           R8,@-R15                                                ;PUSH.L R8
  376                              98 I1          MOV.L           R9,@-R15                                                ;PUSH.L R9
  377                              99 I1          MOV.L           R10,@-R15                                               ;PUSH.L R1
  378                             100 I1          MOV.L           R11,@-R15                                               ;PUSH.L R1
  379                             101 I1          MOV.L           R12,@-R15                                               ;PUSH.L R1
  380                             102 I1          MOV.L           R13,@-R15                                               ;PUSH.L R1
  381                             103 I1          MOV.L           R14,@-R15                                               ;PUSH.L R1
  382                             104 I1          STC.L           GBR,@-R15                                               ;PUSH.L GB
  383                             105 I1          STC.L           VBR,@-R15                                               ;PUSH.L VB
  384                             106 I1          STS.L           MACH,@-R15                                              ;PUSH.L MA
  385                             107 I1          STS.L           MACL,@-R15                                              ;PUSH.L MA
  386                             108 I1          STS.L           PR,@-R15                                                ;PUSH.L PR
  387                             109 I1  
  388                             110 I1          .ENDM
  389                             111 I1  
  390                             112 I1  ;/*****************************************************************************
  391                             113 I1  ;       module          :[スタックチェック]
  392                             114 I1  ;       function        :[
  393                             115 I1  ;       ]
  394                             116 I1  ;       return          :[なし]
  395                             117 I1  ;       common          :[]
  396                             118 I1  ;       comment         :[
  397                             119 I1  ;
  398                             120 I1  ;               内部使用レジスタ
  399                             121 I1  ;                       R0 R12 R13 R14
*** SH SERIES ASSEMBLER Ver. 2.0 ***      01/28/98 12:59:01                                                              PAGE     8
PROGRAM NAME =

  400                             122 I1  ;               エラー処理時のみ
  401                             123 I1  ;                       R1 R2
  402                             124 I1  ;
  403                             125 I1  ;                       UDWORD MON_StackCheckTable 4ﾊﾞｲﾄｻｲｽﾞ
  404                             126 I1  ;
  405                             127 I1  ;       ]
  406                             128 I1  ;       machine         :[SH7043]
  407                             129 I1  ;       language        :[ASMSH]
  408                             130 I1  ;       keyword         :[MON]
  409                             131 I1  ;       date            :[1995/10/26]
  410                             132 I1  ;       author          :[野瀬敏弘]
  411                             133 I1  ;*****************************************************************************/
  412                             134 I1  
  413                             135 I1          .MACRO  STACK_CHECK     ERRJUMP
  414                             136 I1  
  415                             137 I1          MOV.L           real_run_tid_STKCHK\@,R12
  416                             138 I1          MOV.B           @R12,R13
  417                             139 I1          EXTU.B          R13,R13                                                 ; R13 = re
  418                             140 I1          SHLL2           R13
  419                             141 I1          MOV.L           MON_StackCheckTable_STKCHK\@,R0
  420                             142 I1          MOV.L           @(R0,R13),R14                                   ; R14 = MON_StackC
  421                             143 I1          CMP/HS          R14,R15
  422                             144 I1          BT                      stack_chk_error\@                               ; SP >= R1
  423                             145 I1          ADD                     #4,R13
  424                             146 I1          MOV.L           @(R0,R13),R14                                   ; R14 = MON_StackC
  425                             147 I1          CMP/HS          R14,R15
  426                             148 I1          BT                      stack_chk_end\@                                 ; SP >= R1
  427                             149 I1  
  428                             150 I1  stack_chk_error\@:
  429                             151 I1          MOV.L           stk_chk_err_STKCHK\@,R1
  430                             152 I1          MOV.L           stk_chk_err_STKCHK\@+4,R2
  431                             153 I1          JMP                     @R2
  432                             154 I1          NOP
  433                             155 I1  
  434                             156 I1          .ALIGN 4
  435                             157 I1  real_run_tid_STKCHK\@:
  436                             158 I1          .DATA.L         _real_run_tid
  437                             159 I1  MON_StackCheckTable_STKCHK\@:
  438                             160 I1          .DATA.L         _MON_StackCheckTable
  439                             161 I1  stk_chk_err_STKCHK\@:
  440                             162 I1          .DATA.L         H'FFFFFFFF
  441                             163 I1          .DATA.L         \ERRJUMP
  442                             164 I1  
  443                             165 I1  stack_chk_end\@
  444                             166 I1  
  445                             167 I1          .ENDM
  446                             168 I1  
  447                             169 I1  
  448                             170 I1  ;/*****************************************************************************
  449                             171 I1  ;       module          :[レジスタの復帰]
  450                             172 I1  ;       function        :[
  451                             173 I1  ;       ]
  452                             174 I1  ;       return          :[なし]
  453                             175 I1  ;       common          :[]
  454                             176 I1  ;       comment         :[
  455                             177 I1  ;       ]
  456                             178 I1  ;       machine         :[SH7043]
*** SH SERIES ASSEMBLER Ver. 2.0 ***      01/28/98 12:59:01                                                              PAGE     9
PROGRAM NAME =

  457                             179 I1  ;       language        :[ASMSH]
  458                             180 I1  ;       keyword         :[MON]
  459                             181 I1  ;       date            :[1995/11/15]
  460                             182 I1  ;       author          :[野瀬敏弘]
  461                             183 I1  ;*****************************************************************************/
  462                             184 I1  
  463                             185 I1          .MACRO  RSTR_REG
  464                             186 I1  
  465                             187 I1          LDS.L   @R15+,PR                        ;POP.L  PR
  466                             188 I1          LDS.L   @R15+,MACL                      ;POP.L  MACL
  467                             189 I1          LDS.L   @R15+,MACH                      ;POP.L  MACH
  468                             190 I1          LDC.L   @R15+,VBR                       ;POP.L  VBR
  469                             191 I1          LDC.L   @R15+,GBR                       ;POP.L  GBR
  470                             192 I1          MOV.L   @R15+,R14                       ;POP.L  R14
  471                             193 I1          MOV.L   @R15+,R13                       ;POP.L  R13
  472                             194 I1          MOV.L   @R15+,R12                       ;POP.L  R12
  473                             195 I1          MOV.L   @R15+,R11                       ;POP.L  R11
  474                             196 I1          MOV.L   @R15+,R10                       ;POP.L  R10
  475                             197 I1          MOV.L   @R15+,R9                        ;POP.L  R9
  476                             198 I1          MOV.L   @R15+,R8                        ;POP.L  R8
  477                             199 I1          MOV.L   @R15+,R7                        ;POP.L  R7
  478                             200 I1          MOV.L   @R15+,R6                        ;POP.L  R6
  479                             201 I1          MOV.L   @R15+,R5                        ;POP.L  R5
  480                             202 I1          MOV.L   @R15+,R4                        ;POP.L  R4
  481                             203 I1          MOV.L   @R15+,R3                        ;POP.L  R3
  482                             204 I1          MOV.L   @R15+,R2                        ;POP.L  R2
  483                             205 I1          MOV.L   @R15+,R1                        ;POP.L  R1
  484                             206 I1          MOV.L   @R15+,R0                        ;POP.L  R0
  485                             207 I1  
  486                             208 I1          .ENDM
  487                             209 I1  
  488                             210 I1  ;/*****************************************************************************
  489                             211 I1  ;       module          :[スタックポインタをＴＣＢにセーブする]
  490                             212 I1  ;       function        :[
  491                             213 I1  ;       ]
  492                             214 I1  ;       return          :[なし]
  493                             215 I1  ;       common          :[]
  494                             216 I1  ;       comment         :[
  495                             217 I1  ;       ]
  496                             218 I1  ;       machine         :[SH7043]
  497                             219 I1  ;       language        :[ASMSH]
  498                             220 I1  ;       keyword         :[MON]
  499                             221 I1  ;       date            :[1996/02/08]
  500                             222 I1  ;       author          :[野瀬敏弘]
  501                             223 I1  ;*****************************************************************************/
  502                             224 I1  
  503                             225 I1          .MACRO  STSP_REG
  504                             226 I1  
  505                             227 I1          MOV.L   real_run_tid_STKCHK\@,R2
  506                             228 I1          MOV.B   @R2,R1
  507                             229 I1          MOV             #TCB_TBL_SIZE,R8
  508                             230 I1          MULU    R1,R8                                                   ; real_run_tid * T
  509                             231 I1          MOV.L   tcb_STKCHK\@,R0
  510                             232 I1          STS             MACL,R2
  511                             233 I1          ADD             R2,R0
  512                             234 I1          MOV.L   R15,@(TCB_STACK_ADR,R0)                                 ; SPセーブ
  513                             235 I1          BRA             save_SP_end\@
*** SH SERIES ASSEMBLER Ver. 2.0 ***      01/28/98 12:59:01                                                              PAGE    10
PROGRAM NAME =

  514                             236 I1          NOP
  515                             237 I1  
  516                             238 I1          .ALIGN 4
  517                             239 I1  real_run_tid_STKCHK\@:
  518                             240 I1          .DATA.L         _real_run_tid
  519                             241 I1  tcb_STKCHK\@:
  520                             242 I1          .DATA.L         _tcb
  521                             243 I1  
  522                             244 I1  save_SP_end\@
  523                             245 I1  
  524                             246 I1          .ENDM
  525                             247 I1  
  526                             248 I1  ;/*****************************************************************************
  527                             249 I1  ;       module          :[スタックチェック]
  528                             250 I1  ;       function        :[
  529                             251 I1  ;       ]
  530                             252 I1  ;       return          :[なし]
  531                             253 I1  ;       common          :[
  532                             254 I1  ;               スタックチェックテーブルにはポインタによる間接アドレス参照で
  533                             255 I1  ;               アクセスします
  534                             256 I1  ;       ]
  535                             257 I1  ;       comment         :[
  536                             258 I1  ;
  537                             259 I1  ;               内部使用レジスタ
  538                             260 I1  ;                       R0 R12 R13 R14
  539                             261 I1  ;               エラー処理時のみ
  540                             262 I1  ;                       R1 R2
  541                             263 I1  ;
  542                             264 I1  ;                       UDWORD MON_StackCheckTable_p 4ﾊﾞｲﾄｻｲｽﾞ
  543                             265 I1  ;
  544                             266 I1  ;       ]
  545                             267 I1  ;       machine         :[SH7043]
  546                             268 I1  ;       language        :[ASMSH]
  547                             269 I1  ;       keyword         :[MON]
  548                             270 I1  ;       date            :[1997/04/16]
  549                             271 I1  ;       author          :[野瀬敏弘]
  550                             272 I1  ;*****************************************************************************/
  551                             273 I1  
  552                             274 I1          .MACRO  STACK_CHECK_P   ERRJUMP
  553                             275 I1  
  554                             276 I1          MOV.L           real_run_tid_STKCHK_P\@,R12
  555                             277 I1          MOV.B           @R12,R13
  556                             278 I1          EXTU.B          R13,R13                                                 ; R13 = re
  557                             279 I1          SHLL2           R13
  558                             280 I1  
  559                             281 I1  ;       MOV.L           MON_StackCheckTable_STKCHK\@,R0
  560                             282 I1  ;       下の２行に変更
  561                             283 I1          MOV.L           MON_StackCheckTable_p_STKCHK_P\@,R0
  562                             284 I1          MOV.L           @R0,R0
  563                             285 I1  
  564                             286 I1          MOV.L           @(R0,R13),R14                                   ; R14 = MON_StackC
  565                             287 I1          CMP/HS          R14,R15
  566                             288 I1          BT                      stack_chk_error_p\@                             ; SP >= R1
  567                             289 I1          ADD                     #4,R13
  568                             290 I1          MOV.L           @(R0,R13),R14                                   ; R14 = MON_StackC
  569                             291 I1          CMP/HS          R14,R15
  570                             292 I1          BT                      stack_chk_end_p\@                                       ;
*** SH SERIES ASSEMBLER Ver. 2.0 ***      01/28/98 12:59:01                                                              PAGE    11
PROGRAM NAME =

  571                             293 I1  
  572                             294 I1  stack_chk_error_p\@:
  573                             295 I1          MOV.L           stk_chk_err_STKCHK_P\@,R1
  574                             296 I1          JMP                     @R1
  575                             297 I1          NOP
  576                             298 I1  
  577                             299 I1          .ALIGN 4
  578                             300 I1  real_run_tid_STKCHK_P\@:
  579                             301 I1          .DATA.L         _real_run_tid
  580                             302 I1  ;MON_StackCheckTable_STKCHK\@:
  581                             303 I1  ;       .DATA.L         _MON_StackCheckTable
  582                             304 I1  stk_chk_err_STKCHK_P\@:
  583                             305 I1          .DATA.L         \ERRJUMP
  584                             306 I1  MON_StackCheckTable_p_STKCHK_P\@:
  585                             307 I1          .DATA.L         _MON_StackCheckTable_p
  586                             308 I1  
  587                             309 I1  stack_chk_end_p\@
  588                             310 I1  
  589                             311 I1          .ENDM
  590                             312 I1  
  591                             313 I1  ;/*****************************************************************************
  592                             314 I1  ;       module          :[スタックポインタをＴＣＢにセーブする]
  593                             315 I1  ;       function        :[
  594                             316 I1  ;       ]
  595                             317 I1  ;       return          :[なし]
  596                             318 I1  ;       common          :[]
  597                             319 I1  ;       comment         :[
  598                             320 I1  ;               ＴＣＢにはポインタによる間接アドレス参照でアクセスします
  599                             321 I1  ;       ]
  600                             322 I1  ;       machine         :[SH7043]
  601                             323 I1  ;       language        :[ASMSH]
  602                             324 I1  ;       keyword         :[MON]
  603                             325 I1  ;       date            :[1997/04/16]
  604                             326 I1  ;       author          :[野瀬敏弘]
  605                             327 I1  ;*****************************************************************************/
  606                             328 I1  
  607                             329 I1          .MACRO  STSP_REG_P
  608                             330 I1  
  609                             331 I1          MOV.L   real_run_tid_STSP_P\@,R2
  610                             332 I1          MOV.B   @R2,R1
  611                             333 I1          MOV             #TCB_TBL_SIZE,R8
  612                             334 I1          MULU    R1,R8                                                   ; real_run_tid * T
  613                             335 I1          MOV.L   tcbp_STSP_P\@,R0
  614                             336 I1          MOV.L   @R0,R0
  615                             337 I1          STS             MACL,R2
  616                             338 I1          ADD             R2,R0
  617                             339 I1          MOV.L   R15,@(TCB_STACK_ADR,R0)                                 ; SPセーブ
  618                             340 I1          BRA             end_STSP_P\@
  619                             341 I1          NOP
  620                             342 I1  
  621                             343 I1          .ALIGN 4
  622                             344 I1  real_run_tid_STSP_P\@:
  623                             345 I1          .DATA.L         _real_run_tid
  624                             346 I1  tcbp_STSP_P\@:
  625                             347 I1          .DATA.L         _tcb_p
  626                             348 I1  
  627                             349 I1  end_STSP_P\@
*** SH SERIES ASSEMBLER Ver. 2.0 ***      01/28/98 12:59:01                                                              PAGE    12
PROGRAM NAME =

  628                             350 I1  
  629                             351 I1          .ENDM
  630                             352 I1  
  631                             353 I1  ;/*****************************************************************************
  632                             354 I1  ;       module          :[割込み禁止 ＆ ポートＯＮ]
  633                             355 I1  ;       function        :[]
  634                             356 I1  ;       return          :[なし]
  635                             357 I1  ;       common          :[]
  636                             358 I1  ;       comment         :[]
  637                             359 I1  ;       machine         :[SH7043]
  638                             360 I1  ;       language        :[ASMSH]
  639                             361 I1  ;       keyword         :[MON]
  640                             362 I1  ;       date            :[1998/01/26]
  641                             363 I1  ;       author          :[野瀬敏弘]
  642                             364 I1  ;*****************************************************************************/
  643                             365 I1  
  644                             366 I1          .MACRO  INTDIS
  645                             367 I1  
  646                             368 I1  ;;;     MOV.L           R0,@-R15                                        ;PUSH.L R0 プッシ
  647                             369 I1          MOV.L           R1,@-R15                                        ;PUSH.L R1
  648                             370 I1          MOV.L           R2,@-R15                                        ;PUSH.L R2
  649                             371 I1  
  650                             372 I1          STC                     SR,R0
  651                             373 I1          MOV.L           INTDIS_TBL\@,R1
  652                             374 I1          OR                      R1,R0
  653                             375 I1          LDC                     R0,SR                                           ;割り込み
  654                             376 I1  
  655                             377 I1          MOV.L           INTDIS_TBL\@+4,R0
  656                             378 I1          MOV.W           INTDIS_TBL\@+D'12,R1
  657                             379 I1          MOV.W           @R0,R2
  658                             380 I1          OR                      R1,R2
  659                             381 I1          MOV.W           R2,@R0                                          ;SYS_COM_PortStatu
  660                             382 I1          MOV.L           INTDIS_TBL\@+8,R1
  661                             383 I1          MOV.W           R2,@R1                                          ;outpw(COM_PORT,SY
  662                             384 I1  
  663                             385 I1          MOV.L           @R15+,R2                                        ;POP.L  R2
  664                             386 I1          MOV.L           @R15+,R1                                        ;POP.L  R1
  665                             387 I1          MOV.L           @R15+,R0                                        ;POP.L  R0
  666                             388 I1          BRA                     INTDIS_END\@
  667                             389 I1          NOP
  668                             390 I1          .ALIGN 4
  669                             391 I1  INTDIS_TBL\@:
  670                             392 I1          .DATA.L         I_BIT_ON
  671                             393 I1          .DATA.L         _SYS_COM_PortStatus
  672                             394 I1          .DATA.L         H'00C203D0
  673                             395 I1          .DATA.W         H'0020
  674                             396 I1  INTDIS_END\@:
  675                             397 I1  
  676                             398 I1          .ENDM
  677                              12             .INCLUDE        "\src\atlanta\sh7043\ext_v\extv_mon.hdr"
  678                               1 I1  ;/*--------------------------------------------------------------------------*/
  679                               2 I1  ;/*  プロジェクト : POPLAR/ANZU_L                                            */
  680                               3 I1  ;/*  ファイル名   : extv_mon.hdr                                             */
  681                               4 I1  ;/*  作成者       : 野瀬敏弘                                                 */
  682                               5 I1  ;/*  日  付       : 1996/10/14                                               */
  683                               6 I1  ;/*  概  要       : モニタテーブル外部参照                                   */
  684                               7 I1  ;/*  修正履歴     :                                                          */
*** SH SERIES ASSEMBLER Ver. 2.0 ***      01/28/98 12:59:01                                                              PAGE    13
PROGRAM NAME =

  685                               8 I1  ;/*--------------------------------------------------------------------------*/
  686                               9 I1  
  687                              10 I1          .IMPORT         _real_run_tid
  688                              11 I1          .IMPORT         _top_ready_tid
  689                              12 I1          .IMPORT         _wai_tsk_tid
  690                              13 I1          .IMPORT         _wai_1shot_tid
  691                              14 I1          .IMPORT         _tib
  692                              15 I1          .IMPORT         _tcb_p
  693                              16 I1          .IMPORT         _scb_p
  694                              17 I1          .IMPORT         _ecb_p
  695                              18 I1          .IMPORT         _mcb_p
  696                              19 I1          .IMPORT         _MON_StackCheckTable_p
  697                              20 I1          .IMPORT         _MON_MAX_LARGE_TCB
  698                              21 I1          .IMPORT         _MON_MAX_SMALL_TCB
  699                              22 I1          .IMPORT         _MON_MAX_TCB
  700                              23 I1          .IMPORT         _MON_SIZE_LARGE_STACK
  701                              24 I1          .IMPORT         _MON_SIZE_SMALL_STACK
  702                              25 I1          .IMPORT         _MON_STACK_START_ADDR
  703                              26 I1          .IMPORT         _MON_TOP_LARGE_ADDR
  704                              27 I1          .IMPORT         _MON_TOP_SMALL_ADDR
  705                              28 I1          .IMPORT         _MON_MAX_SCB
  706                              29 I1          .IMPORT         _MON_MAX_SEMNO
  707                              30 I1          .IMPORT         _MON_MAX_MCB
  708                              31 I1          .IMPORT         _MON_MAX_MBXNO
  709                              32 I1          .IMPORT         _MON_MAX_ECB
  710                              33 I1  
  711                              34 I1  ; 以下の外部参照宣言は後程削除します
  712                              35 I1  ;       .IMPORT         _MON_DebugSwitch
  713                              36 I1  ;       .IMPORT         _tcb
  714                              37 I1  ;       .IMPORT         _scb
  715                              38 I1  ;       .IMPORT         _ecb
  716                              39 I1  ;       .IMPORT         _mcb
  717                              13     
  718                              14             .IMPORT         _del_ready_link_vec
  719                              15             .IMPORT         _rescheduler_vec
  720                              16             .IMPORT         monitor_error
  721                              17     ;割込み禁止期間測定用
  722                              18             .IMPORT         _SYS_COM_PortStatus
  723                              19     
  724                              20             .EXPORT         _wai_sem_irom
  725                              21             .EXPORT         _wai_sem_erom
  726                              22     
  727                              23     ;/*****************************************************************************
  728                              24     ;       module          :[資源を獲得します]
  729                              25     ;       function        :[
  730                              26     ;               1. セマフォ番号で示されるSCBのセマフォ値の値から、1を減算します。
  731                              27     ;               2. 減じた結果、セマフォ値が0以上であれば、このコールを行ったタスクは
  732                              28     ;                  セマフォを獲得し、Readyのままでいます。
  733                              29     ;               3. 負になる場合は、減じることはせず、このタスクはWaitになり、
  734                              30     ;                  セマフォ番号に対応するウェイトタスク・リスト(SCB)に登録されます。
  735                              31     ;       ]
  736                              32     ;       return          :[なし]
  737                              33     ;       common          :[_real_run_tid, _tcb, _scb]
  738                              34     ;       comment         :[
  739                              35     ;
  740                              36     ;               wai_sem(sem_no)    Get Semapho
  741                              37     ;               unsigned int sem_no;
*** SH SERIES ASSEMBLER Ver. 2.0 ***      01/28/98 12:59:01                                                              PAGE    14
PROGRAM NAME =

  742                              38     ;
  743                              39     ;               引き数レジスタ
  744                              40     ;                       R4:sem_no
  745                              41     ;               内部使用レジスタ
  746                              42     ;                       R0 R1 R2 R3 R5 R6 R7 R8 R9 R10
  747                              43     ;       ]
  748                              44     ;       machine         :[SH7043]
  749                              45     ;       language        :[ASMSH]
  750                              46     ;       keyword         :[MON]
  751                              47     ;       date            :[1995/11/01]
  752                              48     ;       author          :[野瀬敏弘]
  753                              49     ;*****************************************************************************/
  754                              50     ;/**************************/
  755                              51     ;/* ＳＨ７０４３内蔵ＲＯＭ */
  756                              52     ;/**************************/
  757 00000000                     53             .SECTION        MON,CODE,ALIGN=4
  758 00000000                     54     _wai_sem_irom:
  759 00000000 7FF8                55             ADD             #-8,R15
  760                              56     ;--------------------------------------------------------------
  761                              57             STCTX_REG                                       ;ﾏｸﾛ ﾚｼﾞｽﾀの保存
  762                                 M   
  763 00000002 2F06                   M           MOV.L           R0,@-R15                                                ;PUSH.L R0
  764 00000004 2F16                   M           MOV.L           R1,@-R15                                                ;PUSH.L R1
  765 00000006 0002                   M           STC                     SR,R0
  766 00000008 D10B                   M           MOV.L           STCTX_REG_TBL00000,R1
  767 0000000A 201B                   M           OR                      R1,R0
  768 0000000C 400E                   M           LDC                     R0,SR                                                   ;
  769 0000000E 2F26                   M           MOV.L           R2,@-R15                                                ;PUSH.L R2
  770 00000010 2F36                   M           MOV.L           R3,@-R15                                                ;PUSH.L R3
  771 00000012 2F46                   M           MOV.L           R4,@-R15                                                ;PUSH.L R4
  772 00000014 2F56                   M           MOV.L           R5,@-R15                                                ;PUSH.L R5
  773 00000016 2F66                   M           MOV.L           R6,@-R15                                                ;PUSH.L R6
  774 00000018 2F76                   M           MOV.L           R7,@-R15                                                ;PUSH.L R7
  775 0000001A 2F86                   M           MOV.L           R8,@-R15                                                ;PUSH.L R8
  776 0000001C 2F96                   M           MOV.L           R9,@-R15                                                ;PUSH.L R9
  777 0000001E 2FA6                   M           MOV.L           R10,@-R15                                               ;PUSH.L R1
  778 00000020 2FB6                   M           MOV.L           R11,@-R15                                               ;PUSH.L R1
  779 00000022 2FC6                   M           MOV.L           R12,@-R15                                               ;PUSH.L R1
  780 00000024 2FD6                   M           MOV.L           R13,@-R15                                               ;PUSH.L R1
  781 00000026 2FE6                   M           MOV.L           R14,@-R15                                               ;PUSH.L R1
  782 00000028 4F13                   M           STC.L           GBR,@-R15                                               ;PUSH.L GB
  783 0000002A 4F23                   M           STC.L           VBR,@-R15                                               ;PUSH.L VB
  784 0000002C 4F02                   M           STS.L           MACH,@-R15                                              ;PUSH.L MA
  785 0000002E 4F12                   M           STS.L           MACL,@-R15                                              ;PUSH.L MA
  786 00000030 4F22                   M           STS.L           PR,@-R15                                                ;PUSH.L PR
  787                                 M   
  788 00000032 A003                   M           BRA                     stctx_reg_end00000
  789 00000034 0009                   M           NOP
  790                                 M   
  791 00000038                        M           .ALIGN 4
  792 00000038                        M   STCTX_REG_TBL00000:
  793 00000038 000000F0               M           .DATA.L         I_BIT_ON
  794                                 M   
  795 0000003C                        M   stctx_reg_end00000:
  796                                 M   
  797                              58     ;--------------------------------------------------------------
  798 0000003C 60F3                59             MOV.L   R15,R0
*** SH SERIES ASSEMBLER Ver. 2.0 ***      01/28/98 12:59:01                                                              PAGE    15
PROGRAM NAME =

  799 0000003E 7050                60             ADD             #STACK_PC_POSITION,R0
  800 00000040 012A                61             STS             PR,R1
  801 00000042 2012                62             MOV.L   R1,@R0                          ;PR(=PC)をスタックへセーブ
  802                              63     
  803 00000044 7004                64             ADD             #4,R0                           ;INC.L  R0
  804 00000046 0102                65             STC             SR,R1
  805 00000048 D251                66             MOV.L   I_BIT_OFF_wai_sem_i,R2          ;R2 = 0x0000000F
  806 0000004A 2129                67             AND             R2,R1                           ;割込許可
  807 0000004C 2012                68             MOV.L   R1,@R0                          ;SRをスタックへセーブ
  808                              69     
  809                              70     ;--------------------------------------------------------------
  810                              71             STSP_REG_P                                      ;ﾏｸﾛ スタックポインタの保存
  811                                 M   
  812 0000004E D205                   M           MOV.L   real_run_tid_STSP_P00001,R2
  813 00000050 6120                   M           MOV.B   @R2,R1
  814 00000052 E810                   M           MOV             #TCB_TBL_SIZE,R8
  815 00000054 281E                   M           MULU    R1,R8                                                   ; real_run_tid * T
  816 00000056 D004                   M           MOV.L   tcbp_STSP_P00001,R0
  817 00000058 6002                   M           MOV.L   @R0,R0
  818 0000005A 021A                   M           STS             MACL,R2
  819 0000005C 302C                   M           ADD             R2,R0
  820 0000005E 10F3                   M           MOV.L   R15,@(TCB_STACK_ADR,R0)                                 ; SPセーブ
  821 00000060 A004                   M           BRA             end_STSP_P00001
  822 00000062 0009                   M           NOP
  823                                 M   
  824 00000064                        M           .ALIGN 4
  825 00000064                        M   real_run_tid_STSP_P00001:
  826 00000064 00000000               M           .DATA.L         _real_run_tid
  827 00000068                        M   tcbp_STSP_P00001:
  828 00000068 00000000               M           .DATA.L         _tcb_p
  829                                 M   
  830 0000006C                        M   end_STSP_P00001
  831                                 M   
  832                              72     ;--------------------------------------------------------------
  833                              73     ;--------------------------------------------------------------
  834                              74             STACK_CHECK_P   err_wai_sem_i           ;ﾏｸﾛ ﾀｽｸﾁｪｯｸ
  835                                 M   
  836 0000006C DC07                   M           MOV.L           real_run_tid_STKCHK_P00002,R12
  837 0000006E 6DC0                   M           MOV.B           @R12,R13
  838 00000070 6DDC                   M           EXTU.B          R13,R13                                                 ; R13 = re
  839 00000072 4D08                   M           SHLL2           R13
  840                                 M   
  841                                 M   ;       MOV.L           MON_StackCheckTable_STKCHK00002,R0
  842                                 M   ;       下の２行に変更
  843 00000074 D007                   M           MOV.L           MON_StackCheckTable_p_STKCHK_P00002,R0
  844 00000076 6002                   M           MOV.L           @R0,R0
  845                                 M   
  846 00000078 0EDE                   M           MOV.L           @(R0,R13),R14                                   ; R14 = MON_StackC
  847 0000007A 3FE2                   M           CMP/HS          R14,R15
  848 0000007C 8903                   M           BT                      stack_chk_error_p00002                          ; SP >= R1
  849 0000007E 7D04                   M           ADD                     #4,R13
  850 00000080 0EDE                   M           MOV.L           @(R0,R13),R14                                   ; R14 = MON_StackC
  851 00000082 3FE2                   M           CMP/HS          R14,R15
  852 00000084 8908                   M           BT                      stack_chk_end_p00002                                    ;
  853                                 M   
  854 00000086                        M   stack_chk_error_p00002:
  855 00000086 D102                   M           MOV.L           stk_chk_err_STKCHK_P00002,R1
*** SH SERIES ASSEMBLER Ver. 2.0 ***      01/28/98 12:59:01                                                              PAGE    16
PROGRAM NAME =

  856 00000088 412B                   M           JMP                     @R1
  857 0000008A 0009                   M           NOP
  858                                 M   
  859 0000008C                        M           .ALIGN 4
  860 0000008C                        M   real_run_tid_STKCHK_P00002:
  861 0000008C 00000000               M           .DATA.L         _real_run_tid
  862                                 M   ;MON_StackCheckTable_STKCHK00002:
  863                                 M   ;       .DATA.L         _MON_StackCheckTable
  864 00000090                        M   stk_chk_err_STKCHK_P00002:
  865 00000090 00000000               M           .DATA.L         err_wai_sem_i
  866 00000094                        M   MON_StackCheckTable_p_STKCHK_P00002:
  867 00000094 00000000               M           .DATA.L         _MON_StackCheckTable_p
  868                                 M   
  869 00000098                        M   stack_chk_end_p00002
  870                                 M   
  871                              75     ;--------------------------------------------------------------
  872                              76     
  873                              77     ;入力 R1:資源を待つTID
  874                              78     ;     R2:資源を待つタスクのTCBのオフセットアドレス
  875                              79     ;     R4:セマフォ番号
  876 00000098 D343                80             MOV.L   MON_MAX_SCB_waisem_i,R3
  877 0000009A 6330                81             MOV.B   @R3,R3
  878 0000009C 3346                82             CMP/HI  R4,R3
  879 0000009E 8902                83             BT              wai_sem00_i     ; SEMNO_MAX > sem_no -> wai_sem00
  880 000000A0                     84     err_wai_sem_i:
  881 000000A0 D13C                85             MOV.L   monitor_error_wai_sem_i,R1
  882 000000A2 412B                86             JMP             @R1
  883 000000A4 0009                87             NOP
  884                              88     
  885 000000A6                     89     wai_sem00_i:
  886 000000A6 6343                90             MOV             R4,R3
  887 000000A8 4300                91             SHLL    R3
  888 000000AA D53D                92             MOV.L   scbp_waisem_i,R5
  889 000000AC 6552                93             MOV.L   @R5,R5
  890 000000AE 335C                94             ADD             R5,R3
  891 000000B0 8430                95             MOV.B   @(SCB_STAT,R3),R0       ; R0 = scb[sem_no].stat
  892 000000B2 88FF                96             CMP/EQ  #H'FF,R0
  893 000000B4 89F4                97             BT              err_wai_sem_i                   ; scb[sem_no].stat == 0xFF（セマフ
  894 000000B6 8431                98             MOV.B   @(SCB_TID,R3),R0        ; R0 = scb[sem_no].tid
  895 000000B8 88FF                99             CMP/EQ  #H'FF,R0
  896 000000BA 8B19               100             BF              sem_val0_i                      ; scb[sem_no].tid != 0xFF（セマフ
  897                             101     
  898 000000BC                    102     get_sem_i:
  899                             103     ; セマフォ獲得
  900                             104     ;入力 R1:real_run_tid
  901                             105     ;     R3:scb[sem_no]のアドレス
  902 000000BC E07F               106             MOV             #SCB_INIT,R0
  903 000000BE 8030               107             MOV.B   R0,@(SCB_STAT,R3)       ; scb[sem_no].stat = SCB_INIT(0x7F)
  904 000000C0 6013               108             MOV             R1,R0
  905 000000C2 8031               109             MOV.B   R0,@(SCB_TID,R3)        ; scb[sem_no].tid = real_run_tid
  906                             110     
  907                             111     ;--------------------------------------------------------------
  908                             112             RSTR_REG                                        ;ﾏｸﾛ ﾚｼﾞｽﾀﾎﾟｯﾌﾟ
  909                                 M   
  910 000000C4 4F26                   M           LDS.L   @R15+,PR                        ;POP.L  PR
  911 000000C6 4F16                   M           LDS.L   @R15+,MACL                      ;POP.L  MACL
  912 000000C8 4F06                   M           LDS.L   @R15+,MACH                      ;POP.L  MACH
*** SH SERIES ASSEMBLER Ver. 2.0 ***      01/28/98 12:59:01                                                              PAGE    17
PROGRAM NAME =

  913 000000CA 4F27                   M           LDC.L   @R15+,VBR                       ;POP.L  VBR
  914 000000CC 4F17                   M           LDC.L   @R15+,GBR                       ;POP.L  GBR
  915 000000CE 6EF6                   M           MOV.L   @R15+,R14                       ;POP.L  R14
  916 000000D0 6DF6                   M           MOV.L   @R15+,R13                       ;POP.L  R13
  917 000000D2 6CF6                   M           MOV.L   @R15+,R12                       ;POP.L  R12
  918 000000D4 6BF6                   M           MOV.L   @R15+,R11                       ;POP.L  R11
  919 000000D6 6AF6                   M           MOV.L   @R15+,R10                       ;POP.L  R10
  920 000000D8 69F6                   M           MOV.L   @R15+,R9                        ;POP.L  R9
  921 000000DA 68F6                   M           MOV.L   @R15+,R8                        ;POP.L  R8
  922 000000DC 67F6                   M           MOV.L   @R15+,R7                        ;POP.L  R7
  923 000000DE 66F6                   M           MOV.L   @R15+,R6                        ;POP.L  R6
  924 000000E0 65F6                   M           MOV.L   @R15+,R5                        ;POP.L  R5
  925 000000E2 64F6                   M           MOV.L   @R15+,R4                        ;POP.L  R4
  926 000000E4 63F6                   M           MOV.L   @R15+,R3                        ;POP.L  R3
  927 000000E6 62F6                   M           MOV.L   @R15+,R2                        ;POP.L  R2
  928 000000E8 61F6                   M           MOV.L   @R15+,R1                        ;POP.L  R1
  929 000000EA 60F6                   M           MOV.L   @R15+,R0                        ;POP.L  R0
  930                                 M   
  931                             113     ;--------------------------------------------------------------
  932 000000EC 002B               114             RTE
  933 000000EE 0009               115             NOP
  934                             116     
  935 000000F0                    117     sem_val0_i:                                             ; セマフォ解放待ち (00:セマフォ使
  936                             118     ;入力 R2:real_run_tidのオフセットアドレス
  937                             119     ;     R4:sem_no
  938 000000F0 E303               120             MOV             #WAIT_SEM,R3
  939 000000F2 D02C               121             MOV.L   tcbp_waisem_i,R0
  940 000000F4 6002               122             MOV.L   @R0,R0
  941 000000F6 0234               123             MOV.B   R3,@(R0,R2)                     ; tcb[real_run_tid].tsk_stat = WAIT_SEM
  942 000000F8 7008               124             ADD             #TCB_WAIT_PARA1,R0
  943 000000FA 0245               125             MOV.W   R4,@(R0,R2)                     ; tcb[real_run_tid].wait_param.semno = sem
  944 000000FC D326               126             MOV.L   del_ready_link_wai_sem_i,R3
  945 000000FE 6332               127             MOV.L   @R3,R3
  946 00000100 430B               128             JSR             @R3
  947 00000102 0009               129             NOP
  948 00000104 6543               130             MOV             R4,R5
  949 00000106 4500               131             SHLL    R5
  950 00000108 D025               132             MOV.L   scbp_waisem_i,R0
  951 0000010A 6002               133             MOV.L   @R0,R0
  952 0000010C 350C               134             ADD             R0,R5
  953 0000010E 8450               135             MOV.B   @(SCB_STAT,R5),R0       ; R0 = scb[sem_no].stat
  954 00000110 887F               136             CMP/EQ  #SCB_INIT,R0
  955 00000112 8932               137             BT              wai_sem01_i                     ; scb[sem_no].stat == SCB_INIT(0x7
  956                             138     
  957 00000114 E810               139             MOV             #TCB_TBL_SIZE,R8
  958 00000116 280E               140             MULU    R0,R8
  959 00000118 6603               141             MOV             R0,R6           ; scb[sem_no].statをR6にセーブ
  960 0000011A 071A               142             STS             MACL,R7
  961 0000011C D021               143             MOV.L   tcbp_waisem_i,R0
  962 0000011E 6002               144             MOV.L   @R0,R0
  963 00000120 7002               145             ADD             #TCB_PRIORITY,R0
  964 00000122 097C               146             MOV.B   @(R0,R7),R9                     ; R9 = tcb[scb[sem_no].stat].priority
  965 00000124 0A2C               147             MOV.B   @(R0,R2),R10            ; R10 = tcb[real_run_tid].priority
  966 00000126 39A6               148             CMP/HI  R10,R9
  967 00000128 8920               149             BT              wai_sem02_i                     ; scb wait priority > run priority
  968                             150     
  969 0000012A 6573               151             MOV             R7,R5
*** SH SERIES ASSEMBLER Ver. 2.0 ***      01/28/98 12:59:01                                                              PAGE    18
PROGRAM NAME =

  970 0000012C                    152     wai_sem05_i:
  971 0000012C D01D               153             MOV.L   tcbp_waisem_i,R0
  972 0000012E 6002               154             MOV.L   @R0,R0
  973 00000130 7003               155             ADD             #TCB_LINK,R0
  974 00000132 065C               156             MOV.B   @(R0,R5),R6
  975 00000134 E8FF               157             MOV             #NIL,R8
  976 00000136 3680               158             CMP/EQ  R8,R6
  977 00000138 8912               159             BT              wai_sem03_i
  978                             160     
  979 0000013A E810               161             MOV             #TCB_TBL_SIZE,R8
  980 0000013C 286E               162             MULU    R6,R8
  981 0000013E 071A               163             STS             MACL,R7
  982 00000140 D018               164             MOV.L   tcbp_waisem_i,R0
  983 00000142 6002               165             MOV.L   @R0,R0
  984 00000144 7002               166             ADD             #TCB_PRIORITY,R0
  985 00000146 097C               167             MOV.B   @(R0,R7),R9
  986 00000148 0A2C               168             MOV.B   @(R0,R2),R10
  987 0000014A 39A6               169             CMP/HI  R10,R9                          ; scb wait priority > run priority
  988 0000014C 8901               170             BT              wai_sem04_i
  989 0000014E AFED               171             BRA             wai_sem05_i
  990 00000150 6573               172             MOV             R7,R5
  991                             173     
  992 00000152                    174     wai_sem04_i:                                    ; scbの中間に接続
  993 00000152 D014               175             MOV.L   tcbp_waisem_i,R0
  994 00000154 6002               176             MOV.L   @R0,R0
  995 00000156 7003               177             ADD             #TCB_LINK,R0
  996 00000158 065C               178             MOV.B   @(R0,R5),R6
  997 0000015A 0514               179             MOV.B   R1,@(R0,R5)
  998 0000015C A014               180             BRA             wai_sem_ok_i
  999 0000015E 0264               181             MOV.B   R6,@(R0,R2)
 1000                             182     
 1001 00000160                    183     wai_sem03_i:                                    ; scbの最後に接続
 1002 00000160 D010               184             MOV.L   tcbp_waisem_i,R0
 1003 00000162 6002               185             MOV.L   @R0,R0
 1004 00000164 7003               186             ADD             #TCB_LINK,R0
 1005 00000166 0514               187             MOV.B   R1,@(R0,R5)
 1006 00000168 A00E               188             BRA             wai_sem_ok_i
 1007 0000016A 0264               189             MOV.B   R6,@(R0,R2)
 1008                             190     
 1009 0000016C                    191     wai_sem02_i:
 1010                             192     ; scbの先頭に接続
 1011                             193     ;入力 R1:real_run_tid
 1012                             194     ;     R5:scb[sem_no]のアドレス
 1013                             195     ;     R6:scb[sem_no].stat セマフォ待ちタスクのＩＤ
 1014 0000016C 6013               196             MOV             R1,R0
 1015 0000016E 8050               197             MOV.B   R0,@(SCB_STAT,R5)       ; scb[sem_no].stat = real_run_tid
 1016 00000170 D00C               198             MOV.L   tcbp_waisem_i,R0
 1017 00000172 6002               199             MOV.L   @R0,R0
 1018 00000174 7003               200             ADD             #TCB_LINK,R0
 1019 00000176 A007               201             BRA             wai_sem_ok_i
 1020 00000178 0264               202             MOV.B   R6,@(R0,R2)                     ; tcb[real_run_tid].tsk_link = R6
 1021                             203     
 1022 0000017A                    204     wai_sem01_i                                             ; 待ちタスク無し
 1023                             205     ;入力 R1:real_run_tid
 1024                             206     ;     R5:scb[sem_no]のアドレス
 1025 0000017A 6013               207             MOV             R1,R0
 1026 0000017C 8050               208             MOV.B   R0,@(SCB_STAT,R5)       ; scb[sem_no].stat = real_run_tid
*** SH SERIES ASSEMBLER Ver. 2.0 ***      01/28/98 12:59:01                                                              PAGE    19
PROGRAM NAME =

 1027 0000017E E6FF               209             MOV             #NIL,R6
 1028 00000180 D008               210             MOV.L   tcbp_waisem_i,R0
 1029 00000182 6002               211             MOV.L   @R0,R0
 1030 00000184 7003               212             ADD             #TCB_LINK,R0
 1031 00000186 0264               213             MOV.B   R6,@(R0,R2)                     ; tcb[real_run_tid].tsk_link = 0xFF
 1032                             214     
 1033 00000188                    215     wai_sem_ok_i:
 1034 00000188 D004               216             MOV.L   rescheduler_wai_sem_i,R0
 1035 0000018A 6002               217             MOV.L   @R0,R0
 1036 0000018C 402B               218             JMP             @R0
 1037 0000018E 0009               219             NOP
 1038                             220     
 1039 00000190                    221             .ALIGN 4
 1040 00000190                    222     I_BIT_OFF_wai_sem_i:
 1041 00000190 0000030F           223             .DATA.L I_BIT_OFF
 1042 00000194                    224     monitor_error_wai_sem_i:
 1043 00000194 00000000           225             .DATA.L monitor_error
 1044 00000198                    226     del_ready_link_wai_sem_i:
 1045 00000198 00000000           227             .DATA.L _del_ready_link_vec
 1046 0000019C                    228     rescheduler_wai_sem_i:
 1047 0000019C 00000000           229             .DATA.L _rescheduler_vec
 1048 000001A0                    230     scbp_waisem_i:
 1049 000001A0 00000000           231             .DATA.L _scb_p
 1050 000001A4                    232     tcbp_waisem_i:
 1051 000001A4 00000000           233             .DATA.L _tcb_p
 1052 000001A8                    234     MON_MAX_SCB_waisem_i:
 1053 000001A8 00000000           235             .DATA.L _MON_MAX_SCB
 1054                             236     
 1055                             237     ;/****************/
 1056                             238     ;/* 外付けＲＯＭ */
 1057                             239     ;/****************/
 1058 00000000                    240             .SECTION        P,CODE,ALIGN=4
 1059 00000000                    241     _wai_sem_erom:
 1060 00000000 7FF8               242             ADD             #-8,R15
 1061                             243     ;--------------------------------------------------------------
 1062                             244             STCTX_REG                                       ;ﾏｸﾛ ﾚｼﾞｽﾀの保存
 1063                                 M   
 1064 00000002 2F06                   M           MOV.L           R0,@-R15                                                ;PUSH.L R0
 1065 00000004 2F16                   M           MOV.L           R1,@-R15                                                ;PUSH.L R1
 1066 00000006 0002                   M           STC                     SR,R0
 1067 00000008 D10B                   M           MOV.L           STCTX_REG_TBL00003,R1
 1068 0000000A 201B                   M           OR                      R1,R0
 1069 0000000C 400E                   M           LDC                     R0,SR                                                   ;
 1070 0000000E 2F26                   M           MOV.L           R2,@-R15                                                ;PUSH.L R2
 1071 00000010 2F36                   M           MOV.L           R3,@-R15                                                ;PUSH.L R3
 1072 00000012 2F46                   M           MOV.L           R4,@-R15                                                ;PUSH.L R4
 1073 00000014 2F56                   M           MOV.L           R5,@-R15                                                ;PUSH.L R5
 1074 00000016 2F66                   M           MOV.L           R6,@-R15                                                ;PUSH.L R6
 1075 00000018 2F76                   M           MOV.L           R7,@-R15                                                ;PUSH.L R7
 1076 0000001A 2F86                   M           MOV.L           R8,@-R15                                                ;PUSH.L R8
 1077 0000001C 2F96                   M           MOV.L           R9,@-R15                                                ;PUSH.L R9
 1078 0000001E 2FA6                   M           MOV.L           R10,@-R15                                               ;PUSH.L R1
 1079 00000020 2FB6                   M           MOV.L           R11,@-R15                                               ;PUSH.L R1
 1080 00000022 2FC6                   M           MOV.L           R12,@-R15                                               ;PUSH.L R1
 1081 00000024 2FD6                   M           MOV.L           R13,@-R15                                               ;PUSH.L R1
 1082 00000026 2FE6                   M           MOV.L           R14,@-R15                                               ;PUSH.L R1
 1083 00000028 4F13                   M           STC.L           GBR,@-R15                                               ;PUSH.L GB
*** SH SERIES ASSEMBLER Ver. 2.0 ***      01/28/98 12:59:01                                                              PAGE    20
PROGRAM NAME =

 1084 0000002A 4F23                   M           STC.L           VBR,@-R15                                               ;PUSH.L VB
 1085 0000002C 4F02                   M           STS.L           MACH,@-R15                                              ;PUSH.L MA
 1086 0000002E 4F12                   M           STS.L           MACL,@-R15                                              ;PUSH.L MA
 1087 00000030 4F22                   M           STS.L           PR,@-R15                                                ;PUSH.L PR
 1088                                 M   
 1089 00000032 A003                   M           BRA                     stctx_reg_end00003
 1090 00000034 0009                   M           NOP
 1091                                 M   
 1092 00000038                        M           .ALIGN 4
 1093 00000038                        M   STCTX_REG_TBL00003:
 1094 00000038 000000F0               M           .DATA.L         I_BIT_ON
 1095                                 M   
 1096 0000003C                        M   stctx_reg_end00003:
 1097                                 M   
 1098                             245     ;--------------------------------------------------------------
 1099                             246     
 1100                             247     ;割込み禁止期間測定用
 1101                             248     ;ポートをＯＮする
 1102 0000003C D034               249             MOV.L   PORT_ADR_DATA,R0
 1103 0000003E 916B               250             MOV.W   PORT_ADR_DATA+8,R1
 1104 00000040 6201               251             MOV.W   @R0,R2
 1105 00000042 221B               252             OR              R1,R2
 1106 00000044 2021               253             MOV.W   R2,@R0          ; SYS_COM_Port_Status |= 0x0020
 1107 00000046 D133               254             MOV.L   PORT_ADR_DATA+4,R1
 1108 00000048 2121               255             MOV.W   R2,@R1          ; outpw(COM_PORT,SYS_COM_PortStatus)
 1109                             256     ;ここまで
 1110                             257     
 1111 0000004A 60F3               258             MOV.L   R15,R0
 1112 0000004C 7050               259             ADD             #STACK_PC_POSITION,R0
 1113 0000004E 012A               260             STS             PR,R1
 1114 00000050 2012               261             MOV.L   R1,@R0                          ;PR(=PC)をスタックへセーブ
 1115                             262     
 1116 00000052 7004               263             ADD             #4,R0                           ;INC.L  R0
 1117 00000054 0102               264             STC             SR,R1
 1118 00000056 D259               265             MOV.L   I_BIT_OFF_wai_sem_e,R2          ;R2 = 0x0000000F
 1119 00000058 2129               266             AND             R2,R1                           ;割込許可
 1120 0000005A 2012               267             MOV.L   R1,@R0                          ;SRをスタックへセーブ
 1121                             268     
 1122                             269     ;--------------------------------------------------------------
 1123                             270             STSP_REG_P                                      ;ﾏｸﾛ スタックポインタの保存
 1124                                 M   
 1125 0000005C D205                   M           MOV.L   real_run_tid_STSP_P00004,R2
 1126 0000005E 6120                   M           MOV.B   @R2,R1
 1127 00000060 E810                   M           MOV             #TCB_TBL_SIZE,R8
 1128 00000062 281E                   M           MULU    R1,R8                                                   ; real_run_tid * T
 1129 00000064 D004                   M           MOV.L   tcbp_STSP_P00004,R0
 1130 00000066 6002                   M           MOV.L   @R0,R0
 1131 00000068 021A                   M           STS             MACL,R2
 1132 0000006A 302C                   M           ADD             R2,R0
 1133 0000006C 10F3                   M           MOV.L   R15,@(TCB_STACK_ADR,R0)                                 ; SPセーブ
 1134 0000006E A005                   M           BRA             end_STSP_P00004
 1135 00000070 0009                   M           NOP
 1136                                 M   
 1137 00000074                        M           .ALIGN 4
 1138 00000074                        M   real_run_tid_STSP_P00004:
 1139 00000074 00000000               M           .DATA.L         _real_run_tid
 1140 00000078                        M   tcbp_STSP_P00004:
*** SH SERIES ASSEMBLER Ver. 2.0 ***      01/28/98 12:59:01                                                              PAGE    21
PROGRAM NAME =

 1141 00000078 00000000               M           .DATA.L         _tcb_p
 1142                                 M   
 1143 0000007C                        M   end_STSP_P00004
 1144                                 M   
 1145                             271     ;--------------------------------------------------------------
 1146                             272     ;--------------------------------------------------------------
 1147                             273             STACK_CHECK_P   err_wai_sem_e           ;ﾏｸﾛ ﾀｽｸﾁｪｯｸ
 1148                                 M   
 1149 0000007C DC07                   M           MOV.L           real_run_tid_STKCHK_P00005,R12
 1150 0000007E 6DC0                   M           MOV.B           @R12,R13
 1151 00000080 6DDC                   M           EXTU.B          R13,R13                                                 ; R13 = re
 1152 00000082 4D08                   M           SHLL2           R13
 1153                                 M   
 1154                                 M   ;       MOV.L           MON_StackCheckTable_STKCHK00005,R0
 1155                                 M   ;       下の２行に変更
 1156 00000084 D007                   M           MOV.L           MON_StackCheckTable_p_STKCHK_P00005,R0
 1157 00000086 6002                   M           MOV.L           @R0,R0
 1158                                 M   
 1159 00000088 0EDE                   M           MOV.L           @(R0,R13),R14                                   ; R14 = MON_StackC
 1160 0000008A 3FE2                   M           CMP/HS          R14,R15
 1161 0000008C 8903                   M           BT                      stack_chk_error_p00005                          ; SP >= R1
 1162 0000008E 7D04                   M           ADD                     #4,R13
 1163 00000090 0EDE                   M           MOV.L           @(R0,R13),R14                                   ; R14 = MON_StackC
 1164 00000092 3FE2                   M           CMP/HS          R14,R15
 1165 00000094 8908                   M           BT                      stack_chk_end_p00005                                    ;
 1166                                 M   
 1167 00000096                        M   stack_chk_error_p00005:
 1168 00000096 D102                   M           MOV.L           stk_chk_err_STKCHK_P00005,R1
 1169 00000098 412B                   M           JMP                     @R1
 1170 0000009A 0009                   M           NOP
 1171                                 M   
 1172 0000009C                        M           .ALIGN 4
 1173 0000009C                        M   real_run_tid_STKCHK_P00005:
 1174 0000009C 00000000               M           .DATA.L         _real_run_tid
 1175                                 M   ;MON_StackCheckTable_STKCHK00005:
 1176                                 M   ;       .DATA.L         _MON_StackCheckTable
 1177 000000A0                        M   stk_chk_err_STKCHK_P00005:
 1178 000000A0 00000000               M           .DATA.L         err_wai_sem_e
 1179 000000A4                        M   MON_StackCheckTable_p_STKCHK_P00005:
 1180 000000A4 00000000               M           .DATA.L         _MON_StackCheckTable_p
 1181                                 M   
 1182 000000A8                        M   stack_chk_end_p00005
 1183                                 M   
 1184                             274     ;--------------------------------------------------------------
 1185                             275     
 1186                             276     ;入力 R1:資源を待つTID
 1187                             277     ;     R2:資源を待つタスクのTCBのオフセットアドレス
 1188                             278     ;     R4:セマフォ番号
 1189                             279     ;       MOV             #SEMNO_MAX,R3
 1190                             280     ;FOR POINTER ACCESS
 1191 000000A8 D34A               281             MOV.L   MON_MAX_SCB_waisem_e,R3
 1192 000000AA 6330               282             MOV.B   @R3,R3
 1193                             283     
 1194 000000AC 3346               284             CMP/HI  R4,R3
 1195 000000AE 8902               285             BT              wai_sem00_e     ; SEMNO_MAX > sem_no -> wai_sem00
 1196 000000B0                    286     err_wai_sem_e:
 1197 000000B0 D143               287             MOV.L   monitor_error_wai_sem_e,R1
*** SH SERIES ASSEMBLER Ver. 2.0 ***      01/28/98 12:59:01                                                              PAGE    22
PROGRAM NAME =

 1198 000000B2 412B               288             JMP             @R1
 1199 000000B4 0009               289             NOP
 1200                             290     
 1201 000000B6                    291     wai_sem00_e:
 1202 000000B6 6343               292             MOV             R4,R3
 1203 000000B8 4300               293             SHLL    R3
 1204                             294     
 1205                             295     ;       MOV.L   scb_wai_sem_e,R5
 1206                             296     ;FOR POINTER ACCESS
 1207 000000BA D544               297             MOV.L   scbp_waisem_e,R5
 1208 000000BC 6552               298             MOV.L   @R5,R5
 1209                             299     
 1210 000000BE 335C               300             ADD             R5,R3
 1211 000000C0 8430               301             MOV.B   @(SCB_STAT,R3),R0       ; R0 = scb[sem_no].stat
 1212 000000C2 88FF               302             CMP/EQ  #H'FF,R0
 1213 000000C4 89F4               303             BT              err_wai_sem_e                   ; scb[sem_no].stat == 0xFF（セマフ
 1214 000000C6 8431               304             MOV.B   @(SCB_TID,R3),R0        ; R0 = scb[sem_no].tid
 1215 000000C8 88FF               305             CMP/EQ  #H'FF,R0
 1216 000000CA 8B27               306             BF              sem_val0_e                      ; scb[sem_no].tid != 0xFF（セマフ
 1217                             307     
 1218 000000CC                    308     get_sem_e:
 1219                             309     ; セマフォ獲得
 1220                             310     ;入力 R1:real_run_tid
 1221                             311     ;     R3:scb[sem_no]のアドレス
 1222 000000CC E07F               312             MOV             #SCB_INIT,R0
 1223 000000CE 8030               313             MOV.B   R0,@(SCB_STAT,R3)       ; scb[sem_no].stat = SCB_INIT(0x7F)
 1224 000000D0 6013               314             MOV             R1,R0
 1225 000000D2 8031               315             MOV.B   R0,@(SCB_TID,R3)        ; scb[sem_no].tid = real_run_tid
 1226                             316     
 1227                             317     ;割込み禁止期間測定用
 1228                             318     ;ポートをＯＦＦする
 1229 000000D4 D00E               319             MOV.L   PORT_ADR_DATA,R0
 1230 000000D6 9120               320             MOV.W   PORT_ADR_DATA+H'A,R1
 1231 000000D8 6201               321             MOV.W   @R0,R2
 1232 000000DA 2219               322             AND             R1,R2
 1233 000000DC 2021               323             MOV.W   R2,@R0          ; SYS_COM_Port_Status &= ~0x0020
 1234 000000DE D10D               324             MOV.L   PORT_ADR_DATA+4,R1
 1235 000000E0 2121               325             MOV.W   R2,@R1          ; outpw(COM_PORT,SYS_COM_PortStatus)
 1236                             326     ;ここまで
 1237                             327     
 1238                             328     ;--------------------------------------------------------------
 1239                             329             RSTR_REG                                        ;ﾏｸﾛ ﾚｼﾞｽﾀﾎﾟｯﾌﾟ
 1240                                 M   
 1241 000000E2 4F26                   M           LDS.L   @R15+,PR                        ;POP.L  PR
 1242 000000E4 4F16                   M           LDS.L   @R15+,MACL                      ;POP.L  MACL
 1243 000000E6 4F06                   M           LDS.L   @R15+,MACH                      ;POP.L  MACH
 1244 000000E8 4F27                   M           LDC.L   @R15+,VBR                       ;POP.L  VBR
 1245 000000EA 4F17                   M           LDC.L   @R15+,GBR                       ;POP.L  GBR
 1246 000000EC 6EF6                   M           MOV.L   @R15+,R14                       ;POP.L  R14
 1247 000000EE 6DF6                   M           MOV.L   @R15+,R13                       ;POP.L  R13
 1248 000000F0 6CF6                   M           MOV.L   @R15+,R12                       ;POP.L  R12
 1249 000000F2 6BF6                   M           MOV.L   @R15+,R11                       ;POP.L  R11
 1250 000000F4 6AF6                   M           MOV.L   @R15+,R10                       ;POP.L  R10
 1251 000000F6 69F6                   M           MOV.L   @R15+,R9                        ;POP.L  R9
 1252 000000F8 68F6                   M           MOV.L   @R15+,R8                        ;POP.L  R8
 1253 000000FA 67F6                   M           MOV.L   @R15+,R7                        ;POP.L  R7
 1254 000000FC 66F6                   M           MOV.L   @R15+,R6                        ;POP.L  R6
*** SH SERIES ASSEMBLER Ver. 2.0 ***      01/28/98 12:59:01                                                              PAGE    23
PROGRAM NAME =

 1255 000000FE 65F6                   M           MOV.L   @R15+,R5                        ;POP.L  R5
 1256 00000100 64F6                   M           MOV.L   @R15+,R4                        ;POP.L  R4
 1257 00000102 63F6                   M           MOV.L   @R15+,R3                        ;POP.L  R3
 1258 00000104 62F6                   M           MOV.L   @R15+,R2                        ;POP.L  R2
 1259 00000106 61F6                   M           MOV.L   @R15+,R1                        ;POP.L  R1
 1260 00000108 60F6                   M           MOV.L   @R15+,R0                        ;POP.L  R0
 1261                                 M   
 1262                             330     ;--------------------------------------------------------------
 1263 0000010A 002B               331             RTE
 1264 0000010C 0009               332             NOP
 1265                             333     
 1266                             334     ;割込み禁止期間測定用
 1267 00000110                    335             .ALIGN 4
 1268 00000110                    336     PORT_ADR_DATA:
 1269 00000110 00000000           337             .DATA.L         _SYS_COM_PortStatus
 1270 00000114 00C203D0           338             .DATA.L         H'00C203D0
 1271 00000118 0020               339             .DATA.W         H'0020
 1272 0000011A FFDF               340             .DATA.W         H'FFDF
 1273                             341     ;ここまで
 1274                             342     
 1275 0000011C                    343     sem_val0_e:                                             ; セマフォ解放待ち (00:セマフォ使
 1276                             344     ;入力 R2:real_run_tidのオフセットアドレス
 1277                             345     ;     R4:sem_no
 1278 0000011C E303               346             MOV             #WAIT_SEM,R3
 1279                             347     
 1280                             348     ;       MOV.L   tcb_wai_sem_e,R0
 1281                             349     ;FOR POINTER ACCESS
 1282 0000011E D02C               350             MOV.L   tcbp_waisem_e,R0
 1283 00000120 6002               351             MOV.L   @R0,R0
 1284                             352     
 1285 00000122 0234               353             MOV.B   R3,@(R0,R2)                     ; tcb[real_run_tid].tsk_stat = WAIT_SEM
 1286 00000124 7008               354             ADD             #TCB_WAIT_PARA1,R0
 1287 00000126 0245               355             MOV.W   R4,@(R0,R2)                     ; tcb[real_run_tid].wait_param.semno = sem
 1288 00000128 D326               356             MOV.L   del_ready_link_wai_sem_e,R3
 1289 0000012A 6332               357             MOV.L   @R3,R3
 1290 0000012C 430B               358             JSR             @R3
 1291 0000012E 0009               359             NOP
 1292 00000130 6543               360             MOV             R4,R5
 1293 00000132 4500               361             SHLL    R5
 1294                             362     
 1295                             363     ;       MOV.L   scb_wai_sem_e,R0
 1296                             364     ;FOR POINTER ACCESS
 1297 00000134 D025               365             MOV.L   scbp_waisem_e,R0
 1298 00000136 6002               366             MOV.L   @R0,R0
 1299                             367     
 1300 00000138 350C               368             ADD             R0,R5
 1301 0000013A 8450               369             MOV.B   @(SCB_STAT,R5),R0       ; R0 = scb[sem_no].stat
 1302 0000013C 887F               370             CMP/EQ  #SCB_INIT,R0
 1303 0000013E 8932               371             BT              wai_sem01_e                     ; scb[sem_no].stat == SCB_INIT(0x7
 1304                             372     
 1305 00000140 E810               373             MOV             #TCB_TBL_SIZE,R8
 1306 00000142 280E               374             MULU    R0,R8
 1307 00000144 6603               375             MOV             R0,R6           ; scb[sem_no].statをR6にセーブ
 1308 00000146 071A               376             STS             MACL,R7
 1309                             377     
 1310                             378     ;       MOV.L   tcb_priority_wai_sem_e,R0
 1311                             379     ;FOR POINTER ACCESS
*** SH SERIES ASSEMBLER Ver. 2.0 ***      01/28/98 12:59:01                                                              PAGE    24
PROGRAM NAME =

 1312 00000148 D021               380             MOV.L   tcbp_waisem_e,R0
 1313 0000014A 6002               381             MOV.L   @R0,R0
 1314 0000014C 7002               382             ADD             #TCB_PRIORITY,R0
 1315                             383     
 1316 0000014E 097C               384             MOV.B   @(R0,R7),R9                     ; R9 = tcb[scb[sem_no].stat].priority
 1317 00000150 0A2C               385             MOV.B   @(R0,R2),R10            ; R10 = tcb[real_run_tid].priority
 1318 00000152 39A6               386             CMP/HI  R10,R9
 1319 00000154 8920               387             BT              wai_sem02_e                     ; scb wait priority > run priority
 1320                             388     
 1321 00000156 6573               389             MOV             R7,R5
 1322 00000158                    390     wai_sem05_e:
 1323                             391     ;       MOV.L   tcb_link_wai_sem_e,R0
 1324                             392     ;FOR POINTER ACCESS
 1325 00000158 D01D               393             MOV.L   tcbp_waisem_e,R0
 1326 0000015A 6002               394             MOV.L   @R0,R0
 1327 0000015C 7003               395             ADD             #TCB_LINK,R0
 1328                             396     
 1329 0000015E 065C               397             MOV.B   @(R0,R5),R6
 1330 00000160 E8FF               398             MOV             #NIL,R8
 1331 00000162 3680               399             CMP/EQ  R8,R6
 1332 00000164 8912               400             BT              wai_sem03_e
 1333                             401     
 1334 00000166 E810               402             MOV             #TCB_TBL_SIZE,R8
 1335 00000168 286E               403             MULU    R6,R8
 1336 0000016A 071A               404             STS             MACL,R7
 1337                             405     
 1338                             406     ;       MOV.L   tcb_priority_wai_sem_e,R0
 1339                             407     ;FOR POINTER ACCESS
 1340 0000016C D018               408             MOV.L   tcbp_waisem_e,R0
 1341 0000016E 6002               409             MOV.L   @R0,R0
 1342 00000170 7002               410             ADD             #TCB_PRIORITY,R0
 1343                             411     
 1344 00000172 097C               412             MOV.B   @(R0,R7),R9
 1345 00000174 0A2C               413             MOV.B   @(R0,R2),R10
 1346 00000176 39A6               414             CMP/HI  R10,R9                          ; scb wait priority > run priority
 1347 00000178 8901               415             BT              wai_sem04_e
 1348 0000017A AFED               416             BRA             wai_sem05_e
 1349 0000017C 6573               417             MOV             R7,R5
 1350                             418     
 1351 0000017E                    419     wai_sem04_e:                                    ; scbの中間に接続
 1352                             420     ;       MOV.L   tcb_link_wai_sem_e,R0
 1353                             421     ;FOR POINTER ACCESS
 1354 0000017E D014               422             MOV.L   tcbp_waisem_e,R0
 1355 00000180 6002               423             MOV.L   @R0,R0
 1356 00000182 7003               424             ADD             #TCB_LINK,R0
 1357                             425     
 1358 00000184 065C               426             MOV.B   @(R0,R5),R6
 1359 00000186 0514               427             MOV.B   R1,@(R0,R5)
 1360 00000188 A014               428             BRA             wai_sem_ok_e
 1361 0000018A 0264               429             MOV.B   R6,@(R0,R2)
 1362                             430     
 1363 0000018C                    431     wai_sem03_e:                                    ; scbの最後に接続
 1364                             432     ;       MOV.L   tcb_link_wai_sem_e,R0
 1365                             433     ;FOR POINTER ACCESS
 1366 0000018C D010               434             MOV.L   tcbp_waisem_e,R0
 1367 0000018E 6002               435             MOV.L   @R0,R0
 1368 00000190 7003               436             ADD             #TCB_LINK,R0
*** SH SERIES ASSEMBLER Ver. 2.0 ***      01/28/98 12:59:01                                                              PAGE    25
PROGRAM NAME =

 1369                             437     
 1370 00000192 0514               438             MOV.B   R1,@(R0,R5)
 1371 00000194 A00E               439             BRA             wai_sem_ok_e
 1372 00000196 0264               440             MOV.B   R6,@(R0,R2)
 1373                             441     
 1374 00000198                    442     wai_sem02_e:
 1375                             443     ; scbの先頭に接続
 1376                             444     ;入力 R1:real_run_tid
 1377                             445     ;     R5:scb[sem_no]のアドレス
 1378                             446     ;     R6:scb[sem_no].stat セマフォ待ちタスクのＩＤ
 1379 00000198 6013               447             MOV             R1,R0
 1380 0000019A 8050               448             MOV.B   R0,@(SCB_STAT,R5)       ; scb[sem_no].stat = real_run_tid
 1381                             449     
 1382                             450     ;       MOV.L   tcb_link_wai_sem_e,R0
 1383                             451     ;FOR POINTER ACCESS
 1384 0000019C D00C               452             MOV.L   tcbp_waisem_e,R0
 1385 0000019E 6002               453             MOV.L   @R0,R0
 1386 000001A0 7003               454             ADD             #TCB_LINK,R0
 1387                             455     
 1388 000001A2 A007               456             BRA             wai_sem_ok_e
 1389 000001A4 0264               457             MOV.B   R6,@(R0,R2)                     ; tcb[real_run_tid].tsk_link = R6
 1390                             458     
 1391 000001A6                    459     wai_sem01_e                                             ; 待ちタスク無し
 1392                             460     ;入力 R1:real_run_tid
 1393                             461     ;     R5:scb[sem_no]のアドレス
 1394 000001A6 6013               462             MOV             R1,R0
 1395 000001A8 8050               463             MOV.B   R0,@(SCB_STAT,R5)       ; scb[sem_no].stat = real_run_tid
 1396 000001AA E6FF               464             MOV             #NIL,R6
 1397                             465     
 1398                             466     ;       MOV.L   tcb_link_wai_sem_e,R0
 1399                             467     ;FOR POINTER ACCESS
 1400 000001AC D008               468             MOV.L   tcbp_waisem_e,R0
 1401 000001AE 6002               469             MOV.L   @R0,R0
 1402 000001B0 7003               470             ADD             #TCB_LINK,R0
 1403                             471     
 1404 000001B2 0264               472             MOV.B   R6,@(R0,R2)                     ; tcb[real_run_tid].tsk_link = 0xFF
 1405                             473     
 1406 000001B4                    474     wai_sem_ok_e:
 1407 000001B4 D004               475             MOV.L   rescheduler_wai_sem_e,R0
 1408 000001B6 6002               476             MOV.L   @R0,R0
 1409 000001B8 402B               477             JMP             @R0
 1410 000001BA 0009               478             NOP
 1411                             479     
 1412 000001BC                    480             .ALIGN 4
 1413 000001BC                    481     I_BIT_OFF_wai_sem_e:
 1414 000001BC 0000030F           482             .DATA.L I_BIT_OFF
 1415 000001C0                    483     monitor_error_wai_sem_e:
 1416 000001C0 00000000           484             .DATA.L monitor_error
 1417                             485     ;scb_wai_sem_e:
 1418                             486     ;       .DATA.L _scb
 1419                             487     ;tcb_wai_sem_e:
 1420                             488     ;       .DATA.L _tcb
 1421 000001C4                    489     del_ready_link_wai_sem_e:
 1422 000001C4 00000000           490             .DATA.L _del_ready_link_vec
 1423                             491     ;tcb_priority_wai_sem_e:
 1424                             492     ;       .DATA.L _tcb+TCB_PRIORITY
 1425                             493     ;tcb_link_wai_sem_e:
*** SH SERIES ASSEMBLER Ver. 2.0 ***      01/28/98 12:59:01                                                              PAGE    26
PROGRAM NAME =

 1426                             494     ;       .DATA.L _tcb+TCB_LINK
 1427 000001C8                    495     rescheduler_wai_sem_e:
 1428 000001C8 00000000           496             .DATA.L _rescheduler_vec
 1429 000001CC                    497     scbp_waisem_e:
 1430 000001CC 00000000           498             .DATA.L _scb_p
 1431 000001D0                    499     tcbp_waisem_e:
 1432 000001D0 00000000           500             .DATA.L _tcb_p
 1433 000001D4                    501     MON_MAX_SCB_waisem_e:
 1434 000001D4 00000000           502             .DATA.L _MON_MAX_SCB
 1435                             503     
 1436                             504             .END
  *****TOTAL ERRORS       0
  *****TOTAL WARNINGS     0
*** SH SERIES ASSEMBLER Ver. 2.0 ***      01/28/98 12:59:01                                                              PAGE    27

*** CROSS REFERENCE LIST

NAME                             SECTION  ATTR VALUE             SEQUENCE

ERROR                                     EQU  000000FF    193*
FLAG_INIT_DATA                            EQU  00000000     42*
INIT_TID                                  EQU  00000000     33*
I_BIT_OFF                                 EQU  0000030F     23* 1041  1414 
I_BIT_OFF_wai_sem_e              P             000001BC   1118  1413*
I_BIT_OFF_wai_sem_i              MON           00000190    805  1040*
I_BIT_ON                                  EQU  000000F0     22*  793  1094 
LONGNIL                                   EQU  FFFFFFFF    180*
MON                              MON      SCT  00000000    757*
MON_FAILURE                               EQU  00000000    276*
MON_MAX_SCB_waisem_e             P             000001D4   1191  1433*
MON_MAX_SCB_waisem_i             MON           000001A8    876  1052*
MON_SUCCESS                               EQU  00000001    275*
MON_StackCheckTable_p_STKCHK_P00*MON           00000094    843   866*
MON_StackCheckTable_p_STKCHK_P00*P             000000A4   1156  1179*
NIL                                       EQU  000000FF    178*  975  1027  1330  1396 
NOT_USED                                  EQU  000000C0    184*
NO_WAIMBX                                 EQU  0000007F    249*
ONESHOT_VALUE_MAX                         EQU  0000001A     28*
P                                P        SCT  00000000   1058*
PORT_ADR_DATA                    P             00000110   1102  1103  1107  1229  1230  1234  1268*
RCV_WAIT                                  EQU  00000002    187*
READY                                     EQU  00000040    183*
SCB_INIT                                  EQU  0000007F    221*  902   954  1222  1302 
SCB_STAT                                  EQU  00000000    228*  891   903   953  1015  1026  1211  1223  1301  1380  1395 
SCB_TBL_SIZE                              EQU  00000002    220*
SCB_TID                                   EQU  00000001    229*  894   905  1214  1225 
SND_WAIT                                  EQU  00000001    186*
STACK_PC_POSITION                         EQU  00000050     54*  799  1112 
STCTX_REG_TBL00000               MON           00000038    766   792*
STCTX_REG_TBL00003               P             00000038   1067  1093*
TCB_LINK                                  EQU  00000003    167*  973   995  1004  1018  1030  1327  1356  1368  1386  1402 
TCB_PRIORITY                              EQU  00000002    166*  963   984  1314  1342 
TCB_PROGNO                                EQU  00000001    165*
TCB_RESERVE                               EQU  00000006    170*
TCB_RUN_LINK                              EQU  00000004    168*
TCB_STACK_ADR                             EQU  0000000C    173*  820  1133 
TCB_STAT                                  EQU  00000000    164*
TCB_TBL_SIZE                              EQU  00000010    176*  814   957   979  1127  1305  1334 
TCB_WAIT_PARA1                            EQU  00000008    171*  942  1286 
TCB_WAIT_PARA2                            EQU  0000000A    172*
TCB_WAIT_PARAM                            EQU  00000005    169*
TIB_END_ADR                               EQU  00000004    102*
TIB_PRIORITY                              EQU  00000009    104*
TIB_STACK_SIZE                            EQU  00000008    103*
TIB_START_ADR                             EQU  00000000    101*
TIB_TBL_SIZE                              EQU  0000000C     98*
TSK_INITIAL                               EQU  00000000     34*
TSK_INI_ADDR                              EQU  FFFFFC00     35*
WAIT                                      EQU  00000000    182*
WAIT_EVENT                                EQU  00000005    190*
WAIT_ONESHOT                              EQU  00000006    191*
WAIT_SEM                                  EQU  00000003    188*  938  1278 
WAIT_TIMER                                EQU  00000004    189*
*** SH SERIES ASSEMBLER Ver. 2.0 ***      01/28/98 12:59:01                                                              PAGE    28

*** CROSS REFERENCE LIST

NAME                             SECTION  ATTR VALUE             SEQUENCE

WORDNIL                                   EQU  0000FFFF    179*
_MON_MAX_ECB                              IMPT 00000000    709 
_MON_MAX_LARGE_TCB                        IMPT 00000000    697 
_MON_MAX_MBXNO                            IMPT 00000000    708 
_MON_MAX_MCB                              IMPT 00000000    707 
_MON_MAX_SCB                              IMPT 00000000    705  1053  1434 
_MON_MAX_SEMNO                            IMPT 00000000    706 
_MON_MAX_SMALL_TCB                        IMPT 00000000    698 
_MON_MAX_TCB                              IMPT 00000000    699 
_MON_SIZE_LARGE_STACK                     IMPT 00000000    700 
_MON_SIZE_SMALL_STACK                     IMPT 00000000    701 
_MON_STACK_START_ADDR                     IMPT 00000000    702 
_MON_StackCheckTable                      IMPT 00000000    288 
_MON_StackCheckTable_p                    IMPT 00000000    696   867  1180 
_MON_TOP_LARGE_ADDR                       IMPT 00000000    703 
_MON_TOP_SMALL_ADDR                       IMPT 00000000    704 
_SYS_COM_PortStatus                       IMPT 00000000    722  1269 
_del_ready_link_vec                       IMPT 00000000    718  1045  1422 
_ecb_p                                    IMPT 00000000    694 
_mcb_p                                    IMPT 00000000    695 
_real_run_tid                             IMPT 00000000    687   826   861  1139  1174 
_rescheduler_vec                          IMPT 00000000    719  1047  1428 
_scb_p                                    IMPT 00000000    693  1049  1430 
_tcb_p                                    IMPT 00000000    692   828  1051  1141  1432 
_tib                                      IMPT 00000000    691 
_top_ready_tid                            IMPT 00000000    688 
_wai_1shot_tid                            IMPT 00000000    690 
_wai_sem_erom                    P        EXPT 00000000    725  1059*
_wai_sem_irom                    MON      EXPT 00000000    724   758*
_wai_tsk_tid                              IMPT 00000000    689 
del_ready_link_wai_sem_e         P             000001C4   1288  1421*
del_ready_link_wai_sem_i         MON           00000198    944  1044*
end_STSP_P00001                  MON           0000006C    821   830*
end_STSP_P00004                  P             0000007C   1134  1143*
err_wai_sem_e                    P             000000B0   1178  1196* 1213 
err_wai_sem_i                    MON           000000A0    865   880*  893 
get_sem_e                        P             000000CC   1218*
get_sem_i                        MON           000000BC    898*
monitor_error                             IMPT 00000000    720  1043  1416 
monitor_error_wai_sem_e          P             000001C0   1197  1415*
monitor_error_wai_sem_i          MON           00000194    881  1042*
real_run_tid_STKCHK_P00002       MON           0000008C    836   860*
real_run_tid_STKCHK_P00005       P             0000009C   1149  1173*
real_run_tid_STSP_P00001         MON           00000064    812   825*
real_run_tid_STSP_P00004         P             00000074   1125  1138*
rescheduler_wai_sem_e            P             000001C8   1407  1427*
rescheduler_wai_sem_i            MON           0000019C   1034  1046*
scbp_waisem_e                    P             000001CC   1207  1297  1429*
scbp_waisem_i                    MON           000001A0    888   950  1048*
sem_val0_e                       P             0000011C   1216  1275*
sem_val0_i                       MON           000000F0    896   935*
stack_chk_end_p00002             MON           00000098    852   869*
stack_chk_end_p00005             P             000000A8   1165  1182*
stack_chk_error_p00002           MON           00000086    848   854*
*** SH SERIES ASSEMBLER Ver. 2.0 ***      01/28/98 12:59:01                                                              PAGE    29

*** CROSS REFERENCE LIST

NAME                             SECTION  ATTR VALUE             SEQUENCE

stack_chk_error_p00005           P             00000096   1161  1167*
stctx_reg_end00000               MON           0000003C    788   795*
stctx_reg_end00003               P             0000003C   1089  1096*
stk_chk_err_STKCHK_P00002        MON           00000090    855   864*
stk_chk_err_STKCHK_P00005        P             000000A0   1168  1177*
tcbp_STSP_P00001                 MON           00000068    816   827*
tcbp_STSP_P00004                 P             00000078   1129  1140*
tcbp_waisem_e                    P             000001D0   1282  1312  1325  1340  1354  1366  1384  1400  1431*
tcbp_waisem_i                    MON           000001A4    939   961   971   982   993  1002  1016  1028  1050*
wai_sem00_e                      P             000000B6   1195  1201*
wai_sem00_i                      MON           000000A6    879   885*
wai_sem01_e                      P             000001A6   1303  1391*
wai_sem01_i                      MON           0000017A    955  1022*
wai_sem02_e                      P             00000198   1319  1374*
wai_sem02_i                      MON           0000016C    967  1009*
wai_sem03_e                      P             0000018C   1332  1363*
wai_sem03_i                      MON           00000160    977  1001*
wai_sem04_e                      P             0000017E   1347  1351*
wai_sem04_i                      MON           00000152    988   992*
wai_sem05_e                      P             00000158   1322* 1348 
wai_sem05_i                      MON           0000012C    970*  989 
wai_sem_ok_e                     P             000001B4   1360  1371  1388  1406*
wai_sem_ok_i                     MON           00000188    998  1006  1019  1033*
*** SH SERIES ASSEMBLER Ver. 2.0 ***      01/28/98 12:59:01                                                              PAGE    30

*** SECTION DATA LIST

SECTION                          ATTRIBUTE    SIZE             START

MON                              REL-CODE    0000001AC        
P                                REL-CODE    0000001D8        
