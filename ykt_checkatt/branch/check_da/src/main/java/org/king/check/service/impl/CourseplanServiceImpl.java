package org.king.check.service.impl;

import org.apache.commons.beanutils.BeanUtils;
import org.apache.commons.lang.StringUtils;
import org.apache.poi.hssf.usermodel.HSSFRow;
import org.apache.poi.hssf.usermodel.HSSFSheet;
import org.apache.struts.action.ActionForm;
import org.apache.struts.action.DynaActionForm;
import org.king.check.Constants;
import org.king.check.common.ec.DBPageLimit;
import org.king.check.common.query.QueryTranslate;
import org.king.check.dao.CourseplanDAO;
import org.king.check.domain.*;
import org.king.check.door.PersonsTaskBiz;
import org.king.check.service.*;
import org.king.check.util.DateUtilExtend;
import org.king.utils.DateUtil;
import org.king.utils.StringUtil;

import java.util.*;

public class CourseplanServiceImpl implements CourseplanService {

    private CourseplanDAO courseplanDAO;

    private RoomService roomService;

    private CustomerService customerService;

    private TermService termService;

    private CourseService courseService;

    private TimeService timeService;

    private AreaService areaService;

    private DepartmentService departmentService;

    public void setDepartmentService(DepartmentService departmentService) {
        this.departmentService = departmentService;
    }

    public List findCourseplanclass(String planId) {
        StringBuffer query = new StringBuffer(" ");
        query.append("  from TCourseplanclass c where c.id.planid='").append(planId).append("'");
        return courseplanDAO.findplanclass(query.toString());
    }


    public void setAreaService(AreaService areaService) {
        this.areaService = areaService;
    }

    public void deleteCourseplanClass(TCourseplanclass planclass) {
        courseplanDAO.delete(planclass);
    }


    public void findCourseplan(DynaActionForm dform, DBPageLimit page) throws Exception {
        QueryTranslate queryTranslate = new QueryTranslate();
        queryTranslate.setQueryString("select distinct t.id as Id, t.room.schoolArea.areaName as areaName,t.room.build as build,t.room.roomName as roomName,t.customer.stuempno as stuempNo, t.customer.custname as custName, t.course.coursename as courseName,'' as className,t.week as week,t.useWeek as useWeek,t.useDate as useDate,t.beginClassNum as beginClassNum,t.endClassNum as endClassNum from TCourseplan t");
        String classno = dform.get("classno").toString();
        String departmentName = dform.get("departmentName").toString();
        String pid = dform.get("pid").toString();
        //change hql
        if(StringUtils.isNotBlank(classno) || StringUtils.isNotBlank(departmentName) || StringUtils.isNotBlank(pid)){
            queryTranslate.setQueryString("select distinct t.id as Id, t.room.schoolArea.areaName as areaName,t.room.build as build,t.room.roomName as roomName,t.customer.stuempno as stuempNo, t.customer.custname as custName, t.course.coursename as courseName,'' as className,t.week as week,t.useWeek as useWeek,t.useDate as useDate,t.beginClassNum as beginClassNum,t.endClassNum as endClassNum from TCourseplan t,TCourseplanclass cpc,Department d,TFaculty f where cpc.id.classno=d.id and t.id=cpc.id.planid and f.value=d.faculty");
        }

        queryTranslate.setOffset(true);
        queryTranslate.setPageStartNo((page.getPageNo() - 1) * page.getPageSize());
        queryTranslate.setPageSize(page.getPageSize());
        queryTranslate.setOrderby(" order by t.useDate desc,t.id");

        if (StringUtils.isNotBlank(classno)) {
            queryTranslate.addEqualCondition("cpc.id.classno", classno);
        }
        if (StringUtils.isNotBlank(departmentName)) {
            queryTranslate.addLikeCondition("d.name", departmentName);
        }
        if (StringUtils.isNotBlank(pid)) {
            queryTranslate.addLikeCondition("f.pid", pid);
        }

        String stuempNo = dform.get("stuempNo").toString();
        if (StringUtils.isNotBlank(stuempNo)) {
            queryTranslate.addLikeCondition("t.customer.stuempno", stuempNo);
        }
        String custName = dform.get("custName").toString();
        if (StringUtils.isNotBlank(custName)) {
            queryTranslate.addLikeCondition("t.customer.custname", custName);
        }
        String beginDate = dform.get("beginDate").toString();
        if (StringUtils.isBlank(beginDate)) {
            beginDate = DateUtil.getFirstDayOfWeek("yyyyMMdd");
            dform.set("beginDate", beginDate);
        }
        queryTranslate.addCondition("t.useDate", Constants.OPRATER_GREATER_AND_EQUAL, beginDate);

        String endDate = dform.get("endDate").toString();
        if (StringUtils.isBlank(endDate)) {
            endDate = DateUtil.getNow("yyyyMMdd");
            dform.set("endDate", endDate);
        }
        queryTranslate.addCondition("t.useDate", Constants.OPRATER_LESS_AND_EQUAL, endDate);

        String useWeek = dform.get("useWeek").toString();
        if (StringUtils.isNotBlank(useWeek)) {
            queryTranslate.addEqualCondition("t.useWeek", useWeek);
        }
        String beginWeek = dform.get("beginWeek").toString();
        if (StringUtils.isNotBlank(beginWeek)) {
            queryTranslate.addEqualCondition("t.beginWeek", Integer.valueOf(beginWeek));
        }
        String endWeek = dform.get("endWeek").toString();
        if (StringUtils.isNotBlank(endWeek)) {
            queryTranslate.addEqualCondition("t.endWeek", Integer.valueOf(endWeek));
        }
        String courseId = dform.get("courseId").toString();
        if (StringUtils.isNotBlank(courseId)) {
            queryTranslate.addEqualCondition("t.course.courseid", courseId);
        }

        String week = dform.get("week").toString();
        if (StringUtils.isNotBlank(week)) {
            queryTranslate.addEqualCondition("t.week", week);
        }
        String beginClassNum = dform.get("beginClassNum").toString();
        if (StringUtils.isNotBlank(beginClassNum)) {
            queryTranslate.addEqualCondition("t.beginClassNum", Integer.valueOf(beginClassNum));
        }
        String endClassNum = dform.get("endClassNum").toString();
        if (StringUtils.isNotBlank(endClassNum)) {
            queryTranslate.addEqualCondition("t.endClassNum", Integer.valueOf(endClassNum));
        }
        String schoolArea = dform.get("schoolArea").toString();
        if (StringUtils.isNotBlank(schoolArea)) {
            queryTranslate.addEqualCondition("t.room.schoolArea.areaCode", schoolArea);
        }
        String build = dform.get("build").toString();
        if (StringUtils.isNotBlank(build)) {
            queryTranslate.addEqualCondition("t.room.build", build);
        }
        String roomname = dform.get("roomname").toString();
        if (StringUtils.isNotBlank(roomname)) {
            queryTranslate.addEqualCondition("t.room.roomName", roomname);
        }
        String classname = dform.get("classname").toString();
        if (StringUtils.isNotBlank(classname)) {
            queryTranslate.addLikeCondition("d.name", classname);
        }

        page.setMap(true);
        courseplanDAO.findCourseplanByPage(page, queryTranslate);

        //find the class name according to plan id
        if (page.getResult() != null && page.getResult().size() > 0) {
            StringBuffer hql = new StringBuffer("select cpc.id.planid,replace(wmsys.wm_concat(d.name),',','£»<BR>') from TCourseplanclass cpc,Department d where cpc.id.classno=d.id and (");
            for (int i = 0; i < page.getResult().size(); i++) {
                Map row = (Map) page.getResult().get(i);
                hql.append("cpc.id.planid='").append(row.get("Id")).append("' or ");
            }
            hql = hql.delete(hql.length()-3,hql.length()-1);
            hql.append(") group by cpc.id.planid");
            Map deptMap = new HashMap();
            List list = courseplanDAO.find(hql.toString());
            if (list != null && list.size() > 0) {
                for (int i = 0; i < list.size(); i++) {
                    Object[] cpc = (Object[]) list.get(i);
                    deptMap.put(cpc[0], cpc[1]);
                }
                for (int i = 0; i < page.getResult().size(); i++) {
                    Map row = (Map) page.getResult().get(i);
                    row.put("className", deptMap.get(row.get("Id")));
                }
            }
        }
    }

    public void deleteCourseplan(TCourseplan courseplan) throws Exception {
        courseplanDAO.delete(courseplan);

    }


    public void updateCourseplan(TCourseplan courseplan) throws Exception {
        courseplanDAO.update(courseplan);
    }

    private void updateCourseplan(TCourseplan courseplan, String[] classes) {
        //delete the exist classes
        Set<TCourseplanclass> courseplanclasses = courseplan.getCourseplanClass();
        for (TCourseplanclass courseplanclass : courseplanclasses) {
            courseplanDAO.delete(courseplanclass);
        }
        courseplanclasses.clear();

        if (classes != null) {
            for (String departmentId : classes) {
                TCourseplanclass courseplanclass = new TCourseplanclass();
                TCourseplanclassId courseplanclassId = new TCourseplanclassId();
                courseplanclassId.setClassno(departmentId);
                courseplanclassId.setPlanid(courseplan.getId());
                courseplanclass.setId(courseplanclassId);

                courseplanclasses.add(courseplanclass);
                courseplanDAO.save(courseplanclass);

            }
        }
    }

    public String updateCourseplan(ActionForm form, String planId, String[] classes)
            throws Exception {
        String result = "";
        DynaActionForm dform = (DynaActionForm) form;

        TCourseplan courseplan = courseplanDAO.getTCourseplan(planId);//Ô­À´¿Î³Ì¼Æ»®
        Integer beginWeek = courseplan.getBeginWeek();
        Integer endWeek = courseplan.getEndWeek();

        TArea area = areaService.getArea(dform.get("areaCode").toString());
        TRoom room = roomService.findOneRoom(area.getAreaName(), dform.get("build").toString(), dform.get("roomname").toString());

//        Department dept = departmentService.getDepartment(dform.get("gardno").toString());


        if (room == null) {
            result = result + "Ð£Çø·¿¼ä¹ØÏµ´íÎó¡£";

        }
        TCustomer cust = customerService.findCustByStuemp(dform.get("stuempNo").toString());
        if (cust == null || !cust.getCustname().equals(dform.get("custName").toString())) {
            result = result + "¹¤ºÅºÍ½ÌÊ¦ÐÕÃû²»¶ÔÓ¦¡£";

        }
        //  List  planList = findCourseplan(dform);
        //  if(planList!=null&&planList.size()>0){//´ËÊ±¶ÎÓÐÆäËû¿Î³ÌÊ¹ÓÃ´Ë½ÌÊÒ
        //  	result=result+"´ËÊ±¶ÎÓÐÆäËû¿Î³ÌÊ¹ÓÃ´Ë½ÌÊÒ¡£";
        // return mapping.findForward("courseplanedit");
        //  }
        if (!"".equals(result)) {
            return result;
        }


        //PersonsTaskBiz.updateDoorList(courseplan.getCourse().getCourseid(), courseplan.getRoom().getRoomId());


        TTerm term = termService.getTerm(courseplan.getTerm().getTermId());
        String beginDate = term.getBeginDate();//Ñ§ÆÚ¿ªÊ¼Ê±¼ä
        String useDate = DateUtilExtend.getCourseDate(beginDate, Integer.parseInt(dform.getString("useWeek")), Integer.parseInt(dform.getString("week")), "yyyyMMdd");
        BeanUtils.copyProperties(courseplan, dform);
        courseplan.setUseDate(useDate);
        courseplan.setRoom(room);
//        courseplan.setDept(dept);
        String beginTime = "";
        String endTime = "";
        //¸ù¾Ý¿Î´Î»»Ëã¾ßÌåÊ±¼ä
        Map begMap = timeService.getTimeByClass(dform.getString("beginClassNum"));
        Map endMap = timeService.getTimeByClass(dform.getString("endClassNum"));
        if (begMap != null) {
            beginTime = begMap.get("beginTime").toString();
        }
        if (endMap != null) {
            endTime = endMap.get("endTime").toString();
        }
        courseplan.setBeginTime(beginTime);
        courseplan.setEndTime(endTime);
        courseplan.setBeginWeek(beginWeek);
        courseplan.setEndWeek(endWeek);
        courseplan.setCustomer(cust);
        courseplanDAO.update(courseplan);
        //update the relationship first
        updateCourseplan(courseplan, classes);

//        PersonsTaskBiz.insertDoorList();

        result = result + "ÐÞ¸Ä³É¹¦";
        return result;
    }

    public TCourseplan getTCourseplan(String id) throws Exception {
        return (TCourseplan) courseplanDAO.getTCourseplan(id);
    }

    public List getClassByPlanId(String id) throws Exception {
        StringBuffer query = new StringBuffer("");
        query.append(" select new Map(c.id.planid as planid ,c.id.classno as classno  )")
                .append(" from TCourseplanclass c  where c.id.planid ='").append(id).append("'");
        List list = courseplanDAO.find(query.toString());
        return list;
    }


    public Map getTCourseplanMap(String id) throws Exception {
        StringBuffer query = new StringBuffer(" ");
        query.append("select new Map ( t.dept.id as gardno ,t.id as Id ,t.room.schoolArea.areaCode as areaCode , ")
                .append(" t.room.schoolArea.areaName as areaName ,")
                .append(" t.room.build as build ,")
                .append(" t.room.roomName as roomname ,")
                .append(" t.customer.stuempno  as stuempNo ,")
                .append(" t.customer.custname as custName , ")
                .append(" t.week as week ,")
                .append(" t.useWeek as useWeek ,")
                .append(" t.useDate as useDate ,")
                .append(" t.beginClassNum as beginClassNum ,")
                .append(" t.endClassNum as endClassNum ,")
                .append(" t.beginWeek as beginWeek ,")
                .append(" t.endWeek as endWeek ,")
                .append(" t.ischeck as ischeck ,")
                .append(" t.isopen as isopen")
                .append(" ) from ")
                .append(" TCourseplan t where 1 = 1 ")
                .append(" and t.id ='").append(id).append("'");
        List list = courseplanDAO.find(query.toString());
        return (Map) list.get(0);
    }

    /**
     * ÅÐ¶Ï¶ÔÓ¦¿Î³Ì¼Æ»®ÊÇ·ñÒÑ¾­ÔÚÊý¾Ý¿âÖÐ
     *
     * @param tCourseplan  .
     * @return             .
     */
    public boolean isExistCourplan(TCourseplan tCourseplan){
        StringBuffer hql = new StringBuffer("from TCourseplan t where");
        hql.append(" t.term.termId='").append(tCourseplan.getTerm().getTermId()).append("'");
        hql.append(" and t.room.roomId='").append(tCourseplan.getRoom().getRoomId()).append("'");
        hql.append(" and t.week=").append(tCourseplan.getWeek());
        hql.append(" and t.beginClassNum=").append(tCourseplan.getBeginClassNum());
        hql.append(" and t.endClassNum=").append(tCourseplan.getEndClassNum());
        hql.append(" and t.useWeek=").append(tCourseplan.getUseWeek());
        List result = courseplanDAO.find(hql.toString());
        return result != null && result.size() > 0;
    }

    public String saveCourseplanImp(HSSFSheet sheet, String termId, String userId) {
        String result = "";

        try {
            TTerm term = termService.getTerm(termId);
            String beginDate = term.getBeginDate();//Ñ§ÆÚ¿ªÊ¼Ê±¼ä
            int rowCount = sheet.getPhysicalNumberOfRows();
            String nowTime = DateUtilExtend.getTimestamp();
            if (rowCount > 0) {
                int savenum = 0;
                //ÓÃÓÚ´æ´¢±¾´ÎÉÏ´«µÄ¿Î³Ì¼Æ»®
                Set courseplans = new HashSet();
                for (int i = 1; i < rowCount; i++) {
                    try {
                        HSSFRow row = sheet.getRow(i);
                        String termName = getTrimedStr(row.getCell((short) 0).getStringCellValue()).trim();//Ñ§ÆÚ
                        String deptName = getTrimedStr(row.getCell((short) 1).getStringCellValue()).trim();//ÔºÏµ
                        String schoolArea = getTrimedStr(row.getCell((short) 2).getStringCellValue()).trim();//Ð£Çø
                        String build = getTrimedStr(row.getCell((short) 3).getStringCellValue()).trim();//Â¥Óî
                        String roomName = getTrimedStr(row.getCell((short) 4).getStringCellValue()).trim();//½ÌÊÒ
                        String courseName = getTrimedStr(row.getCell((short) 5).getStringCellValue()).trim();//¿Î³Ì
                        String stuempNo = getTrimedStr(row.getCell((short) 6).getStringCellValue()).trim();//½ÌÊ¦Ñ§¹¤ºÅ
                        String custname = getTrimedStr(row.getCell((short) 7).getStringCellValue()).trim();//½ÌÊ¦Ãû
                        String classIds = getTrimedStr(row.getCell((short) 8).getStringCellValue()).trim();//°à¼¶±àÂë
                        String week = getTrimedStr(row.getCell((short) 9).getStringCellValue()).trim();//ÖÜ¼¸ÉÏ¿Î
                        String begWeekNum = getTrimedStr(row.getCell((short) 10).getStringCellValue()).trim();//¿ªÊ¼ÖÜ´Î
                        String endWeekNum = getTrimedStr(row.getCell((short) 11).getStringCellValue()).trim();//½áÊøÖÜ´Î
                        String beginClassNum = getTrimedStr(row.getCell((short) 12).getStringCellValue()).trim();//¿ªÊ¼¿Î´Î
                        String endClassNum = getTrimedStr(row.getCell((short) 13).getStringCellValue()).trim();//½áÊø¿Î´Î
                        String ischeck = getTrimedStr(row.getCell((short) 14).getStringCellValue()).trim();//ÊÇ·ñ¿¼ÇÚ
                        String isopen = getTrimedStr(row.getCell((short) 15).getStringCellValue()).trim();//ÊÇ·ñ¿ªÃÅ

                        //ÅÐ¶Ïµ±Ç°¿Î³Ì¼Æ»®ÊÇ·ñÒÑ¾­µ¼Èë
                        StringBuffer key = new StringBuffer();
                        key.append(termName).append(",").append(deptName).append(",").append(schoolArea).append(",").append(build).append(",")
                                .append(roomName).append(",").append(courseName).append(",").append(stuempNo).append(",")
                                .append(week).append(",").append(begWeekNum).append(",").append(endWeekNum).append(",")
                                .append(beginClassNum).append(",").append(endClassNum);
                        if(courseplans.contains(key.toString())){
                            continue;
                        } else{
                            courseplans.add(key.toString());
                        }


                        if (isopen.equals("ÊÇ")) {
                            isopen = "1";
                        } else if (isopen.equals("·ñ")) {
                            isopen = "0";
                        }

                        if (ischeck.equals("ÊÇ")) {
                            ischeck = "1";
                        } else if (ischeck.equals("·ñ")) {
                            ischeck = "0";
                        }
                        String beginTime = "";
                        String endTime = "";
                        for (int j = Integer.parseInt(begWeekNum); j <= Integer.parseInt(endWeekNum); j++) {

                            TCourseplan courseplan = new TCourseplan();
                            TRoom room = roomService.findOneRoom(schoolArea, build, roomName);
                            courseplan.setTerm(new TTerm(termId));
                            courseplan.setRoom(room);
                            courseplan.setBeginWeek(Integer.valueOf(begWeekNum));
                            courseplan.setEndWeek(Integer.valueOf(endWeekNum));
                            courseplan.setWeek(Integer.valueOf(week));
                            courseplan.setBeginClassNum(Integer.valueOf(beginClassNum));
                            courseplan.setEndClassNum(Integer.valueOf(endClassNum));
                            courseplan.setCreator(userId);
                            courseplan.setIscheck(Integer.parseInt(ischeck));
                            courseplan.setIsopen(Integer.parseInt(isopen));

                            //Ê¹ÓÃµÄµ±Ç°ÖÜ
                            courseplan.setUseWeek(new Integer(j));

                            //¸ù¾ÝµÚ¼¸ÖÜÖÜ¼¸²é¾ßÌåÊ±¼ä
                            String useDate = DateUtilExtend.getCourseDate(beginDate, j, Integer.parseInt(week), "yyyyMMdd");
                            courseplan.setUseDate(useDate);

                            //¸ù¾Ý¿Î´Î»»Ëã¾ßÌåÊ±¼ä
                            Map begMap = timeService.getTimeByClass(beginClassNum);
                            Map endMap = timeService.getTimeByClass(endClassNum);
                            if (begMap != null) {
                                beginTime = begMap.get("beginTime").toString();
                            } else {
                                result = result + "µÚ" + rowCount + "¿ªÊ¼¿Î´Î´íÎó¡£<br>";
                                return result;
                            }
                            if (endMap != null) {
                                endTime = endMap.get("endTime").toString();
                            } else {
                                result = result + "µÚ" + rowCount + "½áÊø¿Î´Î´íÎó¡£<br>";
                                return result;
                            }
                            courseplan.setBeginTime(beginTime);
                            courseplan.setEndTime(endTime);


                            courseplan.setStatus(1);
                            TCustomer cust = customerService.findCustByStuemp(stuempNo);
                            courseplan.setCustomer(cust);

                            courseplan.setCreateTime(nowTime);

                            //²éÕÒ¿Î³ÌÐÅÏ¢£¬Èç¹ûÃ»ÓÐÐÂÔö¿Î³Ì¡£
                            TCourse course = courseService.findOneCourse(courseName);
                            if (course == null) {
                                course = new TCourse();
                                course.setCoursename(courseName);
                                courseService.saveCourse(course);
                            }

                            courseplan.setCourse(course);

                            //todo ÔÝÊ±²»´æ´¢ÔºÏµ×Ö¶Î
//                            Department dept = departmentService.getDepartmentByName(deptName);

//                            courseplan.setDept(dept);

                            if (!isExistCourplan(courseplan)) {
                                courseplanDAO.save(courseplan);

                                String[] classId = StringUtil.split(classIds, ",");
                                if (classId != null && classId.length > 0) {
                                    for (int k = 0; k < classId.length; k++) {
                                        TCourseplanclassId id = new TCourseplanclassId(courseplan.getId(), classId[k].toUpperCase());
                                        TCourseplanclass courseplanclass = new TCourseplanclass(id);
                                        courseplanDAO.save(courseplanclass);
                                    }
                                }
                            }
                        }
                        savenum++;
                    } catch (Exception e) {
                        result = result + "µÚ" + rowCount + "Êý¾Ýµ¼ÈëÊ§°Ü¡£<br>";
                    }
                }
                result = "³É¹¦µ¼Èë" + savenum + "Ìõ¼ÇÂ¼¡£<br>";
            } else {
                result = "Ã»ÓÐÕÒµ½ÓÐÐ§µÄ¼ÇÂ¼";
            }
        } catch (Exception e) {

            return result;
        }
        return result;
    }

    //ÅÐ¶ÏÊý¾ÝÊÇ·ñ¿ÉÒÔµ¼Èë
    public String ifCourseCanImp(HSSFSheet sheet, String termId, String areaCode) {
        String result = "";

        int rowCount = sheet.getPhysicalNumberOfRows();
        if (rowCount > 0) {
            for (int i = 1; i < rowCount; i++) {
                try {
                    String termName = "";//Ñ§ÆÚ
                    String schoolArea = "";//Ð£Çø
                    String build = "";//Â¥Óî
                    String roomName = "";//½ÌÊÒ
                    String courseName = "";//¿Î³Ì
                    String stuempNo = "";//½ÌÊ¦Ñ§¹¤ºÅ
                    String custname = "";//½ÌÊ¦Ãû
                    String classIds = "";//°à¼¶Ãû
                    String week = "";//ÖÜ¼¸ÉÏ¿Î
                    String begWeekNum = "";//¿ªÊ¼ÖÜ´Î
                    String endWeekNum = "";//½áÊøÖÜ´Î
                    String beginClassNum = "";//¿ªÊ¼¿Î´Î
                    String endClassNum = "";//½áÊø¿Î´Î
                    String ischeck = "";//ÊÇ·ñ¿¼ÇÚ
                    String isopen = "";//ÊÇ·ñ¿ªÃÅ
                    String deptName = "";//ÔºÏµ
                    try {
                        HSSFRow row = sheet.getRow(i);
                        termName = getTrimedStr(row.getCell((short) 0).getStringCellValue()).trim();//Ñ§ÆÚ
                        deptName = getTrimedStr(row.getCell((short) 1).getStringCellValue()).trim();//Ð£Çø
                        schoolArea = getTrimedStr(row.getCell((short) 2).getStringCellValue()).trim();//Ð£Çø
                        build = getTrimedStr(row.getCell((short) 3).getStringCellValue()).trim();//Â¥Óî
                        roomName = getTrimedStr(row.getCell((short) 4).getStringCellValue()).trim();//½ÌÊÒ
                        courseName = getTrimedStr(row.getCell((short) 5).getStringCellValue()).trim();//¿Î³Ì
                        stuempNo = getTrimedStr(row.getCell((short) 6).getStringCellValue()).trim();//½ÌÊ¦Ñ§¹¤ºÅ
                        custname = getTrimedStr(row.getCell((short) 7).getStringCellValue()).trim();//½ÌÊ¦Ãû
                        classIds = getTrimedStr(row.getCell((short) 8).getStringCellValue()).trim();//°à¼¶±àÂë
                        week = getTrimedStr(row.getCell((short) 9).getStringCellValue()).trim();//ÖÜ¼¸ÉÏ¿Î
                        begWeekNum = getTrimedStr(row.getCell((short) 10).getStringCellValue()).trim();//¿ªÊ¼ÖÜ´Î
                        endWeekNum = getTrimedStr(row.getCell((short) 11).getStringCellValue()).trim();//½áÊøÖÜ´Î
                        beginClassNum = getTrimedStr(row.getCell((short) 12).getStringCellValue()).trim();//¿ªÊ¼¿Î´Î
                        endClassNum = getTrimedStr(row.getCell((short) 13).getStringCellValue()).trim();//½áÊø¿Î´Î
                        ischeck = getTrimedStr(row.getCell((short) 14).getStringCellValue()).trim();//½áÊø¿Î´Î
                        isopen = getTrimedStr(row.getCell((short) 15).getStringCellValue()).trim();//½áÊø¿Î´Î
                    } catch (NumberFormatException ne) {
                        result = result + "µÚ" + i + "ÐÐÊý×ÖÊý¾Ý·ÇÎÄ±¾ÀàÐÍ£¬ÐÞ¸ÄÎÄ±¾ÀàÐÍºóÔÙµ¼Èë¡£<br>";
                    } catch (NullPointerException n) {
                        result = result + "µÚ" + i + "ÐÐÓÐ¿ÕÊý¾Ý£¬ÇëÌî³äºóÔÙµ¼Èë¡£<br>";
                    }

                    TTerm term = termService.getTerm(termId);

                    if (!term.getTermName().equals(termName)) {
                        result = result + "µÚ" + i + "ÐÐÑ§ÆÚÃû" + termName + "ÓëÏµÍ³Ñ§ÆÚÃû²»Æ¥Åä£¬ÇëÐÞ¸ÄÕýÈ·ºóÔÙµ¼Èë¡£<br>";
                        break;
                    }

                    //todo ÔÝÊ±²»ÅÐ¶ÏÔºÏµÊÇ·ñÆ¥Åä
                    /*Department dept = departmentService.getDepartmentByName(deptName);
                    if (dept == null) {
                        result = result + "µÚ" + i + "ÐÐÔºÏµ£º" + deptName + "£¬ÔÚÏµÍ³Ã»ÓÐÆ¥ÅäµÄ¹ØÏµ£¬Çë¼ì²é´íÎó£¬ºóÔÙµ¼Èë¡£<br>";
                    }*/


                    TRoom r = roomService.findOneRoom(schoolArea, build, roomName);
                    if (r == null) {
                        result = result + "µÚ" + i + "ÐÐÐ£Çø:" + schoolArea + ",Â¥Óî:" + build + ",·¿¼ä:" + roomName + ":£¬ÔÚÏµÍ³Ã»ÓÐÆ¥ÅäµÄ¹ØÏµ£¬Çë¼ì²é´íÎó£¬»òÐÂÔö½ÌÊÒºóÔÙµ¼Èë¡£<br>";
                    }

                    TCustomer cust = customerService.findCustByStuemp(stuempNo);
                    if (cust == null || !cust.getCustname().equals(custname)) {
                        result = result + "µÚ" + i + "ÐÐ¹¤ºÅ" + stuempNo + "ºÍ½ÌÊ¦ÐÕÃû" + custname + "²»¶ÔÓ¦£¬ÇëÐÞ¸ÄºóÔÙµ¼Èë¡£<br>";
                    }

                    String[] classId = StringUtil.split(classIds, ",");
                    if (classId.length == 0) {
                        result = result + "µÚ" + i + "ÐÐ°à¼¶±àÂë²»ÄÜÎª¿Õ¡£<br>";
                    }

                    for (int j = 0; j < classId.length; j++) {
                        java.util.List classList = departmentService.findDept(classId[j].toUpperCase());
                        if (classList == null || classList.isEmpty()) {
                            result = result + "µÚ" + i + "ÐÐ°à¼¶±àÂë£¬ÓëÏµÍ³°à¼¶±àÂë²»Æ¥Åä,ÇëÐÞ¸ÄÕýÈ·£¬»òÔö¼Ó°à¼¶ºóÔÙµ¼Èë¡£<br>";
                        }
                    }
                    if (!ischeck.equals("ÊÇ") && !ischeck.equals("·ñ")) {
                        result = result + "µÚ" + i + "ÐÐÊÇ·ñ¿¼ÇÚ£¬Ó¦ÌîÐ´ÊÇ»ò·ñ¡£<br>";
                    }
                    if (!isopen.equals("ÊÇ") && !isopen.equals("·ñ")) {
                        result = result + "µÚ" + i + "ÐÐÊÇ·ñ¿ªÃÅ£¬Ó¦ÌîÐ´ÊÇ»ò·ñ¡£<br>";
                    }
                    try {
                        if (!(Integer.parseInt(week) >= 1 && Integer.parseInt(week) <= 7)) {
                            result = result + "µÚ" + i + "ÐÐÖÜ¼¸µÄÈ¡Öµ·¶Î§Ó¦1ÖÁ7¡£<br>";
                        }
                        if (!(Integer.parseInt(begWeekNum) >= 1 && Integer.parseInt(begWeekNum) <= Integer.parseInt(endWeekNum))) {
                            result = result + "µÚ" + i + "ÐÐ¿ªÊ¼ÖÜ´ÎµÄÈ¡Öµ·¶Î§Ó¦1ÖÁÑ§ÆÚ½áÊøÖÜ´Î¡£<br>";
                        }
                        if (!(Integer.parseInt(endWeekNum) >= (Integer.parseInt(begWeekNum)))) {//todo Ñ§ÆÚ½áÊøÖÜ
                            result = result + "µÚ" + i + "ÐÐ½áÊøÖÜ´ÎµÄÈ¡Öµ·¶Î§Ó¦´óÓÚµÈÓÚ¿ªÊ¼ÖÜ£¬Ð¡ÓÚµÈÓÚÑ§ÆÚÖÜ´Î¡£<br>";
                        }
                        if (Integer.parseInt(endWeekNum) > 52) {
                            result = result + "µÚ" + i + "ÐÐ½áÊøÖÜ´Î,³¬³öÑ§ÆÚ·¶Î§¡£<br>";
                        }
                        if (!(Integer.parseInt(endClassNum) >= 1 && Integer.parseInt(endClassNum) <= 13
                                && Integer.parseInt(endClassNum) >= Integer.parseInt(beginClassNum))) {
                            result = result + "µÚ" + i + "ÐÐ½áÊø¿Î´ÎµÄÈ¡Öµ·¶Î§Ó¦´óÓÚµÈÓÚ¿ªÊ¼¿Î´Î£¬Ð¡ÓÚµÈÓÚ13¡£<br>";
                        }

                        if (!(Integer.parseInt(beginClassNum) >= 1 && Integer.parseInt(beginClassNum) <= 13
                                && Integer.parseInt(beginClassNum) <= Integer.parseInt(endClassNum))) {
                            result = result + "µÚ" + i + "ÐÐ¿ªÊ¼¿Î´ÎµÄÈ¡Öµ·¶Î§Ó¦´óÓÚµÈÓÚ1£¬Ð¡ÓÚµÈÓÚ½áÊøÖÜ´Î¡£<br>";
                        }

                        if (Integer.parseInt(beginClassNum) <= 4 && Integer.parseInt(endClassNum) > 4) {
                            result = result + "µÚ" + i + "ÐÐ¿Î´ÎµÄÈ¡Öµ·¶Î§²»ÄÜ¿çÉÏÏÂÎç¡£<br>";
                        }
                        if (Integer.parseInt(beginClassNum) <= 8 && Integer.parseInt(endClassNum) > 8) {
                            result = result + "µÚ" + i + "ÐÐ¿Î´ÎµÄÈ¡Öµ·¶Î§²»ÄÜ¿çÏÂÎç£¬ÍíÉÏ¡£<br>";
                        }

                    } catch (NumberFormatException e) {
                        result = result + "µÚ" + i + "ÐÐÊý¾ÝÓÐ·Ç·¨µÄÕûÊýÀàÐÍ£¬Çë¼ì²éÐÞ¸Äºó£¬ÔÙµ¼Èë¡£<br>";
                    }
                } catch (Exception e) {
                    result = result + "µÚ" + i + "ÐÐÊý¾ÝÒì³££¬Çë¼ì²éÐÞ¸Äºó£¬ÔÙµ¼Èë¡£<br>";
                    return result;
                }
            }
        } else {
            result = "Ã»ÓÐÕÒµ½ÓÐÐ§µÄ¼ÇÂ¼";
        }
        if (!"".equals(result)) {
            result = result + "µ¼ÈëÊ§°Ü¡£";
        }
        return result;
    }

    private String getTrimedStr(String input) {
        if (input.startsWith("sz")) {
            return input.substring(2);
        } else {
            return input;
        }
    }


    public void setTimeService(TimeService timeService) {
        this.timeService = timeService;
    }


    public void setCourseService(CourseService courseService) {
        this.courseService = courseService;
    }


    public void setCourseplanDAO(CourseplanDAO courseplanDAO) {
        this.courseplanDAO = courseplanDAO;
    }


    public void setRoomService(RoomService roomService) {
        this.roomService = roomService;
    }


    public void setCustomerService(CustomerService customerService) {
        this.customerService = customerService;
    }


    public void setTermService(TermService termService) {
        this.termService = termService;
    }


    public void saveCourseplan(TCourseplan courseplan)
            throws Exception {
        courseplanDAO.save(courseplan);

    }

    private static String getCourseDate(String beginDate, int weekNum, int week, String format) {
        String ret = "";
        try {
            java.text.SimpleDateFormat sdf = new java.text.SimpleDateFormat(format);
            Calendar c = Calendar.getInstance(Locale.CHINESE);
            c.setFirstDayOfWeek(Calendar.MONDAY);
            //System.out.println(c.getFirstDayOfWeek());
            Date d = sdf.parse(beginDate);
            // System.out.println(Calendar.MONDAY);
            c.setTime(d);
            c.add(Calendar.WEEK_OF_YEAR, weekNum - 1);
            //System.out.println(sdf.format(c.getTime()));
            c.set(Calendar.DAY_OF_WEEK, week + 1);
            ret = sdf.format(c.getTime());
        }
        catch (Exception e) {

        }
        return ret;
    }


}
