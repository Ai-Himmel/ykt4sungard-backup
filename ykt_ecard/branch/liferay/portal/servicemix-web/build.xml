<?xml version="1.0"?>

<project name="servicemix-web" basedir="." default="war">
	<path id="web-lib.classpath">
		<fileset dir="../lib/portal" includes="jmx-ri.jar,xml-apis.jar" />
		<fileset dir="docroot/WEB-INF/lib" includes="*.jar" />
		<fileset dir="tmp/WEB-INF/lib" includes="*.jar" />
	</path>

	<import file="../build-common-web.xml" />

	<property name="original.war.file" value="apache-servicemix-web-3.1-incubating.war" />
	<property name="war.file" value="${ant.project.name}" />

	<target name="clean" depends="build-common-web.clean">
		<delete dir="tmp" />
	</target>

	<target name="compile" depends="merge">
		<antcall target="build-common-web.compile" />
	</target>

	<target name="merge">
		<if>
			<not>
				<uptodate srcfile="${original.war.file}" targetfile="tmp" />
			</not>
			<then>
				<delete dir="tmp" />
				<mkdir dir="tmp" />

				<unjar dest="tmp" src="${original.war.file}" />

				<copy todir="tmp" overwrite="true">
					<fileset dir="docroot" />
				</copy>
			</then>
		</if>

		<copy todir="tmp" overwrite="false">
			<fileset dir="docroot" />
		</copy>
	</target>

	<target name="war" depends="compile">
		<war
			basedir="tmp"
			destfile="${war.file}.war"
			excludes="WEB-INF/web.xml"
			webxml="docroot/WEB-INF/web.xml"
		/>
	</target>

	<target name="deploy" depends="merge">
		<antcall target="build-common-web.deploy" />
	</target>
</project>